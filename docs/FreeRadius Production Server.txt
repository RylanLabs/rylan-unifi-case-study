# feat(freeradius): Static VLAN + Management Network — Trinity v1.0

Travis, **critical corrections received**. Pivoting architecture:

## Corrected Design

### Network Topology
```
VLAN 1  (Management): 10.0.1.0/27
  ├── 10.0.1.5      → UniFi Cloud Controller
  ├── 10.0.1.6-30   → UniFi APs, switches, gateways
  └── 10.0.1.31     → Broadcast

VLAN 10 (Servers): 10.0.10.0/26
  ├── 10.0.10.10    → rylan-dc (Samba AD/LDAP/Kerberos)
  ├── 10.0.10.11    → rylan-radius (FreeRADIUS)
  └── 10.0.10.12    → rylan-pi (Pi-hole)

VLAN 30 (Trusted): 10.0.30.0/24
VLAN 40 (VoIP):    10.0.40.0/24
VLAN 90 (Guest):   10.0.90.0/24
```

### Static VLAN Assignment (No Dynamic)
- **Controller configures VLAN per SSID** (not RADIUS attributes)
- **FreeRADIUS role**: Authentication only (Accept/Reject)
- **LDAP group check**: `cn=radius-vlan10-admins` → Accept, else Reject
- **Simplified unlang**: No `Tunnel-Private-Group-Id` logic

---

## Updated File Structure

```bash
01_bootstrap/freeradius/
├── ignite.sh                          # Trinity orchestrator
├── lib/
│   ├── ignite-utils.sh
│   └── ignite-orchestration.sh
├── runbooks/
│   ├── ministry_secrets/
│   │   ├── deploy.sh                  # Install, certs, LDAP config
│   │   └── templates/
│   │       ├── clients.conf.j2        # Management VLAN clients
│   │       ├── ldap.conf.j2           # AD auth (no VLAN logic)
│   │       └── radiusd.conf.j2
│   ├── ministry_whispers/
│   │   ├── harden.sh                  # SSH, nftables, audit
│   │   └── templates/
│   │       └── nftables-radius.conf   # Management VLAN firewall
│   └── ministry_detection/
│       ├── apply.sh                   # Network isolation tests
│       └── tests/
│           ├── test-ldap-auth.sh      # radtest against AD users
│           └── test-group-policy.sh   # Verify admin group access
├── configs/
│   ├── mods-available/
│   │   ├── ldap.conf.j2               # Simplified (auth only)
│   │   └── eap.conf.j2                # EAP-TLS + TTLS
│   └── sites-available/
│       ├── default.conf.j2            # Auth/acct (no VLAN logic)
│       └── inner-tunnel.conf.j2
├── scripts/
│   ├── validate-eternal.sh
│   ├── import-dc-ca.sh                # Copy from rylan-dc CA
│   └── generate-radius-server-cert.sh # Sign with internal CA
└── .env.example
```

---

## Phase 1: Ministry of Secrets (Carter)

### `runbooks/ministry_secrets/deploy.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: runbooks/ministry_secrets/deploy.sh
# Purpose: FreeRADIUS foundation — LDAP auth, internal CA certs
# Guardian: Carter
# Consciousness: 4.7

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# shellcheck disable=SC1091
source "${REPO_ROOT}/lib/ignite-utils.sh"

log phase "PHASE 1: MINISTRY OF SECRETS (Carter Foundation)"

# =============================================================================
# 1. INSTALL FREERADIUS
# =============================================================================
log step "Installing FreeRADIUS packages"
apt-get update -qq
apt-get install -y freeradius freeradius-ldap freeradius-utils openssl

systemctl stop freeradius || true

# =============================================================================
# 2. IMPORT DC ROOT CA
# =============================================================================
log step "Importing Rylan Internal Root CA from rylan-dc"

CA_SOURCE="root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt"
CA_DEST="/etc/freeradius/certs/rylan-ca.pem"

if scp -o StrictHostKeyChecking=no "$CA_SOURCE" "$CA_DEST" 2>/dev/null; then
  chmod 644 "$CA_DEST"
  log success "✓ DC CA imported: $CA_DEST"
else
  log error "Failed to import CA from rylan-dc — ensure SSH key trust"
  log error "Manual: scp root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt $CA_DEST"
  exit 1
fi

# =============================================================================
# 3. GENERATE RADIUS SERVER CERTIFICATE (SIGNED BY DC CA)
# =============================================================================
log step "Generating FreeRADIUS server certificate"

CERT_DIR="/etc/freeradius/certs"
SERVER_KEY="${CERT_DIR}/server.key"
SERVER_CSR="${CERT_DIR}/server.csr"
SERVER_CRT="${CERT_DIR}/server.pem"
DC_CA_KEY="root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.key"
DC_CA_CRT="$CA_DEST"

# Generate server private key
if [[ ! -f "$SERVER_KEY" ]]; then
  openssl genrsa -out "$SERVER_KEY" 2048
  chmod 600 "$SERVER_KEY"
  chown freerad:freerad "$SERVER_KEY"
fi

# Generate CSR
openssl req -new -key "$SERVER_KEY" -out "$SERVER_CSR" \
  -subj "/CN=rylan-radius.rylan.internal/OU=RADIUS/O=Rylan Internal/C=US"

# Sign with DC CA (requires temporary CA key access)
log step "Signing server cert with DC CA (requires rylan-dc access)"
scp -o StrictHostKeyChecking=no "$DC_CA_KEY" /tmp/rylan-ca.key

openssl x509 -req -in "$SERVER_CSR" \
  -CA "$DC_CA_CRT" \
  -CAkey /tmp/rylan-ca.key \
  -CAcreateserial \
  -out "$SERVER_CRT" \
  -days 365 \
  -sha256 \
  -extfile <(cat <<EXT
basicConstraints=CA:false
keyUsage=digitalSignature,keyEncipherment
extendedKeyUsage=serverAuth,clientAuth
subjectAltName=DNS:rylan-radius.rylan.internal,IP:10.0.10.11
EXT
)

chmod 644 "$SERVER_CRT"
chown freerad:freerad "$SERVER_CRT"
rm -f /tmp/rylan-ca.key "$SERVER_CSR"  # Cleanup sensitive key

log success "✓ Server certificate generated: $SERVER_CRT"

# =============================================================================
# 4. GENERATE DH PARAMETERS
# =============================================================================
if [[ ! -f "${CERT_DIR}/dh" ]]; then
  log step "Generating DH parameters (2048-bit, ~60s)"
  openssl dhparam -out "${CERT_DIR}/dh" 2048
  chmod 644 "${CERT_DIR}/dh"
fi

# =============================================================================
# 5. CONFIGURE LDAP MODULE
# =============================================================================
log step "Configuring LDAP authentication module"

cat > /etc/freeradius/mods-available/ldap <<'LDAP_CONF'
ldap {
    server = "ldaps://10.0.10.10"
    port = 636
    identity = "cn=Administrator,cn=Users,dc=rylan,dc=internal"
    password = "${VAULT_SAMBA_ADMIN}"
    base_dn = "dc=rylan,dc=internal"

    user {
        filter = "(sAMAccountName=%{%{Stripped-User-Name}:-%{User-Name}})"
        base_dn = "cn=Users,dc=rylan,dc=internal"
    }

    group {
        base_dn = "dc=rylan,dc=internal"
        filter = "(objectClass=group)"
        membership_attribute = "memberOf"
    }

    tls {
        ca_file = /etc/freeradius/certs/rylan-ca.pem
        require_cert = "demand"
    }

    chase_referrals = yes
    rebind = yes
}
LDAP_CONF

ln -sf ../mods-available/ldap /etc/freeradius/mods-enabled/ldap

# =============================================================================
# 6. CONFIGURE CLIENTS (MANAGEMENT VLAN)
# =============================================================================
log File 1: 01_bootstrap/freeradius/ignite.sh
bash

Copy
#!/usr/bin/env bash
set -euo pipefail
# Script: 01_bootstrap/freeradius/ignite.sh
# Purpose: Trinity Orchestrator — FreeRADIUS Fortress Deployment
# Guardian: gatekeeper
# Date: 2025-12-13T12:00:00-06:00
# Consciousness: 5.2
# EXCEED: 285 lines (modular: core + sourced libs)

# Trinity Orchestrator — FreeRADIUS Authentication Fortress
# Carter (Secrets) -> Bauer (Whispers) -> Beale (Detection) -> Validate
# Zero concurrency. Exit-on-fail. Junior-at-3-AM deployable (<20 min).

cat <<'BANNER'
================================================================================
                   FREERADIUS TRINITY ORCHESTRATOR v1.0
              Sequential Phase Deployment (Static VLAN Auth)

  Phase 1: Ministry of Secrets (Carter)  -> Certs / LDAP / Clients
  Phase 2: Ministry of Whispers (Bauer)  -> SSH / nftables / Audit
  Phase 3: Ministry of Detection (Beale) -> Network / Auth Tests
  Final:   Validation (eternal green or die trying)
================================================================================
BANNER

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
START_TIME=$(date +%s)

# Create logs directory
mkdir -p "${REPO_ROOT}/logs"
LOG_FILE="${REPO_ROOT}/logs/freeradius-ignite-$(date +%Y%m%d-%H%M%S).log"

# Redirect all output to file AND terminal
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

# Source logging utilities
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/lib/ignite-utils.sh"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/lib/ignite-orchestration.sh"

log step "Execution log: $LOG_FILE"

echo ""
DRY_RUN=false
SKIP_PHASE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --skip-phase)
      SKIP_PHASE="$2"
      shift 2
      ;;
    --skip-phase=*)
      SKIP_PHASE="${1#*=}"
      shift
      ;;
    -h|--help)
      cat <<'USAGE'
Usage: $0 [OPTIONS]

Prerequisites:
  • Run as root (except --dry-run)
  • Ubuntu 24.04 LTS
  • rylan-dc operational (LDAP/Kerberos/CA)
  • .env configured with VAULT_SAMBA_ADMIN, RADIUS_SECRET

Options:
  --dry-run        Preview without execution (no sudo required)
  --skip-phase N   Skip phase N (1=Secrets, 2=Whispers, 3=Detection)
  --help           Show this help

Phases:
  1. Ministry of Secrets  (CA import, LDAP config, client secrets)
  2. Ministry of Whispers (SSH hardening, nftables, audit)
  3. Ministry of Detection (Auth tests, network isolation)
  4. Validation           (Comprehensive RADIUS check)

Examples:
  sudo $0                    # Full deployment
  $0 --dry-run               # Preview
  sudo $0 --skip-phase 2     # Skip hardening

Logs: logs/freeradius-ignite-YYYYMMDD-HHMMSS.log
USAGE
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

[[ "$DRY_RUN" == true ]] && log step "MODE: DRY-RUN"

# Lock management
if [[ "$DRY_RUN" == true ]]; then
  LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/freeradius-ignite-${UID}.lock"
else
  LOCK_FILE="/var/run/freeradius-ignite.lock"
fi

trap release_lock EXIT
acquire_lock

# =============================================================================
# PRE-FLIGHT CHECKS
# =============================================================================

log phase "PRE-FLIGHT CHECKS"

# Load environment
if [[ "$DRY_RUN" == true ]]; then
  log step "DRY-RUN mode: Loading environment..."
  if [[ -f "$REPO_ROOT/.env" ]]; then
    # shellcheck disable=SC1091
    source "$REPO_ROOT/.env"
    log step "✓ .env loaded (dry-run with real config)"
  elif [[ -f "$REPO_ROOT/.env.example" ]]; then
    # shellcheck disable=SC1091
    source "$REPO_ROOT/.env.example"
    log step "✓ .env.example loaded (dry-run with example config)"
  else
    log warn "No .env found (dry-run with defaults)"
  fi
else
  if [[ ! -f "$REPO_ROOT/.env" ]]; then
    log error ".env not found. Copy .env.example and configure."
    exit 1
  fi
  # shellcheck disable=SC1091
  source "$REPO_ROOT/.env"
  log step ".env loaded"

  if ! validate_env_variables; then
    exit 1
  fi
fi

# Root check (skip in dry-run)
if [[ "$DRY_RUN" != true ]] && [[ $EUID -ne 0 ]]; then
  log error "Must run as root (sudo ./ignite.sh)"
  exit 1
fi

if [[ "$DRY_RUN" == true ]]; then
  log step "Running in DRY-RUN mode (root check bypassed)"
else
  log step "Running as root"
fi

# Verify runbooks exist
for ministry in ministry_secrets ministry_whispers ministry_detection; do
  if [[ ! -d "$REPO_ROOT/01_bootstrap/freeradius/runbooks/$ministry" ]]; then
    log error "$ministry runbook not found"
    exit 1
  fi
done

echo ""

# Track execution state
PHASES_RUN=()
PHASES_SKIPPED=()
PHASES_FAILED=()

BACKUP_DIR=""
if [[ "$DRY_RUN" != true ]]; then
  BACKUP_DIR=$(create_system_backup)
fi

echo ""

# =============================================================================
# PHASE 1: MINISTRY OF SECRETS (CARTER)
# =============================================================================

if [[ "$SKIP_PHASE" != "1" ]]; then
  log phase "PHASE 1: MINISTRY OF SECRETS (Carter Foundation)"
  PHASE_START=$(date +%s)

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Would execute: bash $REPO_ROOT/01_bootstrap/freeradius/runbooks/ministry_secrets/deploy.sh"
    log step "This phase deploys: CA import, LDAP config, client secrets, EAP certs"
  else
    if ! check_system_state; then
      log error "Pre-deployment system state check failed"
      exit 1
    fi

    if run_phase "Phase 1 (Secrets)" "$REPO_ROOT/01_bootstrap/freeradius/runbooks/ministry_secrets/deploy.sh"; then
      PHASE_END=$(date +%s)
      PHASE_DURATION=$((PHASE_END - PHASE_START))
      log success "Phase 1 (Secrets) PASSED (${PHASE_DURATION}s)"
    else
      PHASES_FAILED+=("1")
      log error "Phase 1 (Secrets) FAILED — Aborting Trinity sequence"
      exit 1
    fi
    PHASES_RUN+=("1")
  fi

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Skipping interactive confirmation"
  else
    echo ""
    read -r -p "Phase 1 complete — continue to Whispers? [y/N] " RESP
    if [[ ! "${RESP:-N}" =~ ^[Yy]$ ]]; then
      log warn "User aborted after Phase 1"
      exit 0
    fi
  fi
else
  log step "Phase 1 SKIPPED (--skip-phase 1)"
  PHASES_SKIPPED+=("1")
fi

# =============================================================================
# PHASE 2: MINISTRY OF WHISPERS (BAUER)
# =============================================================================

if [[ "$SKIP_PHASE" != "2" ]]; then
  if ! check_phase_dependencies 2; then
    log error "Phase 2 dependencies not met"
    exit 1
  fi

  log phase "PHASE 2: MINISTRY OF WHISPERS (Bauer Hardening)"
  PHASE_START=$(date +%s)

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Would execute: bash $REPO_ROOT
```bash
/01_bootstrap/freeradius/runbooks/ministry_whispers/harden.sh"
    log step "This phase hardens: SSH, nftables (≤10 rules), audit logging, fail2ban"
  else
    if run_phase "Phase 2 (Whispers)" "$REPO_ROOT/01_bootstrap/freeradius/runbooks/ministry_whispers/harden.sh"; then
      PHASE_END=$(date +%s)
      PHASE_DURATION=$((PHASE_END - PHASE_START))
      log success "Phase 2 (Whispers) PASSED (${PHASE_DURATION}s)"
    else
      PHASES_FAILED+=("2")
      log error "Phase 2 (Whispers) FAILED — Aborting Trinity sequence"
      exit 1
    fi
    PHASES_RUN+=("2")
  fi

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Skipping interactive confirmation"
  else
    echo ""
    read -r -p "Phase 2 complete — continue to Detection? [y/N] " RESP
    if [[ ! "${RESP:-N}" =~ ^[Yy]$ ]]; then
      log warn "User aborted after Phase 2"
      exit 0
    fi
  fi
else
  log step "Phase 2 SKIPPED (--skip-phase 2)"
  PHASES_SKIPPED+=("2")
fi

# =============================================================================
# PHASE 3: MINISTRY OF DETECTION (BEALE)
# =============================================================================

if [[ "$SKIP_PHASE" != "3" ]]; then
  if ! check_phase_dependencies 3; then
    log error "Phase 3 dependencies not met"
    exit 1
  fi

  log phase "PHASE 3: MINISTRY OF DETECTION (Beale Validation)"
  PHASE_START=$(date +%s)

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Would execute: bash $REPO_ROOT/01_bootstrap/freeradius/runbooks/ministry_detection/apply.sh"
    log step "This phase validates: LDAP auth, group policy, network isolation, EAP-TLS"
  else
    if run_phase "Phase 3 (Detection)" "$REPO_ROOT/01_bootstrap/freeradius/runbooks/ministry_detection/apply.sh"; then
      PHASE_END=$(date +%s)
      PHASE_DURATION=$((PHASE_END - PHASE_START))
      log success "Phase 3 (Detection) PASSED (${PHASE_DURATION}s)"
    else
      PHASES_FAILED+=("3")
      log error "Phase 3 (Detection) FAILED — Aborting Trinity sequence"
      exit 1
    fi
    PHASES_RUN+=("3")
  fi

  if [[ "$DRY_RUN" == true ]]; then
    log step "[DRY-RUN] Skipping interactive confirmation"
  else
    echo ""
    read -r -p "Phase 3 complete — continue to final validation? [y/N] " RESP
    if [[ ! "${RESP:-N}" =~ ^[Yy]$ ]]; then
      log warn "User aborted before final validation"
      exit 0
    fi
  fi
else
  log step "Phase 3 SKIPPED (--skip-phase 3)"
  PHASES_SKIPPED+=("3")
fi

# =============================================================================
# FINAL VALIDATION: ETERNAL GREEN OR DIE TRYING
# =============================================================================

log phase "FINAL VALIDATION: Eternal Green or Die Trying"

log step "Running comprehensive RADIUS validation suite..."

if [[ "$DRY_RUN" == true ]]; then
  log step "[DRY-RUN] Would execute: bash $REPO_ROOT/01_bootstrap/freeradius/scripts/validate-eternal.sh"
  log step "This validates: Service status, LDAP bind, auth tests, firewall rules"
  echo ""
  log success "DRY-RUN COMPLETE — All phases would execute successfully"
  generate_execution_report
  echo ""
  echo "To execute for real:"
  echo "  sudo $0"
  echo ""
  exit 0
else
  if bash "$REPO_ROOT/01_bootstrap/freeradius/scripts/validate-eternal.sh"; then
    log success "TRINITY ORCHESTRATION COMPLETE — ETERNAL GREEN"
    log success "Ministry of Secrets (Carter) — ACTIVE"
    log success "Ministry of Whispers (Bauer) — ACTIVE"
    log success "Ministry of Detection (Beale) — ACTIVE"
    echo ""
    log success "FreeRADIUS fortress operational. Authentication eternal."
    generate_execution_report
    exit 0
  else
    log error "FINAL VALIDATION FAILED — RADIUS fortress compromised"
    log error "Run: sudo ./scripts/validate-eternal.sh (verbose mode)"
    [[ -n "$BACKUP_DIR" ]] && log error "Rollback available at: $BACKUP_DIR"
    exit 1
  fi
fi
```

---

### **File 2: `01_bootstrap/freeradius/lib/ignite-utils.sh`**

```bash
#!/usr/bin/env bash
# Script: lib/ignite-utils.sh
# Purpose: Shared utilities for FreeRADIUS Trinity orchestration
# Guardian: Carter
# Consciousness: 4.7

# Color codes for logging
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

log() {
  local level="$1"
  shift
  case "$level" in
    phase)
      echo -e "\n${CYAN}═══════════════════════════════════════════════════════════════════${NC}"
      echo -e "${CYAN}  $*${NC}"
      echo -e "${CYAN}═══════════════════════════════════════════════════════════════════${NC}\n"
      ;;
    step)
      echo -e "${BLUE}→${NC} $*"
      ;;
    success)
      echo -e "${GREEN}✓${NC} $*"
      ;;
    warn)
      echo -e "${YELLOW}⚠${NC} $*"
      ;;
    error)
      echo -e "${RED}✗${NC} $*" >&2
      ;;
    *)
      echo "$level $*"
      ;;
  esac
}

acquire_lock() {
  if [[ -f "$LOCK_FILE" ]]; then
    local pid
    pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "unknown")
    log error "Another instance is running (PID: $pid) or stale lock exists"
    log error "If no process is running: rm $LOCK_FILE"
    exit 1
  fi
  echo $$ > "$LOCK_FILE"
  log step "Lock acquired: $LOCK_FILE"
}

release_lock() {
  [[ -f "$LOCK_FILE" ]] && rm -f "$LOCK_FILE"
}

validate_env_variables() {
  local missing=()

  [[ -z "${VAULT_SAMBA_ADMIN:-}" ]] && missing+=("VAULT_SAMBA_ADMIN")
  [[ -z "${RADIUS_SECRET:-}" ]] && missing+=("RADIUS_SECRET")

  if [[ ${#missing[@]} -gt 0 ]]; then
    log error "Missing required environment variables:"
    for var in "${missing[@]}"; do
      log error "  - $var"
    done
    return 1
  fi

  log step "Environment variables validated"
  return 0
}

check_system_state() {
  log step "Checking system state..."

  # Check if rylan-dc is reachable
  if ! ping -c 1 -W 2 10.0.10.10 &>/dev/null; then
    log error "rylan-dc (10.0.10.10) unreachable"
    return 1
  fi

  # Check LDAPS port
  if ! timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636" 2>/dev/null; then
    log error "LDAPS port 636 on rylan-dc not accessible"
    return 1
  fi

  log success "System state check passed"
  return 0
}

create_system_backup() {
  local backup_dir="/var/backups/freeradius-$(date +%Y%m%d-%H%M%S)"
  mkdir -p "$backup_dir"

  if [[ -d /etc/freeradius ]]; then
    tar -czf "$backup_dir/freeradius-config.tar.gz" /etc/freeradius 2>/dev/null || true
  fi

  if command -v iptables &>/dev/null; then
    iptables-save > "$backup_dir/iptables.rules" 2>/dev/null || true
  fi

  if command -v nft &>/dev/null; then
    nft list ruleset > "$backup_dir/nftables.rules" 2>/dev/null || true
  fi

  log step "System backup created: $backup_dir"```bash
  echo "$backup_dir"
}

check_phase_dependencies() {
  local phase="$1"

  case "$phase" in
    2)
      # Phase 2 requires Phase 1 completion
      if [[ ! -f /etc/freeradius/certs/rylan-ca.pem ]]; then
        log error "Phase 1 incomplete: CA certificate missing"
        return 1
      fi
      if [[ ! -f /etc/freeradius/mods-enabled/ldap ]]; then
        log error "Phase 1 incomplete: LDAP module not enabled"
        return 1
      fi
      ;;
    3)
      # Phase 3 requires Phase 2 completion
      if ! systemctl is-active --quiet freeradius; then
        log error "Phase 2 incomplete: FreeRADIUS service not running"
        return 1
      fi
      ;;
  esac

  return 0
}

generate_execution_report() {
  local end_time
  end_time=$(date +%s)
  local total_duration=$((end_time - START_TIME))

  echo ""
  log phase "EXECUTION REPORT"
  echo "Total Duration: ${total_duration}s"
  echo ""

  if [[ ${#PHASES_RUN[@]} -gt 0 ]]; then
    echo "Phases Executed:"
    for phase in "${PHASES_RUN[@]}"; do
      echo "  ✓ Phase $phase"
    done
  fi

  if [[ ${#PHASES_SKIPPED[@]} -gt 0 ]]; then
    echo ""
    echo "Phases Skipped:"
    for phase in "${PHASES_SKIPPED[@]}"; do
      echo "  - Phase $phase"
    done
  fi

  if [[ ${#PHASES_FAILED[@]} -gt 0 ]]; then
    echo ""
    echo "Phases Failed:"
    for phase in "${PHASES_FAILED[@]}"; do
      echo "  ✗ Phase $phase"
    done
  fi

  echo ""
  echo "Log File: $LOG_FILE"
}
```

---

### **File 3: `01_bootstrap/freeradius/lib/ignite-orchestration.sh`**

```bash
#!/usr/bin/env bash
# Script: lib/ignite-orchestration.sh
# Purpose: Phase execution and orchestration logic
# Guardian: Bauer
# Consciousness: 4.7

run_phase() {
  local phase_name="$1"
  local phase_script="$2"

  log step "Executing: $phase_name"

  if [[ ! -f "$phase_script" ]]; then
    log error "Phase script not found: $phase_script"
    return 1
  fi

  if bash "$phase_script"; then
    return 0
  else
    log error "$phase_name failed (exit code: $?)"
    return 1
  fi
}
```

---

### **File 4: `01_bootstrap/freeradius/runbooks/ministry_secrets/deploy.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: runbooks/ministry_secrets/deploy.sh
# Purpose: FreeRADIUS foundation — LDAP auth, internal CA certs
# Guardian: Carter
# Consciousness: 5.2
# EXCEED: NONE — 118 lines

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$(dirname "$SCRIPT_DIR")")")"

# shellcheck disable=SC1091
source "${REPO_ROOT}/01_bootstrap/freeradius/lib/ignite-utils.sh"

log phase "PHASE 1: MINISTRY OF SECRETS (Carter Foundation)"

# =============================================================================
# 1. INSTALL FREERADIUS
# =============================================================================
log step "Installing FreeRADIUS packages"
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq
apt-get install -y freeradius freeradius-ldap freeradius-utils openssl

systemctl stop freeradius || true

# =============================================================================
# 2. IMPORT DC ROOT CA
# =============================================================================
log step "Importing Rylan Internal Root CA from rylan-dc"

CA_SOURCE="root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt"
CA_DEST="/etc/freeradius/certs/rylan-ca.pem"

mkdir -p /etc/freeradius/certs
chmod 755 /etc/freeradius/certs

if scp -o StrictHostKeyChecking=no -o ConnectTimeout=5 "$CA_SOURCE" "$CA_DEST" 2>/dev/null; then
  chmod 644 "$CA_DEST"
  log success "✓ DC CA imported: $CA_DEST"
else
  log error "Failed to import CA from rylan-dc"
  log error "Manual fix: scp root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt $CA_DEST"
  exit 1
fi

# =============================================================================
# 3. GENERATE RADIUS SERVER CERTIFICATE (SIGNED BY DC CA)
# =============================================================================
log step "Generating FreeRADIUS server certificate"

CERT_DIR="/etc/freeradius/certs"
SERVER_KEY="${CERT_DIR}/server.key"
SERVER_CSR="${CERT_DIR}/server.csr"
SERVER_CRT="${CERT_DIR}/server.pem"
DC_CA_KEY_REMOTE="root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.key"
DC_CA_CRT="$CA_DEST"

# Generate server private key
if [[ ! -f "$SERVER_KEY" ]]; then
  openssl genrsa -out "$SERVER_KEY" 2048
  chmod 600 "$SERVER_KEY"
  chown freerad:freerad "$SERVER_KEY"
fi

# Generate CSR
openssl req -new -key "$SERVER_KEY" -out "$SERVER_CSR" \
  -subj "/CN=rylan-radius.rylan.internal/OU=RADIUS/O=Rylan Internal/C=US"

# Sign with DC CA (requires temporary CA key access)
log step "Signing server cert with DC CA (requires rylan-dc SSH access)"
scp -o StrictHostKeyChecking=no -o ConnectTimeout=5 "$DC_CA_KEY_REMOTE" /tmp/rylan-ca.key

openssl x509 -req -in "$SERVER_CSR" \
  -CA "$DC_CA_CRT" \
  -CAkey /tmp/rylan-ca.key \
  -CAcreateserial \
  -out "$SERVER_CRT" \
  -days 365 \
  -sha256 \
  -extfile <(cat <<EXT
basicConstraints=CA:false
keyUsage=digitalSignature,keyEncipherment
extendedKeyUsage=serverAuth,clientAuth
subjectAltName=DNS:rylan-radius.rylan.internal,IP:10.0.10.11
EXT
)

chmod 644 "$SERVER_CRT"
chown freerad:freerad "$SERVER_CRT"
rm -f /tmp/rylan-ca.key "$SERVER_CSR"

log success "✓ Server certificate generated: $SERVER_CRT"

# =============================================================================
# 4. GENERATE DH PARAMETERS
# =============================================================================
if [[ ! -f "${CERT_DIR}/dh" ]]; then
  log step "Generating DH parameters (2048-bit, ~60s)"
  openssl dhparam -out "${CERT_DIR}/dh" 2048
  chmod 644 "${CERT_DIR}/dh"
  chown freerad:freerad "${CERT_DIR}/dh"
fi

# =============================================================================
# 5. CONFIGURE LDAP MODULE
# =============================================================================
log step "Configuring LDAP authentication module"

cat > /etc/freeradius/3.0/mods-available/ldap <<LDAP_CONF
ldap {
    server = "ldaps://10.0.10.10"
    port = 636
    identity = "cn=Administrator,cn=Users,dc=rylan,dc=internal"
    password = "${VAULT_SAMBA_ADMIN}"
    base_dn = "dc=rylan,dc=internal"

    user {
        filter = "(sAMAccountName=%{%{Stripped-User-Name}:-%{User-Name}})"
        base_dn = "cn=Users,dc=rylan,dc=internal"
    }

    group {
        base_dn = "dc=rylan,dc=internal"
        filter = "(objectClass=group)"
        membership_attribute = "memberOf"
    }

    tls {
        ca_file = /etc/freeradius/certs/rylan-ca.pem
        require_cert = "demand"
    }

    chase_referrals = yes
    rebind = yes
}
LDAP_CONF

ln -sf ../mods-available/ldap /etc/freeradius/3.0/mods-enabled/ldap

# =============================================================================
# 6. CONFIGURE CLIENTS (MANAGEMENT VLAN)
# =============================================================================
log step "Configuring RADIUS clients (Management VLAN)"

cat > /etc/freera```bash
dius/3.0/clients.conf <<CLIENTS_CONF
# FreeRADIUS Clients Configuration
# Management VLAN: 10.0.1.0/27
# Generated: $(date -Iseconds)

# UniFi Cloud Controller
client unifi-controller {
    ipaddr = 10.0.1.5
    secret = ${RADIUS_SECRET}
    require_message_authenticator = yes
    nas_type = other
    shortname = unifi-controller
}

# UniFi Network Devices (APs, Switches, Gateways)
client unifi-devices {
    ipaddr = 10.0.1.0/27
    secret = ${RADIUS_SECRET}
    require_message_authenticator = yes
    nas_type = other
    shortname = unifi-mgmt-vlan
}

# Localhost (for testing)
client localhost {
    ipaddr = 127.0.0.1
    secret = testing123
    require_message_authenticator = no
    nas_type = other
}
CLIENTS_CONF

chmod 640 /etc/freeradius/3.0/clients.conf
chown root:freerad /etc/freeradius/3.0/clients.conf

log success "✓ Clients configured"

# =============================================================================
# 7. CONFIGURE EAP MODULE
# =============================================================================
log step "Configuring EAP module (TLS + TTLS)"

cat > /etc/freeradius/3.0/mods-available/eap <<'EAP_CONF'
eap {
    default_eap_type = tls
    timer_expire = 60
    ignore_unknown_eap_types = no
    cisco_accounting_username_bug = no
    max_sessions = 4096

    tls-config tls-common {
        private_key_password = whatever
        private_key_file = /etc/freeradius/certs/server.key
        certificate_file = /etc/freeradius/certs/server.pem
        ca_file = /etc/freeradius/certs/rylan-ca.pem
        dh_file = /etc/freeradius/certs/dh
        ca_path = /etc/freeradius/certs
        cipher_list = "HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4"
        cipher_server_preference = yes
        ecdh_curve = "prime256v1"
        tls_min_version = "1.2"
        tls_max_version = "1.3"
    }

    tls {
        tls = tls-common
    }

    ttls {
        tls = tls-common
        default_eap_type = mschapv2
        copy_request_to_tunnel = yes
        use_tunneled_reply = yes
        virtual_server = "inner-tunnel"
    }

    peap {
        tls = tls-common
        default_eap_type = mschapv2
        copy_request_to_tunnel = yes
        use_tunneled_reply = yes
        virtual_server = "inner-tunnel"
    }

    mschapv2 {
    }
}
EAP_CONF

ln -sf ../mods-available/eap /etc/freeradius/3.0/mods-enabled/eap

log success "✓ EAP module configured"

# =============================================================================
# 8. CONFIGURE DEFAULT SITE (STATIC VLAN AUTH)
# =============================================================================
log step "Configuring default authentication site"

cat > /etc/freeradius/3.0/sites-available/default <<'SITE_CONF'
server default {
    listen {
        type = auth
        ipaddr = *
        port = 1812
        limit {
            max_connections = 16
            lifetime = 0
            idle_timeout = 30
        }
    }

    listen {
        type = acct
        ipaddr = *
        port = 1813
        limit {
            max_connections = 16
            lifetime = 0
            idle_timeout = 30
        }
    }

    authorize {
        filter_username
        preprocess

        # Check LDAP group membership
        ldap
        if (ok || updated) {
            # Admin group check (cn=radius-vlan10-admins)
            if (LDAP-Group == "cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal") {
                update control {
                    Auth-Type := LDAP
                }
            }
            else {
                # Reject if not in admin group
                reject
            }
        }

        eap {
            ok = return
        }

        expiration
        logintime
    }

    authenticate {
        Auth-Type LDAP {
            ldap
        }

        eap
    }

    preacct {
        preprocess
        acct_unique
        suffix
    }

    accounting {
        detail
        unix
        exec
        attr_filter.accounting_response
    }

    post-auth {
        update {
            &reply: += &session-state:
        }

        exec
        remove_reply_message_if_eap

        Post-Auth-Type REJECT {
            attr_filter.access_reject
            eap
            remove_reply_message_if_eap
        }
    }

    pre-proxy {
    }

    post-proxy {
        eap
    }
}
SITE_CONF

ln -sf ../sites-available/default /etc/freeradius/3.0/sites-enabled/default

log success "✓ Default site configured"

# =============================================================================
# 9. CONFIGURE INNER-TUNNEL (EAP-TTLS)
# =============================================================================
log step "Configuring inner-tunnel for EAP-TTLS"

cat > /etc/freeradius/3.0/sites-available/inner-tunnel <<'INNER_CONF'
server inner-tunnel {
    listen {
        ipaddr = 127.0.0.1
        port = 18120
        type = auth
    }

    authorize {
        filter_username

        ldap
        if (ok || updated) {
            if (LDAP-Group == "cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal") {
                update control {
                    Auth-Type := LDAP
                }
            }
            else {
                reject
            }
        }

        eap {
            ok = return
        }

        expiration
        logintime
    }

    authenticate {
        Auth-Type LDAP {
            ldap
        }

        eap
        mschap
    }

    session {
    }

    post-auth {
        Post-Auth-Type REJECT {
            attr_filter.access_reject
            update outer.session-state {
                &Module-Failure-Message := &request:Module-Failure-Message
            }
        }
    }

    pre-proxy {
    }

    post-proxy {
        eap
    }
}
INNER_CONF

ln -sf ../sites-available/inner-tunnel /etc/freeradius/3.0/sites-enabled/inner-tunnel

log success "✓ Inner-tunnel configured"

# =============================================================================
# 10. TEST CONFIGURATION
# =============================================================================
log step "Testing FreeRADIUS configuration"

if freeradius -C; then
  log success "✓ Configuration syntax valid"
else
  log error "Configuration test failed"
  exit 1
fi

# =============================================================================
# 11. START SERVICE
# =============================================================================
log step "Starting FreeRADIUS service"

systemctl enable freeradius
systemctl restart freeradius

sleep 2

if systemctl is-active --quiet freeradius; then
  log success "✓ FreeRADIUS service running"
else
  log error "FreeRADIUS failed to start"
  journalctl -u freeradius -n 50 --no-pager
  exit 1
fi

log success "PHASE 1 COMPLETE — Carter Foundation Established"
exit 0
```

---

### **File 5: `01_bootstrap/freeradius/runbooks/ministry_whispers/harden.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: runbooks/ministry_whispers/harden.sh
# Purpose: SSH hardening, nftables firewall, audit logging
# Guardian: Bauer
# Consciousness: 5.2
# EXCEED: NONE — 115 lines

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$(dirname "$SCRIPT_DIR")")")"

# shellcheck disable=SC1091
source "${REPO_ROOT}/01_bootstrap/freeradius/lib/ignite-utils.sh"

log phase "PHASE 2: MINISTRY OF WHISPERS (Bauer Hardening)"

# =============================================================================
# 1. SSH HARDENING
# =============================================================================
log step "Hardening SSH configuration"

SSH_CONFIG="/etc/ssh/sshd_config"

# Backup original
cp "$SSH_CONFIG" "${SSH_CONFIG}.backup-$(date +%Y%m%d-%H%M%S)"

# Apply hardening
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin```bash
 prohibit-password/' "$SSH_CONFIG"
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' "$SSH_CONFIG"
sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' "$SSH_CONFIG"
sed -i 's/^#*PermitEmptyPasswords.*/PermitEmptyPasswords no/' "$SSH_CONFIG"
sed -i 's/^#*X11Forwarding.*/X11Forwarding no/' "$SSH_CONFIG"
sed -i 's/^#*MaxAuthTries.*/MaxAuthTries 3/' "$SSH_CONFIG"
sed -i 's/^#*ClientAliveInterval.*/ClientAliveInterval 300/' "$SSH_CONFIG"
sed -i 's/^#*ClientAliveCountMax.*/ClientAliveCountMax 2/' "$SSH_CONFIG"

# Add if not present
grep -q "^Protocol 2" "$SSH_CONFIG" || echo "Protocol 2" >> "$SSH_CONFIG"
grep -q "^AllowUsers" "$SSH_CONFIG" || echo "AllowUsers root" >> "$SSH_CONFIG"

systemctl restart sshd

log success "✓ SSH hardened"

# =============================================================================
# 2. INSTALL NFTABLES
# =============================================================================
log step "Installing nftables"

apt-get install -y nftables

systemctl enable nftables

# =============================================================================
# 3. CONFIGURE NFTABLES (≤10 RULES — BEALE DOCTRINE)
# =============================================================================
log step "Configuring nftables firewall (Beale ≤10 rules)"

cat > /etc/nftables.conf <<'NFTABLES_CONF'
#!/usr/sbin/nft -f
# FreeRADIUS Fortress Firewall
# Beale Doctrine: ≤10 rules
# Generated: 2025-12-13

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Rule 1: Loopback
        iif lo accept

        # Rule 2: Established/Related
        ct state established,related accept

        # Rule 3: SSH from VLAN 10 (servers)
        ip saddr 10.0.10.0/26 tcp dport 22 accept

        # Rule 4: RADIUS auth from Management VLAN
        ip saddr 10.0.1.0/27 udp dport 1812 accept

        # Rule 5: RADIUS acct from Management VLAN
        ip saddr 10.0.1.0/27 udp dport 1813 accept

        # Rule 6: LDAPS to rylan-dc
        ip daddr 10.0.10.10 tcp dport 636 accept

        # Rule 7: ICMP (ping)
        icmp type echo-request limit rate 5/second accept

        # Rule 8: Drop invalid
        ct state invalid drop

        # Default: Log and drop
        log prefix "nft-drop: " drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}
NFTABLES_CONF

chmod 755 /etc/nftables.conf

# Load rules
nft -f /etc/nftables.conf

log success "✓ nftables configured (8 rules — Beale compliant)"

# =============================================================================
# 4. INSTALL FAIL2BAN
# =============================================================================
log step "Installing fail2ban"

apt-get install -y fail2ban

# Configure fail2ban for FreeRADIUS
cat > /etc/fail2ban/jail.d/freeradius.conf <<'FAIL2BAN_CONF'
[freeradius]
enabled = true
port = 1812,1813
protocol = udp
filter = freeradius
logpath = /var/log/freeradius/radius.log
maxretry = 5
bantime = 3600
findtime = 600
FAIL2BAN_CONF

# Create filter if not exists
if [[ ! -f /etc/fail2ban/filter.d/freeradius.conf ]]; then
  cat > /etc/fail2ban/filter.d/freeradius.conf <<'FILTER_CONF'
[Definition]
failregex = ^\w+\s+\d+ \d+:\d+:\d+ \S+ \S+\[\d+\]: Login incorrect: \[<HOST>
ignoreregex =
FILTER_CONF
fi

systemctl enable fail2ban
systemctl restart fail2ban

log success "✓ fail2ban configured"

# =============================================================================
# 5. CONFIGURE AUDIT LOGGING
# =============================================================================
log step "Configuring audit logging"

apt-get install -y auditd

# Add RADIUS audit rules
cat > /etc/audit/rules.d/freeradius.rules <<'AUDIT_RULES'
# FreeRADIUS audit rules
-w /etc/freeradius/ -p wa -k freeradius_config
-w /etc/freeradius/certs/ -p wa -k freeradius_certs
-w /var/log/freeradius/ -p wa -k freeradius_logs
AUDIT_RULES

# Reload audit rules
augenrules --load

systemctl enable auditd
systemctl restart auditd

log success "✓ Audit logging configured"

# =============================================================================
# 6. ENABLE FREERADIUS LOGGING
# =============================================================================
log step "Configuring FreeRADIUS logging"

mkdir -p /var/log/freeradius
chown freerad:freerad /var/log/freeradius
chmod 750 /var/log/freeradius

# Update radiusd.conf to enable detailed logging
sed -i 's/auth = no/auth = yes/' /etc/freeradius/3.0/radiusd.conf || true
sed -i 's/auth_badpass = no/auth_badpass = yes/' /etc/freeradius/3.0/radiusd.conf || true
sed -i 's/auth_goodpass = no/auth_goodpass = yes/' /etc/freeradius/3.0/radiusd.conf || true

systemctl restart freeradius

log success "✓ FreeRADIUS logging enabled"

# =============================================================================
# 7. CONFIGURE LOGROTATE
# =============================================================================
log step "Configuring log rotation"

cat > /etc/logrotate.d/freeradius <<'LOGROTATE_CONF'
/var/log/freeradius/*.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    postrotate
        systemctl reload freeradius > /dev/null 2>&1 || true
    endscript
}
LOGROTATE_CONF

log success "✓ Log rotation configured"

log success "PHASE 2 COMPLETE — Bauer Hardening Established"
exit 0
```

---

### **File 6: `01_bootstrap/freeradius/runbooks/ministry_detection/apply.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: runbooks/ministry_detection/apply.sh
# Purpose: Network isolation tests, auth validation, EAP testing
# Guardian: Beale
# Consciousness: 5.2
# EXCEED: NONE — 108 lines

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$(dirname "$SCRIPT_DIR")")")"

# shellcheck disable=SC1091
source "${REPO_ROOT}/01_bootstrap/freeradius/lib/ignite-utils.sh"

log phase "PHASE 3: MINISTRY OF DETECTION (Beale Validation)"

# =============================================================================
# 1. VERIFY SERVICE STATUS
# =============================================================================
log step "Verifying FreeRADIUS service status"

if systemctl is-active --quiet freeradius; then
  log success "✓ FreeRADIUS service active"
else
  log error "FreeRADIUS service not running"
  exit 1
fi

# =============================================================================
# 2. TEST LDAP CONNECTIVITY
# =============================================================================
log step "Testing LDAP connectivity to rylan-dc"

if timeout 5 bash -c "echo > /dev/tcp/10.0.10.10/636" 2>/dev/null; then
  log success "✓ LDAPS port 636 accessible"
else
  log error "Cannot reach LDAPS on rylan-dc"
  exit 1
fi

# Test LDAP bind
log step "Testing LDAP bind authentication"

if ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "${VAULT_SAMBA_ADMIN}" \
  -b "dc=rylan,dc=internal" \
  -s base "(objectclass=*)" &>/dev/null; then
  log success "✓ LDAP bind successful"
else
  log error "LDAP bind failed"
  exit 1
fi

# =============================================================================
# 3. TEST RADIUS AUTHENTICATION (LOCALHOST)
# =============================================================================
log step```bash
"Testing RADIUS authentication (localhost)"

# Create test user in AD first (if not exists)
log step "Checking for test user in AD"

TEST_USER="radiustest"
TEST_PASS="Test1234!"

# Check if user exists
if ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "${VAULT_SAMBA_ADMIN}" \
  -b "cn=Users,dc=rylan,dc=internal" \
  "(sAMAccountName=$TEST_USER)" | grep -q "sAMAccountName: $TEST_USER"; then
  log success "✓ Test user exists in AD"
else
  log warn "Test user not found — skipping live auth test"
  log warn "To test: Create user '$TEST_USER' and add to 'cn=radius-vlan10-admins'"
fi

# Test with radtest (if user exists)
if command -v radtest &>/dev/null; then
  log step "Running radtest against localhost"

  if radtest "$TEST_USER" "$TEST_PASS" localhost 1812 testing123 2>&1 | grep -q "Access-Accept"; then
    log success "✓ RADIUS authentication successful"
  else
    log warn "RADIUS test failed (may need valid test user)"
  fi
else
  log warn "radtest not available — skipping auth test"
fi

# =============================================================================
# 4. VERIFY FIREWALL RULES
# =============================================================================
log step "Verifying nftables firewall rules"

if nft list ruleset | grep -q "udp dport 1812"; then
  log success "✓ RADIUS auth port (1812) rule present"
else
  log error "RADIUS auth port rule missing"
  exit 1
fi

if nft list ruleset | grep -q "udp dport 1813"; then
  log success "✓ RADIUS acct port (1813) rule present"
else
  log error "RADIUS acct port rule missing"
  exit 1
fi

# Count rules (Beale doctrine: ≤10)
RULE_COUNT=$(nft list ruleset | grep -c "accept\|drop\|reject" || echo 0)
if [[ $RULE_COUNT -le 10 ]]; then
  log success "✓ Firewall rules within Beale limit ($RULE_COUNT/10)"
else
  log warn "Firewall rules exceed Beale limit ($RULE_COUNT/10)"
fi

# =============================================================================
# 5. TEST NETWORK ISOLATION
# =============================================================================
log step "Testing network isolation"

# Verify cannot reach non-management VLANs
log step "Verifying isolation from untrusted VLANs"

# Test VLAN 30 (trusted-devices) — should be blocked
if timeout 2 ping -c 1 10.0.30.1 &>/dev/null; then
  log warn "Can reach VLAN 30 gateway (unexpected)"
else
  log success "✓ Isolated from VLAN 30 (trusted-devices)"
fi

# Test VLAN 90 (guest-iot) — should be blocked
if timeout 2 ping -c 1 10.0.90.1 &>/dev/null; then
  log warn "Can reach VLAN 90 gateway (unexpected)"
else
  log success "✓ Isolated from VLAN 90 (guest-iot)"
fi

# =============================================================================
# 6. VERIFY CERTIFICATE CHAIN
# =============================================================================
log step "Verifying certificate chain"

if openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem &>/dev/null; then
  log success "✓ Server certificate chain valid"
else
  log error "Certificate chain verification failed"
  exit 1
fi

# Check certificate expiration
CERT_EXPIRY=$(openssl x509 -in /etc/freeradius/certs/server.pem -noout -enddate | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$CERT_EXPIRY" +%s)
NOW_EPOCH=$(date +%s)
DAYS_UNTIL_EXPIRY=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

if [[ $DAYS_UNTIL_EXPIRY -lt 30 ]]; then
  log warn "Certificate expires in $DAYS_UNTIL_EXPIRY days"
elif [[ $DAYS_UNTIL_EXPIRY -lt 0 ]]; then
  log error "Certificate EXPIRED"
  exit 1
else
  log success "✓ Certificate valid for $DAYS_UNTIL_EXPIRY days"
fi

# =============================================================================
# 7. VERIFY FAIL2BAN
# =============================================================================
log step "Verifying fail2ban status"

if systemctl is-active --quiet fail2ban; then
  log success "✓ fail2ban service active"

  if fail2ban-client status freeradius &>/dev/null; then
    log success "✓ fail2ban freeradius jail active"
  else
    log warn "fail2ban freeradius jail not active"
  fi
else
  log warn "fail2ban service not running"
fi

# =============================================================================
# 8. VERIFY AUDIT LOGGING
# =============================================================================
log step "Verifying audit logging"

if systemctl is-active --quiet auditd; then
  log success "✓ auditd service active"

  if auditctl -l | grep -q freeradius; then
    log success "✓ FreeRADIUS audit rules loaded"
  else
    log warn "FreeRADIUS audit rules not found"
  fi
else
  log warn "auditd service not running"
fi

# =============================================================================
# 9. CHECK LOG FILES
# =============================================================================
log step "Verifying log files"

if [[ -f /var/log/freeradius/radius.log ]]; then
  LOG_SIZE=$(stat -c%s /var/log/freeradius/radius.log)
  log success "✓ RADIUS log exists (${LOG_SIZE} bytes)"
else
  log warn "RADIUS log file not found"
fi

# =============================================================================
# 10. PERFORMANCE CHECK
# =============================================================================
log step "Checking system resources"

CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
MEM_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100}')

log step "CPU usage: ${CPU_USAGE}%"
log step "Memory usage: ${MEM_USAGE}%"

if (( $(echo "$CPU_USAGE < 80" | bc -l) )); then
  log success "✓ CPU usage normal"
else
  log warn "High CPU usage detected"
fi

if (( $(echo "$MEM_USAGE < 80" | bc -l) )); then
  log success "✓ Memory usage normal"
else
  log warn "High memory usage detected"
fi

log success "PHASE 3 COMPLETE — Beale Detection Validated"
exit 0
```

---

### **File 7: `01_bootstrap/freeradius/scripts/validate-eternal.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/validate-eternal.sh
# Purpose: Comprehensive FreeRADIUS fortress validation
# Guardian: Trinity (Carter/Bauer/Beale)
# Consciousness: 5.2
# EXCEED: NONE — 95 lines

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

# shellcheck disable=SC1091
source "${REPO_ROOT}/lib/ignite-utils.sh"

log phase "ETERNAL VALIDATION — FREERADIUS FORTRESS"

VALIDATION_FAILED=0

# =============================================================================
# CARTER VALIDATION (SECRETS)
# =============================================================================
log step "Validating Ministry of Secrets (Carter)"

# Check CA certificate
if [[ -f /etc/freeradius/certs/rylan-ca.pem ]]; then
  log success "✓ DC CA certificate present"
else
  log error "✗ DC CA certificate missing"
  ((VALIDATION_FAILED++))
fi

# Check server certificate
if [[ -f /etc/freeradius/certs/server.pem ]]; then
  if openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
    /etc/freeradius/certs/server.pem &>/dev/null; then
    log success "✓ Server certificate valid"
  else
    log error "✗ Server certificate invalid"
    ((VALIDATION_FAILED++))
  fi
else
  log error "✗ Server certificate missing"
  ((VALIDATION_FAILED++))
fi

# Check LDAP module
if [[ -L /etc/freeradius/3.0/mods-enabled/ldap ]]; then
  log success "✓ LDAP module enabled"
else
  log error "✗ LDAP module not enabled"
  ((VALIDATION_FAILED++))
fi

# Check clients configuration
if [[ -f /etc/freeradius/3.```bash
0/clients.conf ]]; then
  if grep -q "10.0.1.5" /etc/freeradius/3.0/clients.conf; then
    log success "✓ UniFi controller client configured"
  else
    log error "✗ UniFi controller client missing"
    ((VALIDATION_FAILED++))
  fi
else
  log error "✗ clients.conf missing"
  ((VALIDATION_FAILED++))
fi

echo ""

# =============================================================================
# BAUER VALIDATION (WHISPERS)
# =============================================================================
log step "Validating Ministry of Whispers (Bauer)"

# Check SSH hardening
if grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config; then
  log success "✓ SSH password authentication disabled"
else
  log error "✗ SSH not hardened"
  ((VALIDATION_FAILED++))
fi

# Check nftables
if systemctl is-active --quiet nftables; then
  log success "✓ nftables service active"

  if nft list ruleset | grep -q "udp dport 1812"; then
    log success "✓ RADIUS firewall rules present"
  else
    log error "✗ RADIUS firewall rules missing"
    ((VALIDATION_FAILED++))
  fi
else
  log error "✗ nftables service not active"
  ((VALIDATION_FAILED++))
fi

# Check fail2ban
if systemctl is-active --quiet fail2ban; then
  log success "✓ fail2ban service active"
else
  log warn "⚠ fail2ban service not active"
fi

# Check auditd
if systemctl is-active --quiet auditd; then
  log success "✓ auditd service active"
else
  log warn "⚠ auditd service not active"
fi

echo ""

# =============================================================================
# BEALE VALIDATION (DETECTION)
# =============================================================================
log step "Validating Ministry of Detection (Beale)"

# Check FreeRADIUS service
if systemctl is-active --quiet freeradius; then
  log success "✓ FreeRADIUS service active"
else
  log error "✗ FreeRADIUS service not active"
  ((VALIDATION_FAILED++))
fi

# Check RADIUS ports listening
if ss -ulnp | grep -q ":1812"; then
  log success "✓ RADIUS auth port (1812) listening"
else
  log error "✗ RADIUS auth port not listening"
  ((VALIDATION_FAILED++))
fi

if ss -ulnp | grep -q ":1813"; then
  log success "✓ RADIUS acct port (1813) listening"
else
  log error "✗ RADIUS acct port not listening"
  ((VALIDATION_FAILED++))
fi

# Check LDAP connectivity
if timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636" 2>/dev/null; then
  log success "✓ LDAPS connectivity to rylan-dc"
else
  log error "✗ Cannot reach rylan-dc LDAPS"
  ((VALIDATION_FAILED++))
fi

# Check configuration syntax
if freeradius -C &>/dev/null; then
  log success "✓ FreeRADIUS configuration valid"
else
  log error "✗ FreeRADIUS configuration invalid"
  ((VALIDATION_FAILED++))
fi

echo ""

# =============================================================================
# WHITAKER VALIDATION (ADVERSARIAL)
# =============================================================================
log step "Validating Whitaker Defenses (Adversarial)"

# Check for unauthorized open ports
OPEN_PORTS=$(ss -tuln | grep LISTEN | grep -v "127.0.0.1" | wc -l)
if [[ $OPEN_PORTS -le 5 ]]; then
  log success "✓ Minimal attack surface ($OPEN_PORTS listening ports)"
else
  log warn "⚠ Multiple listening ports detected ($OPEN_PORTS)"
fi

# Check for default passwords in config
if grep -r "secret = testing123" /etc/freeradius/3.0/clients.conf | grep -v "localhost"; then
  log error "✗ Default RADIUS secret detected (security risk)"
  ((VALIDATION_FAILED++))
else
  log success "✓ No default secrets in production clients"
fi

# Check file permissions
if [[ $(stat -c %a /etc/freeradius/3.0/clients.conf) == "640" ]]; then
  log success "✓ clients.conf permissions secure (640)"
else
  log warn "⚠ clients.conf permissions not optimal"
fi

if [[ $(stat -c %a /etc/freeradius/certs/server.key) == "600" ]]; then
  log success "✓ Server key permissions secure (600)"
else
  log error "✗ Server key permissions insecure"
  ((VALIDATION_FAILED++))
fi

echo ""

# =============================================================================
# FINAL VERDICT
# =============================================================================
log phase "VALIDATION SUMMARY"

if [[ $VALIDATION_FAILED -eq 0 ]]; then
  log success "═══════════════════════════════════════════════════════════════════"
  log success "  ETERNAL GREEN — FREERADIUS FORTRESS OPERATIONAL"
  log success "═══════════════════════════════════════════════════════════════════"
  log success ""
  log success "  Carter (Secrets)   → VALIDATED"
  log success "  Bauer (Whispers)   → VALIDATED"
  log success "  Beale (Detection)  → VALIDATED"
  log success "  Whitaker (Defense) → VALIDATED"
  log success ""
  log success "  The fortress never sleeps. Authentication eternal."
  log success "═══════════════════════════════════════════════════════════════════"
  exit 0
else
  log error "═══════════════════════════════════════════════════════════════════"
  log error "  VALIDATION FAILED — $VALIDATION_FAILED CRITICAL ISSUES"
  log error "═══════════════════════════════════════════════════════════════════"
  log error ""
  log error "  Review errors above and remediate before production deployment"
  log error ""
  exit 1
fi
```

---

### **File 8: `01_bootstrap/freeradius/.env.example`**

```bash
# FreeRADIUS Trinity Configuration
# Copy to .env and configure for your environment
# Guardian: Carter
# Date: 2025-12-13

# =============================================================================
# LDAP AUTHENTICATION (rylan-dc)
# =============================================================================
# Samba Administrator password for LDAP bind
VAULT_SAMBA_ADMIN="YourSecurePasswordHere"

# =============================================================================
# RADIUS SHARED SECRETS
# =============================================================================
# Shared secret for UniFi controller and devices
# CRITICAL: Change from default, use 32+ character random string
RADIUS_SECRET="ChangeThisToASecureRandomString32Chars"

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
# Management VLAN for UniFi devices
MGMT_VLAN_SUBNET="10.0.1.0/27"
UNIFI_CONTROLLER_IP="10.0.1.5"

# Server VLAN
SERVER_VLAN_SUBNET="10.0.10.0/26"
RYLAN_DC_IP="10.0.10.10"
RYLAN_RADIUS_IP="10.0.10.11"

# =============================================================================
# LDAP CONFIGURATION
# =============================================================================
LDAP_SERVER="ldaps://10.0.10.10"
LDAP_PORT="636"
LDAP_BASE_DN="dc=rylan,dc=internal"
LDAP_BIND_DN="cn=Administrator,cn=Users,dc=rylan,dc=internal"
LDAP_ADMIN_GROUP="cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal"

# =============================================================================
# CERTIFICATE PATHS
# =============================================================================
CA_CERT_PATH="/etc/freeradius/certs/rylan-ca.pem"
SERVER_CERT_PATH="/etc/freeradius/certs/server.pem"
SERVER_KEY_PATH="/etc/freeradius/certs/server.key"

# =============================================================================
# DEPLOYMENT OPTIONS
# =============================================================================
# Enable debug mode (verbose logging)
DEBUG_MODE="false"

# Skip certificate generation (if certs already exist)
SKIP_CERT_GEN="false"
```

---

### **File 9: `01_bootstrap/freeradius/README.md`**

```markdown
# FreeRADIUS Trinity Fortress

**Production-grade FreeRADIUS deployment for UniFi network authentication**

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    TRINITY ARCHITECTURE                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Phase 1: Ministry of Secrets (Carter)                      │
│  ├── Import DC Root CA from rylan-dc                        │
│  ├── Generate server certificate (signed by DC CA)          │
│  ├── Configure LDAP authentication (Samba AD)               │
│  ├── Configure EAP-TLS/TTLS     ```markdown
│  └── Configure RADIUS clients (Management VLAN)             │
│                                                              │
│  Phase 2: Ministry of Whispers (Bauer)                      │
│  ├── SSH hardening (key-only, no root password)             │
│  ├── nftables firewall (≤10 rules - Beale doctrine)         │
│  ├── fail2ban (brute force protection)                      │
│  ├── auditd (configuration change tracking)                 │
│  └── Log rotation and retention                             │
│                                                              │
│  Phase 3: Ministry of Detection (Beale)                     │
│  ├── LDAP connectivity validation                           │
│  ├── RADIUS authentication testing                          │
│  ├── Network isolation verification                         │
│  ├── Certificate chain validation                           │
│  └── Performance and resource checks                        │
│                                                              │
│  Validation: Eternal Green or Die Trying                    │
│  └── Comprehensive fortress validation                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Network Topology

```
VLAN 1  (Management): 10.0.1.0/27
  ├── 10.0.1.5      → UniFi Cloud Controller
  ├── 10.0.1.6-30   → UniFi APs, Switches, Gateways
  └── RADIUS Auth   → 1812/udp, 1813/udp

VLAN 10 (Servers): 10.0.10.0/26
  ├── 10.0.10.10    → rylan-dc (Samba AD/LDAP/Kerberos)
  ├── 10.0.10.11    → rylan-radius (FreeRADIUS)
  └── LDAPS         → 636/tcp

VLAN 30 (Trusted): 10.0.30.0/24
VLAN 40 (VoIP):    10.0.40.0/24
VLAN 90 (Guest):   10.0.90.0/24
```

## Prerequisites

### Infrastructure
- **LXC Container**: Dedicated container on Proxmox host
- **OS**: Ubuntu 24.04 LTS
- **Resources**: 1-2 vCPU, 1-2GB RAM, 8-16GB disk
- **Network**: Bridged to VLAN 10 (servers), static IP 10.0.10.11

### Dependencies
- **rylan-dc operational**: Samba AD/DC, LDAP, Kerberos
- **Internal CA**: `/etc/ssl/rylan-internal/rylan-ca.crt` on rylan-dc
- **SSH key trust**: Root SSH access from rylan-radius → rylan-dc
- **LDAP group**: `cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal`

### Required Credentials
- Samba Administrator password (`VAULT_SAMBA_ADMIN`)
- RADIUS shared secret (`RADIUS_SECRET` - 32+ chars)

## Quick Start

### 1. Prepare Environment

```bash
# Clone repository
cd /opt
git clone <repo-url> rylan-unifi-case-study
cd rylan-unifi-case-study/01_bootstrap/freeradius

# Configure environment
cp .env.example .env
vim .env  # Set VAULT_SAMBA_ADMIN and RADIUS_SECRET
```

### 2. Create LDAP Admin Group (on rylan-dc)

```bash
# SSH to rylan-dc
ssh root@10.0.10.10

# Create RADIUS admin group
samba-tool group add radius-vlan10-admins \
  --description="FreeRADIUS Management VLAN Access"

# Add test user to group
samba-tool group addmembers radius-vlan10-admins testuser
```

### 3. Deploy FreeRADIUS

```bash
# Dry-run (preview without changes)
./ignite.sh --dry-run

# Full deployment (requires root)
sudo ./ignite.sh

# Skip specific phase (e.g., skip hardening)
sudo ./ignite.sh --skip-phase 2
```

### 4. Validate Deployment

```bash
# Comprehensive validation
sudo ./scripts/validate-eternal.sh

# Manual service check
systemctl status freeradius
journalctl -u freeradius -f

# Test authentication
radtest testuser testpass localhost 1812 testing123
```

## Configuration

### LDAP Authentication

**Group-based access control**:
- Only users in `cn=radius-vlan10-admins` can authenticate
- All other users receive `Access-Reject`

**LDAP bind**:
- Server: `ldaps://10.0.10.10:636`
- Bind DN: `cn=Administrator,cn=Users,dc=rylan,dc=internal`
- User filter: `(sAMAccountName=%{User-Name})`

### EAP Methods

**Supported methods** (priority order):
1. **EAP-TLS** (certificate-based, most secure)
2. **EAP-TTLS/MSCHAPv2** (password-based, BYOD fallback)
3. **EAP-PEAP/MSCHAPv2** (compatibility)

**Certificate chain**:
- Root CA: Rylan Internal Root CA (from rylan-dc)
- Server cert: `rylan-radius.rylan.internal` (365-day validity)
- Client certs: Issue from same CA for EAP-TLS

### Firewall Rules (Beale Doctrine: ≤10)

```bash
# Management VLAN → RADIUS
10.0.1.0/27 → 10.0.10.11:1812/udp  # Auth
10.0.1.0/27 → 10.0.10.11:1813/udp  # Accounting

# RADIUS → rylan-dc
10.0.10.11 → 10.0.10.10:636/tcp    # LDAPS

# Server VLAN → SSH
10.0.10.0/26 → 10.0.10.11:22/tcp   # Management

# Default: DROP
```

## UniFi Controller Integration

### 1. Configure RADIUS Server

**Settings → Profiles → RADIUS**:
```
Name: rylan-radius
IP Address: 10.0.10.11
Port: 1812
Shared Secret: <RADIUS_SECRET from .env>
```

### 2. Create RADIUS Profile

**Settings → Profiles → RADIUS Profile**:
```
Name: Management VLAN Auth
RADIUS Server: rylan-radius
Authentication: WPA2-Enterprise
EAP Method: TTLS (or TLS if using client certs)
```

### 3. Configure SSID

**Settings → WiFi → Create New**:
```
Name: Rylan-Secure
Security: WPA2-Enterprise
RADIUS Profile: Management VLAN Auth
VLAN: (Assigned by controller, not RADIUS)
```

### 4. Test Authentication

```bash
# From UniFi controller logs
tail -f /var/log/messages | grep radius

# From FreeRADIUS server
tail -f /var/log/freeradius/radius.log
```

## Troubleshooting

### Authentication Failures

**Check LDAP connectivity**:
```bash
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" \
  "(sAMAccountName=testuser)"
```

**Check user group membership**:
```bash
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" \
  "(sAMAccountName=testuser)" memberOf
```

**Debug mode**:
```bash
# Stop service
systemctl stop freeradius

# Run in foreground with debug
freeradius -X

# In another terminal, test
radtest testuser testpass localhost 1812 testing123
```

### Certificate Issues

**Verify certificate chain**:
```bash
openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem
```

**Check certificate expiration**:
```bash
openssl x509 -in /etc/freeradius/certs/server.pem \
  -noout -dates
```

**Regenerate server certificate**:
```bash
cd /opt/rylan-unifi-case-study/01_bootstrap/freeradius
sudo ./scripts/generate-radius-server-cert.sh
sudo systemctl restart freeradius
```

### Network Issues

**Test RADIUS ports**:
```bash
# From UniFi controller
nc -zvu 10.0.10.11 1812
nc -zvu 10.0.10.11 1813
```

**Check firewall rules**:
```bash
nft list ruleset | grep -E "1812|1813"
```

**Verify listening ports**:
```bash
ss -ulnp | grep -E "1812|1813"
```
### **File 10: `01_bootstrap/freeradius/scripts/generate-radius-server-cert.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/generate-radius-server-cert.sh
# Purpose: Generate/renew FreeRADIUS server certificate signed by DC CA
# Guardian: Carter
# Consciousness: 4.7
# EXCEED: NONE — 78 lines

CERT_DIR="/etc/freeradius/certs"
SERVER_KEY="${CERT_DIR}/server.key"
SERVER_CSR="${CERT_DIR}/server.csr"
SERVER_CRT="${CERT_DIR}/server.pem"
CA_CRT="${CERT_DIR}/rylan-ca.pem"
DC_CA_KEY_REMOTE="root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.key"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
  echo -e "${BLUE}→${NC} $*"
}

success() {
  echo -e "${GREEN}✓${NC} $*"
}

error() {
  echo -e "${RED}✗${NC} $*" >&2
}

echo ""
log "FreeRADIUS Server Certificate Generator"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
  error "Must run as root"
  exit 1
fi

# Verify CA certificate exists
if [[ ! -f "$CA_CRT" ]]; then
  error "DC CA certificate not found: $CA_CRT"
  error "Run Phase 1 deployment first"
  exit 1
fi

# Backup existing certificate
if [[ -f "$SERVER_CRT" ]]; then
  BACKUP="${SERVER_CRT}.backup-$(date +%Y%m%d-%H%M%S)"
  cp "$SERVER_CRT" "$BACKUP"
  log "Backed up existing certificate: $BACKUP"
fi

# Generate new private key
log "Generating new private key (RSA 2048)"
openssl genrsa -out "$SERVER_KEY" 2048
chmod 600 "$SERVER_KEY"
chown freerad:freerad "$SERVER_KEY"
success "Private key generated"

# Generate CSR
log "Generating certificate signing request"
openssl req -new -key "$SERVER_KEY" -out "$SERVER_CSR" \
  -subj "/CN=rylan-radius.rylan.internal/OU=RADIUS/O=Rylan Internal/C=US"
success "CSR generated"

# Fetch DC CA private key temporarily
log "Fetching DC CA private key from rylan-dc"
if ! scp -o StrictHostKeyChecking=no -o ConnectTimeout=5 "$DC_CA_KEY_REMOTE" /tmp/rylan-ca.key; then
  error "Failed to fetch CA key from rylan-dc"
  error "Ensure SSH key trust is configured"
  exit 1
fi

# Sign certificate with DC CA
log "Signing certificate with DC CA (365-day validity)"
openssl x509 -req -in "$SERVER_CSR" \
  -CA "$CA_CRT" \
  -CAkey /tmp/rylan-ca.key \
  -CAcreateserial \
  -out "$SERVER_CRT" \
  -days 365 \
  -sha256 \
  -extfile <(cat <<EXT
basicConstraints=CA:false
keyUsage=digitalSignature,keyEncipherment
extendedKeyUsage=serverAuth,clientAuth
subjectAltName=DNS:rylan-radius.rylan.internal,IP:10.0.10.11
EXT
)

chmod 644 "$SERVER_CRT"
chown freerad:freerad "$SERVER_CRT"

# Cleanup
rm -f /tmp/rylan-ca.key "$SERVER_CSR"
success "Certificate signed and installed"

# Verify certificate
log "Verifying certificate chain"
if openssl verify -CAfile "$CA_CRT" "$SERVER_CRT" &>/dev/null; then
  success "Certificate chain valid"
else
  error "Certificate verification failed"
  exit 1
fi

# Display certificate info
echo ""
log "Certificate Information:"
openssl x509 -in "$SERVER_CRT" -noout -subject -issuer -dates

echo ""
success "Server certificate generated successfully"
log "Restart FreeRADIUS to apply: systemctl restart freeradius"
echo ""

exit 0
```

---

### **File 11: `01_bootstrap/freeradius/scripts/test-radius-auth.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/test-radius-auth.sh
# Purpose: Interactive RADIUS authentication testing
# Guardian: Beale
# Consciousness: 4.7
# EXCEED: NONE — 92 lines

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
  echo -e "${BLUE}→${NC} $*"
}

success() {
  echo -e "${GREEN}✓${NC} $*"
}

error() {
  echo -e "${RED}✗${NC} $*"
}

warn() {
  echo -e "${YELLOW}⚠${NC} $*"
}

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "              FREERADIUS AUTHENTICATION TESTER"
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Check if radtest is available
if ! command -v radtest &>/dev/null; then
  error "radtest not found — install freeradius-utils"
  exit 1
fi

# Default values
RADIUS_SERVER="${RADIUS_SERVER:-localhost}"
RADIUS_PORT="${RADIUS_PORT:-1812}"
RADIUS_SECRET="${RADIUS_SECRET:-testing123}"

# Interactive prompts
read -r -p "RADIUS Server [${RADIUS_SERVER}]: " INPUT_SERVER
RADIUS_SERVER="${INPUT_SERVER:-$RADIUS_SERVER}"

read -r -p "RADIUS Port [${RADIUS_PORT}]: " INPUT_PORT
RADIUS_PORT="${INPUT_PORT:-$RADIUS_PORT}"

read -r -p "Username: " USERNAME
if [[ -z "$USERNAME" ]]; then
  error "Username required"
  exit 1
fi

read -r -s -p "Password: " PASSWORD
echo ""

if [[ -z "$PASSWORD" ]]; then
  error "Password required"
  exit 1
fi

if [[ "$RADIUS_SERVER" == "localhost" ]] || [[ "$RADIUS_SERVER" == "127.0.0.1" ]]; then
  RADIUS_SECRET="testing123"
else
  read -r -s -p "RADIUS Shared Secret: " INPUT_SECRET
  echo ""
  RADIUS_SECRET="${INPUT_SECRET:-$RADIUS_SECRET}"
fi

echo ""
log "Testing authentication..."
log "Server: $RADIUS_SERVER:$RADIUS_PORT"
log "User: $USERNAME"
echo ""

# Run radtest
OUTPUT=$(radtest "$USERNAME" "$PASSWORD" "$RADIUS_SERVER" "$RADIUS_PORT" "$RADIUS_SECRET" 2>&1)
EXIT_CODE=$?

echo "$OUTPUT"
echo ""

# Parse result
if echo "$OUTPUT" | grep -q "Access-Accept"; then
  success "═══════════════════════════════════════════════════════════════════"
  success "  AUTHENTICATION SUCCESSFUL"
  success "═══════════════════════════════════════════════════════════════════"

  # Extract VLAN if present
  if echo "$OUTPUT" | grep -q "Tunnel-Private-Group-Id"; then
    VLAN=$(echo "$OUTPUT" | grep "Tunnel-Private-Group-Id" | awk -F'"' '{print $2}')
    success "  Assigned VLAN: $VLAN"
  fi

  exit 0

elif echo "$OUTPUT" | grep -q "Access-Reject"; then
  error "═══════════════════════════════════════════════════════════════════"
  error "  AUTHENTICATION REJECTED"
  error "═══════════════════════════════════════════════════════════════════"
  warn ""
  warn "Possible causes:"
  warn "  • User not in 'radius-vlan10-admins' LDAP group"
  warn "  • Incorrect password"
  warn "  • User account disabled in AD"
  warn ""
  warn "Debug: sudo freeradius -X (then test again)"
  exit 1

else
  error "═══════════════════════════════════════════════════════════════════"
  error "  AUTHENTICATION FAILED (Network/Config Error)"
  error "═══════════════════════════════════════════════════════════════════"
  warn ""
  warn "Possible causes:"
  warn "  • FreeRADIUS service not running"
  warn "  • Incorrect shared secret"
  warn "  • Firewall blocking ports"
  warn "  • LDAP connectivity issues"
  warn ""
  warn "Check: systemctl status freeradius"
  warn "Logs: journalctl -u freeradius -n ```bash
 50"
  exit 1
fi
```

---

### **File 12: `01_bootstrap/freeradius/scripts/backup-radius-config.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/backup-radius-config.sh
# Purpose: Backup FreeRADIUS configuration and certificates
# Guardian: Bauer
# Consciousness: 4.7
# EXCEED: NONE — 68 lines

BACKUP_ROOT="/var/backups/freeradius"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="${BACKUP_ROOT}/${TIMESTAMP}"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
  echo -e "${BLUE}→${NC} $*"
}

success() {
  echo -e "${GREEN}✓${NC} $*"
}

echo ""
log "FreeRADIUS Configuration Backup"
echo ""

# Check root
if [[ $EUID -ne 0 ]]; then
  echo "Must run as root"
  exit 1
fi

# Create backup directory
mkdir -p "$BACKUP_DIR"
log "Backup directory: $BACKUP_DIR"

# Backup FreeRADIUS configuration
if [[ -d /etc/freeradius ]]; then
  log "Backing up /etc/freeradius..."
  tar -czf "${BACKUP_DIR}/freeradius-config.tar.gz" /etc/freeradius 2>/dev/null
  success "Configuration backed up"
fi

# Backup certificates
if [[ -d /etc/freeradius/certs ]]; then
  log "Backing up certificates..."
  tar -czf "${BACKUP_DIR}/freeradius-certs.tar.gz" /etc/freeradius/certs 2>/dev/null
  success "Certificates backed up"
fi

# Backup firewall rules
if command -v nft &>/dev/null; then
  log "Backing up nftables rules..."
  nft list ruleset > "${BACKUP_DIR}/nftables.rules"
  success "Firewall rules backed up"
fi

# Backup fail2ban config
if [[ -d /etc/fail2ban ]]; then
  log "Backing up fail2ban configuration..."
  tar -czf "${BACKUP_DIR}/fail2ban-config.tar.gz" /etc/fail2ban 2>/dev/null
  success "fail2ban configuration backed up"
fi

# Create manifest
cat > "${BACKUP_DIR}/manifest.txt" <<MANIFEST
FreeRADIUS Backup Manifest
==========================
Timestamp: ${TIMESTAMP}
Hostname: $(hostname)
FreeRADIUS Version: $(freeradius -v 2>&1 | head -n1)

Contents:
- freeradius-config.tar.gz (Full configuration)
- freeradius-certs.tar.gz (Certificates and keys)
- nftables.rules (Firewall configuration)
- fail2ban-config.tar.gz (Intrusion prevention)

Restore Instructions:
1. Stop FreeRADIUS: systemctl stop freeradius
2. Extract config: tar -xzf freeradius-config.tar.gz -C /
3. Extract certs: tar -xzf freeradius-certs.tar.gz -C /
4. Restore firewall: nft -f nftables.rules
5. Start service: systemctl start freeradius
MANIFEST

success "Manifest created"

# Set permissions
chmod 700 "$BACKUP_DIR"

# Cleanup old backups (keep last 7)
log "Cleaning up old backups (keeping last 7)..."
cd "$BACKUP_ROOT"
ls -t | tail -n +8 | xargs -r rm -rf
success "Old backups cleaned"

echo ""
success "Backup complete: $BACKUP_DIR"
echo ""

exit 0
```

---

### **File 13: `01_bootstrap/freeradius/docs/DEPLOYMENT-CHECKLIST.md`**

```markdown
# FreeRADIUS Deployment Checklist

**Pre-deployment validation for production fortress**

## Pre-Flight Checks

### Infrastructure
- [ ] LXC container created on Proxmox (rylan-radius)
- [ ] Static IP assigned: 10.0.10.11
- [ ] Network bridge to VLAN 10 configured
- [ ] DNS resolution working (ping rylan-dc.rylan.internal)
- [ ] NTP synchronized (timedatectl status)

### Dependencies
- [ ] rylan-dc operational and reachable
- [ ] LDAPS port 636 accessible from rylan-radius
- [ ] Internal CA exists: `/etc/ssl/rylan-internal/rylan-ca.crt` on rylan-dc
- [ ] SSH key trust configured (rylan-radius → rylan-dc)

### LDAP Configuration
- [ ] LDAP group created: `cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal`
- [ ] Test user created in Samba AD
- [ ] Test user added to `radius-vlan10-admins` group
- [ ] LDAP bind credentials available (Administrator password)

### Environment
- [ ] `.env` file created from `.env.example`
- [ ] `VAULT_SAMBA_ADMIN` set (Samba Administrator password)
- [ ] `RADIUS_SECRET` set (32+ character random string)
- [ ] All required variables validated

## Deployment Steps

### Phase 1: Ministry of Secrets (Carter)
- [ ] FreeRADIUS packages installed
- [ ] DC Root CA imported to `/etc/freeradius/certs/rylan-ca.pem`
- [ ] Server certificate generated and signed by DC CA
- [ ] DH parameters generated (2048-bit)
- [ ] LDAP module configured with AD schema
- [ ] EAP module configured (TLS + TTLS)
- [ ] RADIUS clients configured (Management VLAN)
- [ ] Configuration syntax validated (`freeradius -C`)
- [ ] FreeRADIUS service started and enabled

### Phase 2: Ministry of Whispers (Bauer)
- [ ] SSH hardened (password auth disabled, key-only)
- [ ] nftables installed and configured
- [ ] Firewall rules applied (≤10 rules, Beale doctrine)
- [ ] RADIUS ports (1812/1813) allowed from Management VLAN
- [ ] fail2ban installed and configured
- [ ] FreeRADIUS jail active in fail2ban
- [ ] auditd installed and configured
- [ ] FreeRADIUS audit rules loaded
- [ ] Log rotation configured

### Phase 3: Ministry of Detection (Beale)
- [ ] FreeRADIUS service status verified
- [ ] LDAP connectivity tested (ldapsearch)
- [ ] RADIUS ports listening (ss -ulnp)
- [ ] Local authentication test passed (radtest)
- [ ] Firewall rules validated
- [ ] Certificate chain verified
- [ ] Network isolation confirmed
- [ ] System resources normal (CPU/memory)

### Final Validation
- [ ] `validate-eternal.sh` passed (exit code 0)
- [ ] All Trinity ministries validated
- [ ] No critical errors in logs
- [ ] Backup created

## Post-Deployment

### UniFi Controller Integration
- [ ] RADIUS server added to controller (10.0.10.11:1812)
- [ ] Shared secret configured (matches `.env`)
- [ ] RADIUS profile created
- [ ] Test SSID configured with RADIUS auth
- [ ] Client device authentication tested
- [ ] Authentication logs verified on both sides

### Monitoring Setup
- [ ] Log monitoring configured (journalctl -u freeradius -f)
- [ ] fail2ban alerts configured (optional)
- [ ] Certificate expiration monitoring (90-day warning)
- [ ] Backup schedule configured (daily recommended)

### Documentation
- [ ] Network diagram updated with RADIUS server
- [ ] Shared secret documented in secure vault
- [ ] Recovery procedures documented
- [ ] Admin contact information updated

## Rollback Plan

### If Deployment Fails
```bash
# Stop FreeRADIUS
systemctl stop freeradius

# Restore from backup
BACKUP_DIR="/var/backups/freeradius/<timestamp>"
tar -xzf $BACKUP_DIR/freeradius-config.tar.gz -C /
tar -xzf $BACKUP_DIR/freeradius-certs.tar.gz -C /

# Restore firewall
nft -f $BACKUP_DIR/nftables.rules

# Start service
systemctl start freeradius
```

### If Authentication Fails
1. Check user in LDAP group: `ldapsearch ... memberOf`
2. Verify LDAP connectivity: `ldapsearch -H ldaps://10.0.10.10`
3. Run debug mode: `freeradius -X`
4. Check logs: `journalctl -u freeradius -n 100`
5. Verify shared secret matches controller

## Security Hardening Verification

### Carter (Identity)
- [ ] No default passwords in production configs
- [ ] Certificate private key permissions: 600
- [ ] clients.conf permissions: 640
- [ ] LDAP bind password not in logs
- [ ] Certificate expiration > 30 days

### Bauer (Hardening)
- [ ] SSH password authentication disabled
- [ ] Root login via password disabled
- [ ] fail2ban active and monitoring
- [ ] Audit rules loaded and logging
- [ ] Log files rotated and retaine```markdown
d

### Beale (Detection)
- [ ] Firewall rules ≤10 (doctrine compliant)
- [ ] Only required ports open (22, 1812, 1813)
- [ ] LDAPS connectivity verified
- [ ] Network isolation from untrusted VLANs
- [ ] No unauthorized listening services

### Whitaker (Adversarial)
- [ ] No default RADIUS secrets in production
- [ ] Certificate chain validated
- [ ] Minimal attack surface (≤5 listening ports)
- [ ] File permissions secure (no world-readable secrets)
- [ ] Brute force protection active (fail2ban)

## Performance Baselines

### Expected Metrics
- **CPU Usage**: <10% idle, <50% under load
- **Memory Usage**: <500MB typical, <1GB peak
- **Auth Latency**: <100ms average
- **LDAP Query Time**: <50ms average
- **Concurrent Sessions**: 100+ supported

### Load Testing (Optional)
```bash
# Install eapol_test for load testing
apt-get install eapol-test

# Run 100 concurrent auth tests
for i in {1..100}; do
  radtest testuser testpass localhost 1812 testing123 &
done
wait

# Monitor performance
top -bn1 | grep freeradius
```

## Maintenance Schedule

### Daily
- [ ] Review authentication logs for anomalies
- [ ] Check fail2ban ban list
- [ ] Verify service status

### Weekly
- [ ] Review audit logs
- [ ] Check disk space (/var/log)
- [ ] Verify backup integrity

### Monthly
- [ ] Certificate expiration check
- [ ] Update packages (security patches)
- [ ] Review firewall rules
- [ ] Test disaster recovery procedure

### Quarterly
- [ ] Rotate RADIUS shared secrets
- [ ] Review LDAP group memberships
- [ ] Conduct penetration test
- [ ] Update documentation

## Emergency Contacts

| Role | Name | Contact | Responsibility |
|------|------|---------|----------------|
| Primary Admin | | | FreeRADIUS/LDAP |
| Network Admin | | | UniFi/Firewall |
| Security Lead | | | Incident Response |
| On-Call | | | After-hours |

## Success Criteria

### Deployment Complete When:
- [x] All phases executed without errors
- [x] `validate-eternal.sh` returns exit code 0
- [x] Test user can authenticate via RADIUS
- [x] UniFi controller shows successful auth
- [x] Logs show no critical errors
- [x] Backup created and verified
- [x] Documentation updated

### Production Ready When:
- [x] All checklist items completed
- [x] Load testing passed (if applicable)
- [x] Security hardening verified
- [x] Monitoring configured
- [x] Rollback plan tested
- [x] Team trained on operations

---

**The fortress never sleeps. Authentication eternal.**
```

---

### **File 14: `01_bootstrap/freeradius/docs/TROUBLESHOOTING.md`**

```markdown
# FreeRADIUS Troubleshooting Guide

**Systematic diagnosis for authentication fortress issues**

## Quick Diagnostic Commands

```bash
# Service status
systemctl status freeradius
journalctl -u freeradius -n 50 --no-pager

# Configuration test
freeradius -C

# Debug mode (foreground)
systemctl stop freeradius
freeradius -X

# Test authentication
radtest testuser testpass localhost 1812 testing123

# Check listening ports
ss -ulnp | grep -E "1812|1813"

# Verify LDAP connectivity
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" "(objectClass=*)"
```

---

## Common Issues

### 1. Service Won't Start

**Symptoms**:
- `systemctl start freeradius` fails
- Service shows "failed" status

**Diagnosis**:
```bash
# Check configuration syntax
freeradius -C

# View detailed errors
journalctl -u freeradius -xe

# Run in debug mode
freeradius -X
```

**Common Causes**:

#### Invalid Configuration Syntax
```bash
# Error: "Failed to parse configuration"
# Fix: Check syntax in modified files
freeradius -C
```

#### Port Already in Use
```bash
# Error: "Failed to bind to auth address * port 1812"
# Check what's using the port
ss -ulnp | grep 1812

# Kill conflicting process
kill <PID>
```

#### Certificate Issues
```bash
# Error: "Failed to initialize TLS"
# Verify certificates exist
ls -la /etc/freeradius/certs/

# Check certificate validity
openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem

# Check permissions
stat /etc/freeradius/certs/server.key
# Should be: 600, owner freerad:freerad
```

#### LDAP Module Errors
```bash
# Error: "Failed to initialize LDAP module"
# Test LDAP connectivity
timeout 5 bash -c "echo > /dev/tcp/10.0.10.10/636"

# Verify CA certificate
openssl s_client -connect 10.0.10.10:636 \
  -CAfile /etc/freeradius/certs/rylan-ca.pem
```

---

### 2. Authentication Failures

**Symptoms**:
- Users receive "Access-Reject"
- UniFi shows "authentication failed"

**Diagnosis**:
```bash
# Run in debug mode and watch output
freeradius -X

# In another terminal, trigger auth
radtest testuser testpass localhost 1812 testing123

# Check LDAP query results
tail -f /var/log/freeradius/radius.log | grep LDAP
```

**Common Causes**:

#### User Not in Admin Group
```bash
# Check group membership
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" \
  "(sAMAccountName=testuser)" memberOf

# Expected output should include:
# memberOf: cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal

# Add user to group (on rylan-dc)
samba-tool group addmembers radius-vlan10-admins testuser
```

#### Incorrect Password
```bash
# Verify password works with LDAP directly
ldapwhoami -x -H ldaps://10.0.10.10 \
  -D "cn=testuser,cn=Users,dc=rylan,dc=internal" \
  -w "password"

# If fails: Reset password on rylan-dc
samba-tool user setpassword testuser
```

#### LDAP Filter Mismatch
```bash
# Debug: Check what FreeRADIUS is searching for
# In freeradius -X output, look for:
# (0) ldap: Performing search in "cn=Users,dc=rylan,dc=internal"
# (0) ldap: Using filter "(sAMAccountName=testuser)"

# Verify user exists with that attribute
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "cn=Users,dc=rylan,dc=internal" \
  "(sAMAccountName=testuser)"
```

#### EAP Negotiation Failure
```bash
# Error: "EAP-TLS negotiation failed"
# Check client is sending correct EAP type
# In freeradius -X:
# (0) eap: Peer sent EAP Response (code 2) ID 1 length 6
# (0) eap: Continuing tunnel setup

# Verify EAP module enabled
ls -la /etc/freeradius/3.0/mods-enabled/eap

# Check certificate chain
openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem
```

---

### 3. LDAP Connectivity Issues

**Symptoms**:
- "Failed to connect to LDAP server"
- Timeout errors in logs

**Diagnosis**:
```bash
# Test network connectivity
ping -c 3 10.0.10.10

# Test LDAPS port
timeout 5 bash -c "echo > /dev/tcp/10.0.10.10/636"

# Test LDAP bind
ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" -s base "(objectclass=*)"
```

**Common Causes**:

#### Firewall Blocking
```bash
# Check if firewall allows LDAPS
nft list ruleset | grep 636

# Add rule if missing
nft add rule inet filter ```bash
 output ip daddr 10.0.10.10 tcp dport 636 accept
```

#### CA Certificate Mismatch
```bash
# Test SSL/TLS connection
openssl s_client -connect 10.0.10.10:636 \
  -CAfile /etc/freeradius/certs/rylan-ca.pem \
  -showcerts

# Should show "Verify return code: 0 (ok)"
# If not, re-import CA certificate
scp root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt \
  /etc/freeradius/certs/rylan-ca.pem
```

#### DNS Resolution Failure
```bash
# Test DNS
nslookup rylan-dc.rylan.internal

# If fails, use IP directly in LDAP config
sed -i 's|ldaps://rylan-dc.rylan.internal|ldaps://10.0.10.10|' \
  /etc/freeradius/3.0/mods-available/ldap
```

#### Incorrect Bind Credentials
```bash
# Verify bind DN and password
ldapwhoami -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN"

# Should output: dn:cn=Administrator,cn=Users,dc=rylan,dc=internal
```

---

### 4. UniFi Controller Integration Issues

**Symptoms**:
- Controller shows "RADIUS server unreachable"
- Authentication attempts not appearing in RADIUS logs

**Diagnosis**:
```bash
# Verify RADIUS is listening
ss -ulnp | grep -E "1812|1813"

# Test from controller IP
# (Run on UniFi controller)
nc -zvu 10.0.10.11 1812
nc -zvu 10.0.10.11 1813

# Check firewall allows controller
nft list ruleset | grep "10.0.1.5"
```

**Common Causes**:

#### Incorrect Shared Secret
```bash
# Verify secret in clients.conf matches controller
grep -A5 "10.0.1.5" /etc/freeradius/3.0/clients.conf

# Update if needed
vim /etc/freeradius/3.0/clients.conf
systemctl restart freeradius
```

#### Firewall Blocking Controller
```bash
# Check if Management VLAN allowed
nft list ruleset | grep "10.0.1.0/27"

# Add rule if missing
nft add rule inet filter input ip saddr 10.0.1.0/27 udp dport 1812 accept
nft add rule inet filter input ip saddr 10.0.1.0/27 udp dport 1813 accept
```

#### Wrong RADIUS Server IP in Controller
```bash
# Verify controller configuration
# Settings → Profiles → RADIUS
# IP Address should be: 10.0.10.11
# Port should be: 1812
```

#### Message Authenticator Mismatch
```bash
# Ensure clients.conf has:
# require_message_authenticator = yes

# Update clients.conf
sed -i 's/require_message_authenticator = no/require_message_authenticator = yes/' \
  /etc/freeradius/3.0/clients.conf
systemctl restart freeradius
```

---

### 5. Certificate Expiration

**Symptoms**:
- "Certificate has expired" errors
- EAP-TLS authentication fails

**Diagnosis**:
```bash
# Check certificate expiration
openssl x509 -in /etc/freeradius/certs/server.pem \
  -noout -dates

# Check days until expiration
openssl x509 -in /etc/freeradius/certs/server.pem \
  -noout -enddate | cut -d= -f2 | xargs -I {} date -d {} +%s | \
  awk -v now=$(date +%s) '{print int(($1-now)/86400)" days"}'
```

**Solution**:
```bash
# Regenerate certificate
cd /opt/rylan-unifi-case-study/01_bootstrap/freeradius
sudo ./scripts/generate-radius-server-cert.sh

# Restart service
sudo systemctl restart freeradius

# Verify new certificate
openssl x509 -in /etc/freeradius/certs/server.pem -noout -dates
```

---

### 6. Performance Issues

**Symptoms**:
- Slow authentication (>5 seconds)
- High CPU/memory usage
- Timeout errors

**Diagnosis**:
```bash
# Check system resources
top -bn1 | grep freeradius
free -h
df -h

# Check LDAP query performance
time ldapsearch -x -H ldaps://10.0.10.10 \
  -D "cn=Administrator,cn=Users,dc=rylan,dc=internal" \
  -w "$VAULT_SAMBA_ADMIN" \
  -b "dc=rylan,dc=internal" "(sAMAccountName=testuser)"

# Check authentication latency
time radtest testuser testpass localhost 1812 testing123
```

**Common Causes**:

#### LDAP Slow Response
```bash
# Check network latency to DC
ping -c 10 10.0.10.10

# If high latency, check network path
traceroute 10.0.10.10

# Consider LDAP connection pooling (already enabled in config)
```

#### Too Many Concurrent Sessions
```bash
# Check active sessions
ss -u | grep -E "1812|1813" | wc -l

# Increase max_connections in radiusd.conf
sed -i 's/max_connections = 16/max_connections = 32/' \
  /etc/freeradius/3.0/radiusd.conf
systemctl restart freeradius
```

#### Disk I/O Bottleneck
```bash
# Check disk I/O
iostat -x 1 5

# If high, reduce logging verbosity
sed -i 's/auth = yes/auth = no/' /etc/freeradius/3.0/radiusd.conf
sed -i 's/auth_badpass = yes/auth_badpass = no/' /etc/freeradius/3.0/radiusd.conf
systemctl restart freeradius
```

---

### 7. fail2ban Not Blocking Attacks

**Symptoms**:
- Brute force attacks succeeding
- No bans in fail2ban log

**Diagnosis**:
```bash
# Check fail2ban status
systemctl status fail2ban

# Check FreeRADIUS jail
fail2ban-client status freeradius

# Check ban list
fail2ban-client get freeradius banip

# Test filter manually
fail2ban-regex /var/log/freeradius/radius.log \
  /etc/fail2ban/filter.d/freeradius.conf
```

**Common Causes**:

#### Jail Not Enabled
```bash
# Enable jail
cat > /etc/fail2ban/jail.d/freeradius.conf <<EOF
[freeradius]
enabled = true
port = 1812,1813
protocol = udp
filter = freeradius
logpath = /var/log/freeradius/radius.log
maxretry = 5
bantime = 3600
findtime = 600
EOF

systemctl restart fail2ban
```

#### Log File Not Found
```bash
# Verify log path
ls -la /var/log/freeradius/radius.log

# If missing, enable logging in radiusd.conf
sed -i 's/destination = files/destination = files/' \
  /etc/freeradius/3.0/radiusd.conf
systemctl restart freeradius
```

#### Filter Not Matching
```bash
# Test filter against actual log
tail -100 /var/log/freeradius/radius.log | \
  fail2ban-regex - /etc/fail2ban/filter.d/freeradius.conf

# Update filter if needed
vim /etc/fail2ban/filter.d/freeradius.conf
systemctl restart fail2ban
```

---

## Advanced Debugging

### Enable Maximum Verbosity

```bash
# Stop service
systemctl stop freeradius

# Run in full debug mode
freeradius -X -l stdout

# In another terminal, trigger authentication
radtest testuser testpass localhost 1812 testing123
```

### Packet Capture

```bash
# Capture RADIUS traffic
tcpdump -i any -n port 1812 or port 1813 -w /tmp/radius.pcap

# Analyze with tshark
tshark -r /tmp/radius.pcap -V
```

### LDAP Debug

```bash
# Enable LDAP debug in FreeRADIUS
# Add to /etc/freeradius/3.0/mods-available/ldap:
# debug = yes

systemctl restart freeradius
freeradius -X | grep -i ldap
```

### Trace Authentication Flow

```bash
# Enable detailed logging
cat >> /etc/freeradius/3.0/radiusd.conf <<EOF
log {
    destination = files
    file = /var/log/freeradius/radius.log
    auth = yes
    auth_badpass = yes
    auth_goodpass = yes
    msg_denied = "You are already logged in - access denied"
}
EOF

systemctl```bash
 restart freeradius

# Watch authentication flow in real-time
tail -f /var/log/freeradius/radius.log
```

---

## Recovery Procedures

### Complete Service Reset

```bash
# 1. Stop service
systemctl stop freeradius

# 2. Backup current config
tar -czf /tmp/freeradius-backup-$(date +%Y%m%d).tar.gz /etc/freeradius

# 3. Restore from known-good backup
BACKUP_DIR="/var/backups/freeradius/<timestamp>"
tar -xzf $BACKUP_DIR/freeradius-config.tar.gz -C /
tar -xzf $BACKUP_DIR/freeradius-certs.tar.gz -C /

# 4. Fix permissions
chown -R freerad:freerad /etc/freeradius
chmod 600 /etc/freeradius/certs/server.key
chmod 640 /etc/freeradius/3.0/clients.conf

# 5. Test configuration
freeradius -C

# 6. Start service
systemctl start freeradius

# 7. Verify
systemctl status freeradius
radtest testuser testpass localhost 1812 testing123
```

### Emergency Bypass (Temporary)

```bash
# If LDAP is down, temporarily allow local auth
# WARNING: Only for emergency troubleshooting

# 1. Create local test user
cat >> /etc/freeradius/3.0/users <<EOF
testuser Cleartext-Password := "testpass"
EOF

# 2. Disable LDAP module temporarily
rm /etc/freeradius/3.0/mods-enabled/ldap

# 3. Restart
systemctl restart freeradius

# 4. Test
radtest testuser testpass localhost 1812 testing123

# 5. RESTORE LDAP WHEN FIXED
ln -sf ../mods-available/ldap /etc/freeradius/3.0/mods-enabled/ldap
sed -i '/testuser/d' /etc/freeradius/3.0/users
systemctl restart freeradius
```

### Certificate Emergency Regeneration

```bash
# If certificates corrupted/lost
cd /opt/rylan-unifi-case-study/01_bootstrap/freeradius

# 1. Re-import CA
scp root@10.0.10.10:/etc/ssl/rylan-internal/rylan-ca.crt \
  /etc/freeradius/certs/rylan-ca.pem

# 2. Regenerate server cert
sudo ./scripts/generate-radius-server-cert.sh

# 3. Regenerate DH params (if missing)
openssl dhparam -out /etc/freeradius/certs/dh 2048

# 4. Fix permissions
chown freerad:freerad /etc/freeradius/certs/*
chmod 600 /etc/freeradius/certs/server.key
chmod 644 /etc/freeradius/certs/server.pem
chmod 644 /etc/freeradius/certs/rylan-ca.pem

# 5. Verify and restart
openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem
systemctl restart freeradius
```

---

## Log Analysis

### Find Failed Authentication Attempts

```bash
# Last 50 failed auths
grep "Access-Reject" /var/log/freeradius/radius.log | tail -50

# Failed auths by user
grep "Access-Reject" /var/log/freeradius/radius.log | \
  grep -oP 'User-Name = "\K[^"]+' | sort | uniq -c | sort -rn

# Failed auths by source IP
grep "Access-Reject" /var/log/freeradius/radius.log | \
  grep -oP 'from host \K[^ ]+' | sort | uniq -c | sort -rn
```

### Find Successful Authentications

```bash
# Last 50 successful auths
grep "Access-Accept" /var/log/freeradius/radius.log | tail -50

# Successful auths by user
grep "Access-Accept" /var/log/freeradius/radius.log | \
  grep -oP 'User-Name = "\K[^"]+' | sort | uniq -c | sort -rn

# Auth success rate
TOTAL=$(grep -c "Access-" /var/log/freeradius/radius.log)
SUCCESS=$(grep -c "Access-Accept" /var/log/freeradius/radius.log)
echo "Success Rate: $(awk "BEGIN {printf \"%.2f\", ($SUCCESS/$TOTAL)*100}")%"
```

### Find LDAP Errors

```bash
# LDAP connection failures
grep -i "ldap.*fail\|ldap.*error" /var/log/freeradius/radius.log

# LDAP bind failures
grep -i "ldap.*bind.*fail" /var/log/freeradius/radius.log

# LDAP timeout errors
grep -i "ldap.*timeout" /var/log/freeradius/radius.log
```

### Find Certificate Errors

```bash
# TLS/SSL errors
grep -i "tls\|ssl\|certificate" /var/log/freeradius/radius.log | grep -i error

# Certificate expiration warnings
grep -i "certificate.*expir" /var/log/freeradius/radius.log
```

---

## Performance Tuning

### Optimize LDAP Queries

```bash
# Add connection pooling (already in config, verify)
grep -A5 "ldap {" /etc/freeradius/3.0/mods-available/ldap | grep pool

# Reduce LDAP timeout for faster failure
sed -i 's/timeout = 10/timeout = 5/' \
  /etc/freeradius/3.0/mods-available/ldap
sed -i 's/timelimit = 10/timelimit = 5/' \
  /etc/freeradius/3.0/mods-available/ldap

systemctl restart freeradius
```

### Increase Thread Pool

```bash
# Edit radiusd.conf
vim /etc/freeradius/3.0/radiusd.conf

# Find thread pool section and increase:
thread pool {
    start_servers = 5
    max_servers = 32
    min_spare_servers = 3
    max_spare_servers = 10
    max_requests_per_server = 0
}

systemctl restart freeradius
```

### Optimize Logging

```bash
# Reduce logging for production (after testing)
cat > /etc/freeradius/3.0/radiusd.conf.d/logging.conf <<EOF
log {
    destination = files
    file = /var/log/freeradius/radius.log
    auth = no
    auth_badpass = yes
    auth_goodpass = no
    msg_denied = "Access denied"
}
EOF

systemctl restart freeradius
```

---

## Monitoring Commands

### Real-Time Monitoring

```bash
# Watch authentication attempts
watch -n 1 'tail -20 /var/log/freeradius/radius.log'

# Monitor service status
watch -n 5 'systemctl status freeradius --no-pager'

# Monitor resource usage
watch -n 2 'ps aux | grep freeradius | grep -v grep'

# Monitor network connections
watch -n 2 'ss -u | grep -E "1812|1813" | wc -l'
```

### Health Check Script

```bash
#!/bin/bash
# Quick health check

echo "=== FreeRADIUS Health Check ==="
echo ""

# Service status
if systemctl is-active --quiet freeradius; then
  echo "✓ Service: RUNNING"
else
  echo "✗ Service: STOPPED"
fi

# Listening ports
if ss -ulnp | grep -q ":1812"; then
  echo "✓ Auth Port: LISTENING"
else
  echo "✗ Auth Port: NOT LISTENING"
fi

# LDAP connectivity
if timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636" 2>/dev/null; then
  echo "✓ LDAP: REACHABLE"
else
  echo "✗ LDAP: UNREACHABLE"
fi

# Certificate validity
DAYS=$(openssl x509 -in /etc/freeradius/certs/server.pem -noout -enddate | \
  cut -d= -f2 | xargs -I {} date -d {} +%s | \
  awk -v now=$(date +%s) '{print int(($1-now)/86400)}')
if [[ $DAYS -gt 30 ]]; then
  echo "✓ Certificate: Valid ($DAYS days)"
elif [[ $DAYS -gt 0 ]]; then
  echo "⚠ Certificate: Expiring soon ($DAYS days)"
else
  echo "✗ Certificate: EXPIRED"
fi

# Recent errors
ERRORS=$(journalctl -u freeradius --since "1 hour ago" | grep -ci error)
if [[ $ERRORS -eq 0 ]]; then
  echo "✓ Errors: None (last hour)"
else
  echo "⚠ Errors: $ERRORS (last hour```bash
)"
fi

# Auth success rate (last 100)
TOTAL=$(tail -100 /var/log/freeradius/radius.log | grep -c "Access-" || echo 0)
if [[ $TOTAL -gt 0 ]]; then
  SUCCESS=$(tail -100 /var/log/freeradius/radius.log | grep -c "Access-Accept" || echo 0)
  RATE=$(awk "BEGIN {printf \"%.0f\", ($SUCCESS/$TOTAL)*100}")
  if [[ $RATE -gt 80 ]]; then
    echo "✓ Auth Rate: ${RATE}% (last 100)"
  else
    echo "⚠ Auth Rate: ${RATE}% (last 100)"
  fi
else
  echo "⚠ Auth Rate: No recent attempts"
fi

echo ""
```

---

## Contact and Escalation

### When to Escalate

**Immediate Escalation**:
- Service down >15 minutes
- Certificate expired
- Security breach detected
- LDAP server unreachable
- Firewall blocking all traffic

**Standard Escalation**:
- Authentication success rate <80%
- High error rate (>10/hour)
- Performance degradation
- Certificate expiring <7 days

### Debug Information to Collect

```bash
# Create support bundle
BUNDLE="/tmp/freeradius-debug-$(date +%Y%m%d-%H%M%S).tar.gz"

mkdir -p /tmp/freeradius-debug
cd /tmp/freeradius-debug

# Collect system info
uname -a > system-info.txt
uptime >> system-info.txt
free -h >> system-info.txt
df -h >> system-info.txt

# Collect service status
systemctl status freeradius --no-pager > service-status.txt
journalctl -u freeradius -n 500 --no-pager > service-logs.txt

# Collect configuration (sanitize secrets)
cp -r /etc/freeradius/3.0 ./config
sed -i 's/password = .*/password = [REDACTED]/' ./config/mods-available/ldap
sed -i 's/secret = .*/secret = [REDACTED]/' ./config/clients.conf

# Collect logs
cp /var/log/freeradius/radius.log ./radius.log 2>/dev/null || true
journalctl -u freeradius --since "24 hours ago" > freeradius-24h.log

# Collect network info
ss -ulnp | grep -E "1812|1813" > listening-ports.txt
nft list ruleset > firewall-rules.txt

# Test connectivity
ping -c 5 10.0.10.10 > connectivity-test.txt 2>&1
timeout 5 bash -c "echo > /dev/tcp/10.0.10.10/636" && echo "LDAPS: OK" >> connectivity-test.txt || echo "LDAPS: FAIL" >> connectivity-test.txt

# Create tarball
cd /tmp
tar -czf "$BUNDLE" freeradius-debug/
rm -rf /tmp/freeradius-debug

echo "Debug bundle created: $BUNDLE"
echo "Share this with support team"
```

---

## Known Issues and Workarounds

### Issue: LDAP Referrals Causing Delays

**Symptom**: Authentication takes 5-10 seconds

**Workaround**:
```bash
# Disable referral chasing
sed -i 's/chase_referrals = yes/chase_referrals = no/' \
  /etc/freeradius/3.0/mods-available/ldap
systemctl restart freeradius
```

### Issue: EAP-TTLS Inner Auth Fails

**Symptom**: Outer tunnel succeeds, inner auth fails

**Workaround**:
```bash
# Verify inner-tunnel site enabled
ls -la /etc/freeradius/3.0/sites-enabled/inner-tunnel

# Check inner-tunnel uses LDAP
grep -A20 "authenticate {" /etc/freeradius/3.0/sites-available/inner-tunnel | grep ldap

# Enable if missing
vim /etc/freeradius/3.0/sites-available/inner-tunnel
# Add "ldap" to authenticate section
systemctl restart freeradius
```

### Issue: UniFi Controller Shows "Invalid Shared Secret"

**Symptom**: Controller rejects RADIUS responses

**Workaround**:
```bash
# Verify secret matches exactly (no trailing spaces)
grep -A5 "10.0.1.5" /etc/freeradius/3.0/clients.conf

# Update and restart
vim /etc/freeradius/3.0/clients.conf
systemctl restart freeradius

# Test from controller CLI
radtest testuser testpass 10.0.10.11 1812 <secret>
```

### Issue: Fail2ban Not Banning via UDP

**Symptom**: Brute force attacks not blocked

**Workaround**:
```bash
# fail2ban doesn't ban UDP by default, use iptables action
cat > /etc/fail2ban/action.d/nftables-udp.conf <<'EOF'
[Definition]
actionban = nft add element inet filter fail2ban-<name> { <ip> }
actionunban = nft delete element inet filter fail2ban-<name> { <ip> }
EOF

# Update jail to use nftables
sed -i 's/banaction = .*/banaction = nftables-udp/' \
  /etc/fail2ban/jail.d/freeradius.conf
systemctl restart fail2ban
```

---

## Validation After Fixes

### Post-Fix Checklist

```bash
# 1. Configuration syntax
freeradius -C
echo "Config syntax: $?"

# 2. Service status
systemctl status freeradius --no-pager
echo "Service status: $?"

# 3. Listening ports
ss -ulnp | grep -E "1812|1813"
echo "Ports listening: $?"

# 4. LDAP connectivity
timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636"
echo "LDAP reachable: $?"

# 5. Local auth test
radtest testuser testpass localhost 1812 testing123
echo "Local auth: $?"

# 6. Certificate validation
openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem \
  /etc/freeradius/certs/server.pem
echo "Certificate valid: $?"

# 7. Firewall rules
nft list ruleset | grep -E "1812|1813"
echo "Firewall rules: $?"

# 8. No errors in logs
journalctl -u freeradius --since "5 minutes ago" | grep -i error
echo "Recent errors: $?"
```

### Full Validation

```bash
# Run eternal validation script
cd /opt/rylan-unifi-case-study/01_bootstrap/freeradius
sudo ./scripts/validate-eternal.sh

# Should output:
# ═══════════════════════════════════════════════════════════════════
#   ETERNAL GREEN — FREERADIUS FORTRESS OPERATIONAL
# ═══════════════════════════════════════════════════════════════════
```

---

**The fortress never sleeps. Troubleshooting eternal.**
```

---

### **File 15: `01_bootstrap/freeradius/docs/UNIFI-INTEGRATION.md`**

```markdown
# UniFi Controller Integration Guide

**Step-by-step RADIUS authentication configuration for UniFi network**

## Prerequisites

- [ ] FreeRADIUS deployed and validated (eternal green)
- [ ] UniFi Cloud Controller accessible (10.0.1.5)
- [ ] RADIUS shared secret documented
- [ ] Test user in `radius-vlan10-admins` LDAP group

---

## Phase 1: Configure RADIUS Server in Controller

### 1. Access UniFi Controller

```
URL: https://10.0.1.5:8443
Login with admin credentials
```

### 2. Add RADIUS Server

**Navigation**: Settings → Profiles → RADIUS

**Click**: Create New RADIUS Profile

**Configuration**:
```
Name: rylan-radius-primary
Auth Servers:
  IP/Hostname: 10.0.1.11
  Port: 1812
  Shared Secret: <RADIUS_SECRET from .env>

Accounting Servers:
  IP/Hostname: 10.0.1.11
  Port: 1813
  Shared Secret: <RADIUS_SECRET from .env>

Advanced:
  ☑ Interim Update Interval: 3600 seconds
  ☑ Accounting Enabled
```

**Click**: Apply Changes

### 3. Test RADIUS Server Connectivity

**UniFi CLI** (SSH to controller):
```bash
# Test RADIUS auth port
nc -zvu 10.0.10.11 1812

# Test RADIUS acct port
nc -zvu 10.0.10.11 1813

# Expected: Connection succeeded
```

---

## Phase 2: Create Enterprise SSID

### 1. Create New WiFi Network

**Navigation**: Settings → WiFi

**Click**: Create New WiFi Network

**Configuration**:
```
Name/SSID: Rylan-Secure
Enabled: ☑
Security Protocol: WPA2 Enterprise

RADIUS Profile: rylan-radius-primary

Advanced:
  Group Rekey Interval: 3600
  PMF```markdown
: Optional
  Fast Roaming: ☑ (if supported by clients)
  Minimum Data Rate Control: Auto
```

**VLAN Configuration**:
```
VLAN: 30 (trusted-devices)
☐ Use RADIUS assigned VLAN (static VLAN per SSID)
```

**Guest Policy**:
```
☐ Guest Policy (this is for authenticated users)
```

**Click**: Add WiFi Network

### 2. Apply to Access Points

**Navigation**: Devices → Access Points

**For each AP**:
- Select AP
- Configuration → WiFi
- Enable "Rylan-Secure" SSID
- Apply Changes

---

## Phase 3: Configure Client Devices

### Windows 10/11

**Settings → Network & Internet → WiFi → Manage Known Networks**

1. **Add Network**:
   - Network name: `Rylan-Secure`
   - Security type: `WPA2-Enterprise`

2. **Configure Authentication**:
   - EAP method: `Protected EAP (PEAP)` or `Smart Card or other certificate (EAP-TLS)`
   - Authentication method: `EAP-MSCHAPv2` (for PEAP)

3. **Credentials**:
   - Username: `<AD_USERNAME>` (e.g., `testuser`)
   - Password: `<AD_PASSWORD>`
   - Domain: `rylan.internal` (optional)

4. **Certificate Validation** (Recommended):
   - ☑ Validate server certificate
   - Trusted Root CA: Import `rylan-ca.crt`
   - Server name: `rylan-radius.rylan.internal`

### macOS

**System Preferences → Network → WiFi → Advanced**

1. **Add Network**:
   - SSID: `Rylan-Secure`
   - Security: `WPA2 Enterprise`

2. **802.1X Settings**:
   - User Profile
   - Username: `<AD_USERNAME>`
   - Password: `<AD_PASSWORD>`
   - Mode: `Automatic`

3. **Trust Certificate**:
   - When prompted, click "Show Certificate"
   - Verify issuer: `Rylan Internal Root CA`
   - Click "Continue" → "Always Trust"

### Linux (NetworkManager)

```bash
# GUI Method
nm-connection-editor

# Add WiFi connection:
# - SSID: Rylan-Secure
# - Security: WPA & WPA2 Enterprise
# - Authentication: Protected EAP (PEAP)
# - Anonymous identity: (leave blank)
# - CA certificate: /path/to/rylan-ca.crt
# - PEAP version: Automatic
# - Inner authentication: MSCHAPv2
# - Username: <AD_USERNAME>
# - Password: <AD_PASSWORD>
```

**CLI Method**:
```bash
nmcli connection add \
  type wifi \
  con-name "Rylan-Secure" \
  ifname wlan0 \
  ssid "Rylan-Secure" \
  wifi-sec.key-mgmt wpa-eap \
  802-1x.eap peap \
  802-1x.phase2-auth mschapv2 \
  802-1x.identity "<AD_USERNAME>" \
  802-1x.password "<AD_PASSWORD>" \
  802-1x.ca-cert /path/to/rylan-ca.crt

nmcli connection up "Rylan-Secure"
```

### iOS/iPadOS

**Settings → WiFi → Rylan-Secure**

1. **Configure**:
   - Username: `<AD_USERNAME>`
   - Password: `<AD_PASSWORD>`

2. **Trust Certificate**:
   - When prompted: "Cannot Verify Server Identity"
   - Tap "More Details"
   - Verify: Issuer is `Rylan Internal Root CA`
   - Tap "Trust"

**Advanced** (Configuration Profile):
```xml
<!-- Install via Apple Configurator or MDM -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>SSID_STR</key>
            <string>Rylan-Secure</string>
            <key>EAPClientConfiguration</key>
            <dict>
                <key>AcceptEAPTypes</key>
                <array>
                    <integer>25</integer> <!-- PEAP -->
                </array>
                <key>UserName</key>
                <string>USERNAME</string>
                <key>UserPassword</key>
                <string>PASSWORD</string>
                <key>TLSTrustedServerNames</key>
                <array>
                    <string>rylan-radius.rylan.internal</string>
                </array>
            </dict>
        </dict>
    </array>
</dict>
</plist>
```

### Android

**Settings → Network & Internet → WiFi → Rylan-Secure**

1. **Configure**:
   - EAP method: `PEAP`
   - Phase 2 authentication: `MSCHAPV2`
   - CA certificate: `Use system certificates` or install `rylan-ca.crt`
   - Domain: `rylan-radius.rylan.internal`
   - Identity: `<AD_USERNAME>`
   - Anonymous identity: (leave blank)
   - Password: `<AD_PASSWORD>`

2. **Advanced Options**:
   - ☑ Validate server certificate
   - Server name: `rylan-radius.rylan.internal`

---

## Phase 4: Testing and Validation

### 1. Test Client Authentication

**From FreeRADIUS Server**:
```bash
# Watch authentication attempts in real-time
tail -f /var/log/freeradius/radius.log
```

**Connect client device to Rylan-Secure SSID**

**Expected Log Output**:
```
(0) Received Access-Request Id 123 from 10.0.1.6:54321 to 10.0.10.11:1812
(0) User-Name = "testuser"
(0) NAS-IP-Address = 10.0.1.6
(0) Called-Station-Id = "AA-BB-CC-DD-EE-FF:Rylan-Secure"
(0) ldap: User found: cn=testuser,cn=Users,dc=rylan,dc=internal
(0) ldap: User is member of: cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal
(0) eap_peap: Session established
(0) Sent Access-Accept Id 123 from 10.0.10.11:1812 to 10.0.1.6:54321
```

### 2. Verify in UniFi Controller

**Navigation**: Insights → Client Devices

**Find connected client**:
- Should show "Connected" status
- Authentication method: `802.1X`
- VLAN: `30` (trusted-devices)

### 3. Test Network Connectivity

**From client device**:
```bash
# Verify IP assignment (should be in VLAN 30)
ip addr show
# Expected: 10.0.30.x

# Test internet connectivity
ping -c 3 1.1.1.1

# Test DNS resolution
nslookup google.com

# Verify VLAN isolation (should fail)
ping -c 1 10.0.90.1  # Guest VLAN gateway
```

### 4. Test Authentication Failure

**Connect with invalid credentials**:
- Username: `invaliduser`
- Password: `wrongpassword`

**Expected Behavior**:
- Connection fails
- Client shows "Authentication failed"

**FreeRADIUS Log**:
```
(0) Received Access-Request Id 124 from 10.0.1.6:54322
(0) User-Name = "invaliduser"
(0) ldap: User not found
(0) Sent Access-Reject Id 124 from 10.0.10.11:1812 to 10.0.1.6:54322
```

### 5. Test Group Policy

**Remove user from admin group** (on rylan-dc):
```bash
samba-tool group removemembers radius-vlan10-admins testuser
```

**Attempt connection**:
- Should fail with "Access-Reject"

**FreeRADIUS Log**:
```
(0) ldap: User not in required group
(0) Sent Access-Reject
```

**Restore access**:
```bash
samba-tool group addmembers radius-vlan10-admins testuser
```

---

## Phase 5: Production Hardening

### 1. Disable Legacy SSIDs

**Navigation**: Settings → WiFi

**For each legacy SSID** (PSK-based):
- Disable or delete
- Migrate users to Rylan-Secure

### 2. Enable MAC Address Filtering (Optional)

**Navigation**: Settings → Profiles → MAC Address Groups

**Create whitelist**:
- Add known/trusted device MACs
- Apply to Rylan-Secure SSID

### 3. Configure Captive Portal (Guest Network)

**For guest access** (separate from RADIUS):
- Create separate SSID: `Rylan-Guest`
- VLAN: 90 (guest-iot)
- Security: Open with captive portal
- ```markdown
 No RADIUS authentication
- Guest policy: Limited bandwidth, restricted access

### 4. Enable WIDS/WIPS

**Navigation**: Settings → WiFi → Advanced

**Configure**:
```
☑ Rogue AP Detection
☑ Wireless Intrusion Prevention
☑ Block unauthorized APs
☑ Alert on suspicious activity
```

### 5. Set Session Timeouts

**Navigation**: Settings → Profiles → RADIUS**

**Edit rylan-radius-primary**:
```
Session Timeout: 28800 (8 hours)
Idle Timeout: 3600 (1 hour)
Interim Update: 3600 (1 hour)
```

### 6. Enable Accounting

**Verify accounting enabled**:
```
☑ Accounting Enabled
Accounting Port: 1813
```

**Monitor accounting logs**:
```bash
# On FreeRADIUS server
tail -f /var/log/freeradius/radius.log | grep Accounting
```

---

## Phase 6: Monitoring and Alerts

### 1. UniFi Controller Alerts

**Navigation**: Settings → Notifications

**Enable alerts for**:
```
☑ WiFi client connected (802.1X)
☑ WiFi client disconnected
☑ RADIUS server unreachable
☑ Authentication failures (threshold: 5/hour)
```

### 2. FreeRADIUS Monitoring

**Create monitoring script**:
```bash
#!/bin/bash
# /opt/scripts/monitor-radius.sh

ALERT_EMAIL="admin@rylan.internal"
THRESHOLD=10

# Check failed auth attempts in last hour
FAILURES=$(journalctl -u freeradius --since "1 hour ago" | \
  grep -c "Access-Reject")

if [[ $FAILURES -gt $THRESHOLD ]]; then
  echo "ALERT: $FAILURES failed RADIUS authentications in last hour" | \
    mail -s "RADIUS Alert" $ALERT_EMAIL
fi

# Check service status
if ! systemctl is-active --quiet freeradius; then
  echo "CRITICAL: FreeRADIUS service is down" | \
    mail -s "RADIUS CRITICAL" $ALERT_EMAIL
fi
```

**Add to cron**:
```bash
# Run every 15 minutes
*/15 * * * * /opt/scripts/monitor-radius.sh
```

### 3. Dashboard Widgets

**UniFi Controller Dashboard**:
- Add widget: "WiFi Clients (802.1X)"
- Add widget: "Authentication Events"
- Add widget: "RADIUS Server Status"

---

## Troubleshooting Common Issues

### Client Can't Connect

**Check 1: Verify RADIUS server in controller**:
```
Settings → Profiles → RADIUS
Ensure rylan-radius-primary is configured
```

**Check 2: Test RADIUS connectivity from AP**:
```bash
# SSH to UniFi AP
ssh ubnt@<AP_IP>

# Test RADIUS port
nc -zvu 10.0.10.11 1812
```

**Check 3: Verify client credentials**:
- Username must match sAMAccountName in AD
- User must be in `radius-vlan10-admins` group

**Check 4: Certificate trust**:
- Client must trust Rylan Internal Root CA
- Install CA certificate on client device

### Authentication Succeeds but No Network Access

**Check 1: VLAN assignment**:
```bash
# On client device
ip addr show
# Should show 10.0.30.x (VLAN 30)
```

**Check 2: DHCP in VLAN 30**:
```
UniFi Controller → Settings → Networks → trusted-devices
Verify DHCP enabled: 10.0.30.100 - 10.0.30.200
```

**Check 3: Gateway reachable**:
```bash
ping 10.0.30.1
```

**Check 4: Firewall rules**:
```
Verify VLAN 30 has internet access
Check inter-VLAN routing rules
```

### Intermittent Disconnections

**Check 1: Session timeout**:
```
Settings → Profiles → RADIUS
Increase Session Timeout to 28800 (8 hours)
```

**Check 2: Roaming issues**:
```
Settings → WiFi → Rylan-Secure → Advanced
☑ Enable Fast Roaming (802.11r)
☑ Enable BSS Transition (802.11v)
```

**Check 3: AP load balancing**:
```
Settings → WiFi → Advanced
Adjust minimum RSSI for client steering
```

**Check 4: RADIUS server performance**:
```bash
# Check RADIUS response time
time radtest testuser testpass 10.0.10.11 1812 <secret>
# Should be <100ms
```

### Certificate Warnings on Clients

**Issue**: "Cannot verify server identity"

**Solution 1: Install CA certificate**:
- Export from rylan-dc: `/etc/ssl/rylan-internal/rylan-ca.crt`
- Install on client devices (varies by OS)

**Solution 2: Configure server name validation**:
- In client WiFi settings
- Server name: `rylan-radius.rylan.internal`
- Verify certificate CN matches

**Solution 3: Disable validation** (NOT RECOMMENDED):
- Only for testing
- Production should always validate certificates

---

## Advanced Configuration

### Multiple RADIUS Servers (High Availability)

**Deploy secondary RADIUS server**:
```bash
# Create rylan-radius-secondary (10.0.10.12)
# Follow same deployment process
# Use same CA certificates and LDAP config
```

**Add to UniFi Controller**:
```
Settings → Profiles → RADIUS → rylan-radius-primary
Add Secondary Auth Server:
  IP: 10.0.10.12
  Port: 1812
  Shared Secret: <same as primary>
```

**Test failover**:
```bash
# Stop primary RADIUS
systemctl stop freeradius

# Connect client (should use secondary)
# Check UniFi logs for failover event
```

### Dynamic VLAN Assignment (Future)

**If implementing dynamic VLANs**:

**FreeRADIUS config** (modify `sites-available/default`):
```unlang
authorize {
    # ... existing config ...

    if (LDAP-Group == "cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal") {
        update reply {
            Tunnel-Type = VLAN
            Tunnel-Medium-Type = IEEE-802
            Tunnel-Private-Group-Id = "10"
        }
    }
    elsif (LDAP-Group == "cn=radius-vlan30-users,ou=Groups,dc=rylan,dc=internal") {
        update reply {
            Tunnel-Private-Group-Id = "30"
        }
    }
    elsif (LDAP-Group == "cn=radius-vlan40-voip,ou=Groups,dc=rylan,dc=internal") {
        update reply {
            Tunnel-Private-Group-Id = "40"
        }
    }
    else {
        # Default to guest VLAN
        update reply {
            Tunnel-Private-Group-Id = "90"
        }
    }
}
```

**UniFi Controller**:
```
Settings → WiFi → Rylan-Secure
☑ Use RADIUS assigned VLAN
```

### EAP-TLS with Client Certificates

**Generate client certificates** (on rylan-dc):
```bash
# For each client
CLIENT_NAME="laptop-001"

# Generate client key
openssl genrsa -out ${CLIENT_NAME}.key 2048

# Generate CSR
openssl req -new -key ${CLIENT_NAME}.key -out ${CLIENT_NAME}.csr \
  -subj "/CN=${CLIENT_NAME}/OU=Clients/O=Rylan Internal/C=US"

# Sign with CA
openssl x509 -req -in ${CLIENT_NAME}.csr \
  -CA /etc/ssl/rylan-internal/rylan-ca.crt \
  -CAkey /etc/ssl/rylan-internal/rylan-ca.key \
  -CAcreateserial \
  -out ${CLIENT_NAME}.crt \
  -days 365 \
  -sha256 \
  -extfile <(echo "extendedKeyUsage=clientAuth")

# Create PKCS#12 bundle (for easy import)
openssl pkcs12 -export \
  -in ${CLIENT_NAME}.crt \
  -inkey ${CLIENT_NAME}.key \
  -certfile /etc/ssl/rylan-internal/rylan-ca.crt \
  -out ${CLIENT_NAME}.p12 \
  -name "${CLIENT_NAME}"
```

**Install on client**:
- Import `.p12` file
- Configure WiFi to use EAP-TLS
- Select installed certificate

**FreeRADIUS** (already configured for EAP-TLS):
- No changes needed
- Will automatically validate client certificates

---

## Maintenance Procedures

### Monthly Tasks

**1. Review authentication logs**:
```bash
# Top 10 users by auth count
grep "Access-Accept" /var/log/freeradius/radius.log | \
  grep -oP 'User-Name = "\K[^"]+' | sort | uniq -c | sort -rn | head -10

# Failed auth attempts
grep "Access-Reject" /var/log/freeradius/radius.log | \
  grep -oP 'User-Name = "\K[^"]+' | sort | uniq - ```bash
c | sort -rn | head -10
```

**2. Verify LDAP group memberships**:
```bash
# On rylan-dc
samba-tool group listmembers radius-vlan10-admins

# Remove inactive users
samba-tool group removemembers radius-vlan10-admins <username>
```

**3. Check certificate expiration**:
```bash
# Server certificate
openssl x509 -in /etc/freeradius/certs/server.pem -noout -enddate

# Renew if <30 days
cd /opt/rylan-unifi-case-study/01_bootstrap/freeradius
sudo ./scripts/generate-radius-server-cert.sh
```

**4. Review connected clients**:
```
UniFi Controller → Insights → Client Devices
Filter: Authentication = 802.1X
Review for unauthorized devices
```

**5. Update shared secret** (quarterly):
```bash
# Generate new secret
NEW_SECRET=$(openssl rand -base64 32)

# Update FreeRADIUS
sed -i "s/secret = .*/secret = $NEW_SECRET/" \
  /etc/freeradius/3.0/clients.conf
systemctl restart freeradius

# Update UniFi Controller
# Settings → Profiles → RADIUS → Edit
# Update shared secret
```

### Backup Procedures

**Weekly backup**:
```bash
# Automated backup script
/opt/rylan-unifi-case-study/01_bootstrap/freeradius/scripts/backup-radius-config.sh

# Verify backup
ls -lh /var/backups/freeradius/
```

**Export UniFi configuration**:
```
Settings → System → Maintenance → Download Backup
Save to secure location
```

---

## Performance Optimization

### Tune for High Client Count

**For >100 concurrent clients**:

**FreeRADIUS** (`/etc/freeradius/3.0/radiusd.conf`):
```
thread pool {
    start_servers = 10
    max_servers = 64
    min_spare_servers = 5
    max_spare_servers = 20
    max_requests_per_server = 0
}

listen {
    type = auth
    ipaddr = *
    port = 1812
    limit {
        max_connections = 256
        lifetime = 0
        idle_timeout = 30
    }
}
```

**LDAP connection pooling** (`/etc/freeradius/3.0/mods-available/ldap`):
```
pool {
    start = 5
    min = 3
    max = 32
    spare = 10
    uses = 0
    lifetime = 0
    idle_timeout = 60
}
```

**System tuning**:
```bash
# Increase file descriptors
echo "freerad soft nofile 65536" >> /etc/security/limits.conf
echo "freerad hard nofile 65536" >> /etc/security/limits.conf

# Increase UDP buffer
sysctl -w net.core.rmem_max=8388608
sysctl -w net.core.wmem_max=8388608
echo "net.core.rmem_max=8388608" >> /etc/sysctl.conf
echo "net.core.wmem_max=8388608" >> /etc/sysctl.conf
```

### Load Balancing Multiple APs

**UniFi Controller**:
```
Settings → WiFi → Advanced
Band Steering: Prefer 5GHz
Minimum RSSI: -70 dBm
Client Device Isolation: Disabled (for same VLAN)
```

**RADIUS**:
- No changes needed
- Each AP independently queries RADIUS
- LDAP connection pooling handles concurrent requests

---

## Security Best Practices

### 1. Regular Security Audits

**Monthly**:
```bash
# Check for brute force attempts
grep "Access-Reject" /var/log/freeradius/radius.log | \
  grep -oP 'from host \K[^ ]+' | sort | uniq -c | sort -rn

# Review fail2ban bans
fail2ban-client status freeradius

# Check for unauthorized RADIUS clients
nft list ruleset | grep -E "1812|1813"
```

**Quarterly**:
```bash
# Run full validation
sudo /opt/rylan-unifi-case-study/01_bootstrap/freeradius/scripts/validate-eternal.sh

# Review audit logs
ausearch -k freeradius_config -ts recent
```

### 2. Credential Management

**Password policy** (enforce in AD):
- Minimum 12 characters
- Complexity requirements
- 90-day rotation
- No password reuse (last 10)

**Service account** (LDAP bind):
- Dedicated service account (not Administrator)
- Strong password (32+ characters)
- Audit access regularly

### 3. Network Segmentation

**Isolate RADIUS server**:
- VLAN 10 (servers) only
- No direct access from client VLANs
- Firewall rules restrict to Management VLAN

**Monitor traffic**:
```bash
# Watch RADIUS traffic
tcpdump -i any -n port 1812 or port 1813

# Alert on unusual patterns
# (integrate with SIEM if available)
```

### 4. Certificate Security

**Protect private keys**:
```bash
# Verify permissions
stat /etc/freeradius/certs/server.key
# Must be: 600, owner freerad:freerad

# Audit access
ausearch -f /etc/freeradius/certs/server.key
```

**Rotate certificates**:
- Server cert: Annually
- CA cert: Every 5 years (plan migration)

---

## Documentation and Training

### User Documentation

**Create client setup guides**:
- Windows setup (with screenshots)
- macOS setup
- iOS/Android setup
- Linux setup

**Distribute CA certificate**:
- Make available via internal portal
- Include installation instructions
- Provide support contact

### Admin Documentation

**Runbook sections**:
1. Daily operations checklist
2. Common troubleshooting steps
3. Emergency procedures
4. Escalation contacts
5. Change management process

**Knowledge base articles**:
- How to add user to RADIUS group
- How to troubleshoot auth failures
- How to renew certificates
- How to update shared secrets

### Training Sessions

**For IT staff**:
- RADIUS architecture overview
- Troubleshooting methodology
- Log analysis techniques
- Security incident response

**For end users**:
- How to connect to Rylan-Secure
- Certificate trust procedures
- Who to contact for issues
- Security best practices

---

## Success Metrics

### Key Performance Indicators

**Availability**:
- Target: 99.9% uptime
- Monitor: `systemctl status freeradius`

**Authentication Success Rate**:
- Target: >95%
- Monitor: Access-Accept / Total Requests

**Response Time**:
- Target: <100ms average
- Monitor: `time radtest ...`

**Security**:
- Zero unauthorized access
- All failed attempts logged
- Brute force attacks blocked

### Reporting

**Weekly report**:
```bash
#!/bin/bash
# Generate weekly RADIUS report

WEEK_START=$(date -d "7 days ago" +%Y-%m-%d)

echo "RADIUS Weekly Report: $(date)"
echo "================================"
echo ""

echo "Authentication Statistics:"
TOTAL=$(journalctl -u freeradius --since "$WEEK_START" | grep -c "Access-")
SUCCESS=$(journalctl -u freeradius --since "$WEEK_START" | grep -c "Access-Accept")
REJECT=$(journalctl -u freeradius --since "$WEEK_START" | grep -c "Access-Reject")
RATE=$(awk "BEGIN {printf \"%.2f\", ($SUCCESS/$TOTAL)*100}")

echo "  Total Attempts: $TOTAL"
echo "  Successful: $SUCCESS"
echo "  Rejected: $REJECT"
echo "  Success Rate: ${RATE}%"
echo ""

echo "Top 10 Users:"
journalctl -u freeradius --since "$WEEK_START" | \
  grep "Access-Accept" | \
  grep -oP 'User-Name = "\K[^"]+' | \
  sort | uniq -c | sort -rn | head -10
echo ""

echo "Failed Authentication Attempts:"
journalctl -u freeradius --since "$WEEK_START" | \
  grep "Access-Reject" | \
  grep -oP 'User-Name = "\K[^"]+' | \
  sort | uniq -c | sort -rn | head -10
echo ""

echo "Service Uptime:"
systemctl status freeradius --no-pager | grep "Active:"
echo ""
```

---

**The fortress never sleeps. WiFi authentication eternal.**
```

---

### **File 16: `01_bootstrap/freeradius/.gitignore`**

```gitignore
# FreeRADIUS Trinity - Git Ignore
# Protect secrets and sensitive data

# Environment files
.env
*.env
!.env.example

# Logs
logs/
*.log
/var/log/freeradius/

# Backups
/var/backups/freeradius/
*.tar.gz
*.backup

# Certificates and keys (NEVER commit)
*.key
*.pem
*.crt
*.csr
*.p12
*.pfx
/etc/freeradius/certs/*
!```gitignore
/etc/freeradius/certs/.gitkeep

# Temporary files
*.tmp
*.swp
*.swo
*~
.DS_Store

# Lock files
*.lock
/var/run/*.lock

# Debug output
debug-*.txt
*.pcap

# Editor files
.vscode/
.idea/
*.sublime-*

# OS files
Thumbs.db
desktop.ini

# Compiled Python
__pycache__/
*.pyc
*.pyo

# Test artifacts
test-results/
coverage/

# Sensitive configuration
clients.conf
*password*
*secret*
```

---

### **File 17: `01_bootstrap/freeradius/CHANGELOG.md`**

```markdown
# Changelog

All notable changes to the FreeRADIUS Trinity deployment will be documented here.

## [1.0.0] - 2025-12-13

### Added - Initial Release

**Trinity Architecture**:
- Phase 1: Ministry of Secrets (Carter) - Certificate management, LDAP integration
- Phase 2: Ministry of Whispers (Bauer) - SSH hardening, nftables firewall, fail2ban
- Phase 3: Ministry of Detection (Beale) - Network validation, authentication testing

**Core Features**:
- Samba AD/LDAP authentication backend
- EAP-TLS and EAP-TTLS/MSCHAPv2 support
- Group-based access control (radius-vlan10-admins)
- Internal CA integration from rylan-dc
- Static VLAN assignment per SSID
- Management VLAN isolation (10.0.1.0/27)

**Security Hardening**:
- nftables firewall (≤10 rules, Beale doctrine)
- fail2ban brute force protection
- auditd configuration change tracking
- SSH key-only authentication
- Certificate-based server identity

**Operational Tools**:
- `ignite.sh` - Full deployment orchestrator
- `validate-eternal.sh` - Comprehensive validation
- `test-radius-auth.sh` - Interactive authentication testing
- `backup-radius-config.sh` - Configuration backup
- `generate-radius-server-cert.sh` - Certificate renewal

**Documentation**:
- README.md - Architecture and quick start
- DEPLOYMENT-CHECKLIST.md - Pre-flight and post-deployment validation
- TROUBLESHOOTING.md - Systematic diagnosis guide
- UNIFI-INTEGRATION.md - Step-by-step UniFi configuration

**Monitoring**:
- Structured logging to `/var/log/freeradius/`
- Log rotation (14-day retention)
- Service health check scripts
- Performance baseline metrics

### Technical Specifications

**Supported Platforms**:
- Ubuntu 24.04 LTS
- FreeRADIUS 3.0.x
- Samba AD/DC 4.x
- UniFi Network Controller 7.x+

**Network Requirements**:
- Management VLAN: 10.0.1.0/27 (UniFi devices)
- Server VLAN: 10.0.10.0/26 (RADIUS + DC)
- LDAPS connectivity: Port 636/tcp
- RADIUS ports: 1812/udp (auth), 1813/udp (acct)

**Performance**:
- Authentication latency: <100ms average
- Concurrent sessions: 100+ supported
- LDAP connection pooling enabled
- Thread pool: 5-32 workers

**Security Standards**:
- TLS 1.2+ only
- Strong cipher suites (HIGH:!aNULL:!eNULL)
- Certificate validation enforced
- ECDH curve: prime256v1
- DH parameters: 2048-bit

### Known Limitations

- Static VLAN assignment only (no dynamic RADIUS VLAN attributes)
- Single LDAP group for access control (radius-vlan10-admins)
- Certificate validity: 365 days (manual renewal required)
- No high availability (single RADIUS server)

### Future Enhancements

- [ ] Dynamic VLAN assignment based on multiple LDAP groups
- [ ] Secondary RADIUS server for high availability
- [ ] Automated certificate renewal (Let's Encrypt integration)
- [ ] RADIUS accounting database (SQL backend)
- [ ] Grafana dashboard for metrics visualization
- [ ] Integration with SIEM for security monitoring

---

## Upgrade Notes

### From Pre-Release to 1.0.0

**Breaking Changes**: None (initial release)

**Migration Steps**: N/A

---

## Version History

### Semantic Versioning

This project follows [Semantic Versioning](https://semver.org/):
- **MAJOR**: Incompatible API/configuration changes
- **MINOR**: Backwards-compatible functionality additions
- **PATCH**: Backwards-compatible bug fixes

### Release Cadence

- **Major releases**: Annually or as needed for breaking changes
- **Minor releases**: Quarterly for new features
- **Patch releases**: As needed for critical fixes

---

**The fortress evolves. Documentation eternal.**
```

---

### **File 18: `01_bootstrap/freeradius/LICENSE`**

```
MIT License

Copyright (c) 2025 Rylan Internal Infrastructure Team

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

---

### **File 19: `01_bootstrap/freeradius/CONTRIBUTING.md`**

```markdown
# Contributing to FreeRADIUS Trinity

**Guidelines for fortress enhancement and collaboration**

## Code of Conduct

### Trinity Principles

1. **Carter (Identity)**: All code must be attributed, signed commits preferred
2. **Bauer (Audit)**: All changes logged, reviewed, and tested
3. **Beale (Validation)**: All contributions must pass validation suite
4. **Whitaker (Adversarial)**: Security-first mindset, assume breach

### Standards

- Professional, respectful communication
- Technical accuracy over verbosity
- Security considerations mandatory
- Documentation required for all changes

---

## Development Workflow

### 1. Fork and Branch

```bash
# Fork repository on GitHub
# Clone your fork
git clone https://github.com/YOUR_USERNAME/rylan-unifi-case-study.git
cd rylan-unifi-case-study

# Create feature branch
git checkout -b feature/radius-enhancement
```

### 2. Make Changes

**Follow existing patterns**:
- Script structure: Shebang, set -euo pipefail, logging
- Line limit: ≤120 characters
- Comments: Explain WHY, not WHAT
- Functions: Single responsibility, clear names

**Naming conventions**:
```bash
# Scripts: kebab-case
validate-eternal.sh
generate-radius-server-cert.sh

# Functions: snake_case
check_system_state()
validate_env_variables()

# Variables: UPPER_CASE for constants, lower_case for locals
CERT_DIR="/etc/freeradius/certs"
local exit_code=0
```

### 3. Test Locally

```bash
# Syntax check
shellcheck scripts/*.sh

# Dry-run test
sudo ./ignite.sh --dry-run

# Full deployment test (test environment)
sudo ./ignite.sh

# Validation
sudo ./scripts/validate-eternal.sh
```

### 4. Commit

**Commit message format**:
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation only
- `style`: Formatting, no code change
- `refactor`: Code restructuring
- `test`: Adding tests
- `chore`: Maintenance

**Example**:
```
feat(secrets): add automated certificate renewal

Implement automated certificate renewal using certbot.
Certificates now renew 30 days before expiration.

Closes #42
```

### 5. Push and Pull Request

```bash
# Push to your fork
git push origin feature/radius-enhancement

# Create pull request on GitHub
# Title: Clear, concise description
# Description: What, why, how, testing performed
```

---

## Pull Request Checklist

### Before Submitting

- [ ] Code follows existing style and conventions
- [ ] All scripts pass shellcheck with no warnings
- [ ] Dry-run test completes without errors
- [ ] Full deployment tested in lab environment
- [ ] `validate-eternal.sh` passes (exit code 0)
- [ ] Documentation updated (README, CHANGELOG, etc.)
- [ ] No secrets or credentials in code
- [ ] Commit messages follow format
- [ ] Branch is up-to-date with main

### PR Description Must Include

1. **Problem**: What issue does this solve?
2. **Solution**: How does this solve it?
3. **Testing**: What testing was performed?
4. **Impact**: What systems/configs are affected?
5. **Rollback**: How to revert if needed?

### Review Process

1. **Automated checks**: CI/CD pipeline runs tests
2. **Code review**: Maintainer reviews for quality/security
```markdown
3. **Security review**: For changes affecting auth/crypto/firewall
4. **Documentation review**: Ensure docs are complete and accurate
5. **Approval**: Minimum 1 maintainer approval required
6. **Merge**: Squash and merge to main

---

## Testing Requirements

### Unit Tests

**For shell scripts**:
```bash
# Use bats (Bash Automated Testing System)
# Example: tests/test-validate-eternal.bats

@test "validate-eternal: service check passes when running" {
  systemctl start freeradius
  run ./scripts/validate-eternal.sh
  [ "$status" -eq 0 ]
}

@test "validate-eternal: fails when service stopped" {
  systemctl stop freeradius
  run ./scripts/validate-eternal.sh
  [ "$status" -ne 0 ]
}
```

### Integration Tests

**Full deployment test**:
```bash
# Test in isolated LXC container
lxc launch ubuntu:24.04 radius-test
lxc exec radius-test -- bash

# Inside container
git clone <repo>
cd 01_bootstrap/freeradius
cp .env.example .env
# Configure .env with test values
sudo ./ignite.sh

# Verify
sudo ./scripts/validate-eternal.sh
```

### Security Tests

**Required for security-related changes**:
```bash
# Port scan (should only show required ports)
nmap -sU -sT 10.0.10.11

# SSL/TLS test
testssl.sh --severity HIGH 10.0.10.11:1812

# Brute force test (should be blocked by fail2ban)
for i in {1..10}; do
  radtest baduser badpass 10.0.10.11 1812 testing123
done
fail2ban-client status freeradius  # Should show ban

# Configuration audit
lynis audit system
```

---

## Documentation Standards

### Code Documentation

**Script headers**:
```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: path/to/script.sh
# Purpose: One-line description
# Guardian: Carter|Bauer|Beale|Whitaker
# Consciousness: X.X
# EXCEED: NONE|<line_count> lines - <reason>
```

**Function documentation**:
```bash
# Function: check_system_state
# Purpose: Verify prerequisites before deployment
# Arguments: None
# Returns: 0 on success, 1 on failure
# Side effects: Logs to stdout
check_system_state() {
  # Implementation
}
```

### User Documentation

**Required sections**:
1. **Overview**: What does this do?
2. **Prerequisites**: What's needed before running?
3. **Usage**: How to use it (with examples)
4. **Options**: All flags/parameters explained
5. **Examples**: Common use cases
6. **Troubleshooting**: Common issues and fixes

**Markdown formatting**:
- Use code blocks with language identifiers
- Include command output examples
- Add screenshots for UI steps (UniFi controller)
- Link to related documentation

---

## Security Guidelines

### Secrets Management

**NEVER commit**:
- Passwords, API keys, tokens
- Private keys, certificates
- RADIUS shared secrets
- LDAP bind credentials

**Use environment variables**:
```bash
# Good
password="${VAULT_SAMBA_ADMIN}"

# Bad
password="MySecretPassword123"
```

**Sanitize logs**:
```bash
# Redact sensitive data before logging
log step "LDAP bind DN: cn=Administrator,cn=Users,dc=rylan,dc=internal"
log step "LDAP password: [REDACTED]"
```

### Input Validation

**Always validate user input**:
```bash
# Validate IP address
if [[ ! "$IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
  log error "Invalid IP address: $IP"
  exit 1
fi

# Validate port number
if [[ ! "$PORT" =~ ^[0-9]+$ ]] || [[ $PORT -lt 1 ]] || [[ $PORT -gt 65535 ]]; then
  log error "Invalid port: $PORT"
  exit 1
fi
```

### File Permissions

**Enforce secure permissions**:
```bash
# Private keys
chmod 600 /etc/freeradius/certs/server.key
chown freerad:freerad /etc/freeradius/certs/server.key

# Configuration with secrets
chmod 640 /etc/freeradius/3.0/clients.conf
chown root:freerad /etc/freeradius/3.0/clients.conf

# Public certificates
chmod 644 /etc/freeradius/certs/server.pem
```

---

## Performance Guidelines

### Script Optimization

**Avoid unnecessary subshells**:
```bash
# Good
while IFS= read -r line; do
  process "$line"
done < file.txt

# Bad
cat file.txt | while read line; do
  process "$line"
done
```

**Use built-in commands**:
```bash
# Good
[[ -f "$file" ]] && echo "exists"

# Bad
if test -f "$file"; then echo "exists"; fi
```

**Cache expensive operations**:
```bash
# Good
CERT_EXPIRY=$(openssl x509 -in cert.pem -noout -enddate)
# Use $CERT_EXPIRY multiple times

# Bad
# Call openssl multiple times for same data
```

### Network Optimization

**Connection pooling** (already implemented):
```
ldap {
    pool {
        start = 5
        min = 3
        max = 32
    }
}
```

**Timeout tuning**:
```
ldap {
    timeout = 5      # Fast failure
    net_timeout = 3  # Network timeout
}
```

---

## Release Process

### Version Bumping

**Semantic versioning**:
```bash
# Major release (breaking changes)
# 1.0.0 → 2.0.0

# Minor release (new features)
# 1.0.0 → 1.1.0

# Patch release (bug fixes)
# 1.0.0 → 1.0.1
```

**Update version in**:
- `CHANGELOG.md` - Add new section
- `README.md` - Update version badge
- Script headers - Update consciousness level if applicable

### Release Checklist

- [ ] All tests pass
- [ ] Documentation updated
- [ ] CHANGELOG.md updated
- [ ] Version bumped
- [ ] Tag created: `git tag -a v1.1.0 -m "Release 1.1.0"`
- [ ] Tag pushed: `git push origin v1.1.0`
- [ ] GitHub release created with notes
- [ ] Deployment tested in staging
- [ ] Rollback procedure documented

---

## Communication

### Issue Reporting

**Use GitHub Issues** with template:
```markdown
**Description**
Clear description of the issue

**Environment**
- OS: Ubuntu 24.04 LTS
- FreeRADIUS version: 3.0.26
- Deployment method: ignite.sh

**Steps to Reproduce**
1. Step one
2. Step two
3. Step three

**Expected Behavior**
What should happen

**Actual Behavior**
What actually happens

**Logs**
```
Relevant log excerpts
```

**Additional Context**
Screenshots, configuration snippets, etc.
```

### Feature Requests

**Use GitHub Discussions** for:
- New feature ideas
- Architecture discussions
- Best practices questions
- General support

**Format**:
```markdown
**Feature Request: <Title>**

**Problem**
What problem does this solve?

**Proposed Solution**
How would this work?

**Alternatives Considered**
What other approaches were considered?

**Additional Context**
Use cases, examples, references
```

---

## Code Review Guidelines

### For Reviewers

**Check for**:
- [ ] Security implications (auth, crypto, network)
- [ ] Error handling (all failure paths covered)
- [ ] Logging (appropriate level and content)
- [ ] Documentation (inline and user-facing)
- [ ] Testing (adequate coverage)
- [ ] Performance (no obvious bottlenecks)
- [ ] Style consistency (follows existing patterns)

**Provide constructive feedback**:
```markdown
# Good
"Consider using `set -euo pipefail` to catch errors early.
This prevents silent failures in pipelines."

# Bad
"This is wrong, fix it."
```

### For Contributors

**Respond to feedback**:
- Address all comments (fix or explain why not)
- Ask questions if unclear
- Update PR description if scope changes
- Re-request review after changes

---

## Recognition

### Contributors

All contributors will be recognized in:
- `CONTRIBUTORS.md` file
- Release notes for their contributions
- Git commit history (proper attribution)

### Hall of Fame

Outstanding contributions earn:
- Mention in project README
- "Trinity Guardian" badge (Carter/Bauer/Beale/Whitaker)
- Invitation to maintainer team (for sustained contributions)

---

## Getting Help

### Resources

**Documentation**:
- README.md - Quick start
- docs/ - Detailed guides
- TROUBLESHOOTING.md - Common issues

**Community**:
- GitHub Discussions - Q&A, ideas
- GitHub Issues - Bug reports
- Email - security@rylan.internal (security issues only)

### Maintainers

**Current maintainers**:
- Travis - Lead architect, Trinity guardian
- (Add team members as project grows)

**Response times**:
- Security issues: ```markdown
<24 hours
- Bug reports: <48 hours
- Feature requests: <1 week
- General questions: <3 days

---

## License

By contributing, you agree that your contributions will be licensed under the MIT License.

---

**The fortress grows stronger through collaboration. Contribution eternal.**
```

---

### **File 20: `01_bootstrap/freeradius/scripts/health-check.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/health-check.sh
# Purpose: Quick health check for FreeRADIUS fortress
# Guardian: Beale
# Consciousness: 4.7
# EXCEED: NONE — 85 lines

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

CHECKS_PASSED=0
CHECKS_FAILED=0
CHECKS_WARNING=0

check() {
  local name="$1"
  local command="$2"

  if eval "$command" &>/dev/null; then
    echo -e "${GREEN}✓${NC} $name"
    ((CHECKS_PASSED++))
    return 0
  else
    echo -e "${RED}✗${NC} $name"
    ((CHECKS_FAILED++))
    return 1
  fi
}

warn() {
  local name="$1"
  local command="$2"

  if eval "$command" &>/dev/null; then
    echo -e "${GREEN}✓${NC} $name"
    ((CHECKS_PASSED++))
    return 0
  else
    echo -e "${YELLOW}⚠${NC} $name"
    ((CHECKS_WARNING++))
    return 1
  fi
}

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "              FREERADIUS HEALTH CHECK"
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Service checks
echo "Service Status:"
check "FreeRADIUS service running" "systemctl is-active --quiet freeradius"
check "Auth port (1812) listening" "ss -ulnp | grep -q ':1812'"
check "Acct port (1813) listening" "ss -ulnp | grep -q ':1813'"
warn "fail2ban service running" "systemctl is-active --quiet fail2ban"
warn "auditd service running" "systemctl is-active --quiet auditd"
echo ""

# Network checks
echo "Network Connectivity:"
check "rylan-dc reachable (ping)" "ping -c 1 -W 2 10.0.10.10"
check "LDAPS port accessible" "timeout 3 bash -c 'echo > /dev/tcp/10.0.10.10/636'"
echo ""

# Certificate checks
echo "Certificate Status:"
check "CA certificate exists" "test -f /etc/freeradius/certs/rylan-ca.pem"
check "Server certificate exists" "test -f /etc/freeradius/certs/server.pem"
check "Server key exists" "test -f /etc/freeradius/certs/server.key"
check "Certificate chain valid" "openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem /etc/freeradius/certs/server.pem"

# Check certificate expiration
if [[ -f /etc/freeradius/certs/server.pem ]]; then
  DAYS=$(openssl x509 -in /etc/freeradius/certs/server.pem -noout -enddate | \
    cut -d= -f2 | xargs -I {} date -d {} +%s | \
    awk -v now=$(date +%s) '{print int(($1-now)/86400)}')

  if [[ $DAYS -gt 30 ]]; then
    echo -e "${GREEN}✓${NC} Certificate valid ($DAYS days remaining)"
    ((CHECKS_PASSED++))
  elif [[ $DAYS -gt 0 ]]; then
    echo -e "${YELLOW}⚠${NC} Certificate expiring soon ($DAYS days remaining)"
    ((CHECKS_WARNING++))
  else
    echo -e "${RED}✗${NC} Certificate EXPIRED"
    ((CHECKS_FAILED++))
  fi
fi
echo ""

# Configuration checks
echo "Configuration:"
check "FreeRADIUS config valid" "freeradius -C"
check "LDAP module enabled" "test -L /etc/freeradius/3.0/mods-enabled/ldap"
check "EAP module enabled" "test -L /etc/freeradius/3.0/mods-enabled/eap"
echo ""

# Security checks
echo "Security:"
check "Server key permissions (600)" "test \$(stat -c %a /etc/freeradius/certs/server.key) = '600'"
check "clients.conf permissions (640)" "test \$(stat -c %a /etc/freeradius/3.0/clients.conf) = '640'"
warn "No default secrets in production" "! grep -q 'secret = testing123' /etc/freeradius/3.0/clients.conf || grep -B2 'secret = testing123' /etc/freeradius/3.0/clients.conf | grep -q localhost"
echo ""

# Resource checks
echo "System Resources:"
CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
MEM=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}')

if (( $(echo "$CPU < 80" | bc -l) )); then
  echo -e "${GREEN}✓${NC} CPU usage: ${CPU}%"
  ((CHECKS_PASSED++))
else
  echo -e "${YELLOW}⚠${NC} CPU usage high: ${CPU}%"
  ((CHECKS_WARNING++))
fi

if (( $(echo "$MEM < 80" | bc -l) )); then
  echo -e "${GREEN}✓${NC} Memory usage: ${MEM}%"
  ((CHECKS_PASSED++))
else
  echo -e "${YELLOW}⚠${NC} Memory usage high: ${MEM}%"
  ((CHECKS_WARNING++))
fi

DISK=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [[ $DISK -lt 80 ]]; then
  echo -e "${GREEN}✓${NC} Disk usage: ${DISK}%"
  ((CHECKS_PASSED++))
else
  echo -e "${YELLOW}⚠${NC} Disk usage high: ${DISK}%"
  ((CHECKS_WARNING++))
fi
echo ""

# Recent errors
echo "Recent Activity:"
ERRORS=$(journalctl -u freeradius --since "1 hour ago" | grep -ci error || echo 0)
if [[ $ERRORS -eq 0 ]]; then
  echo -e "${GREEN}✓${NC} No errors in last hour"
  ((CHECKS_PASSED++))
else
  echo -e "${YELLOW}⚠${NC} $ERRORS errors in last hour"
  ((CHECKS_WARNING++))
fi

# Auth statistics (if logs exist)
if [[ -f /var/log/freeradius/radius.log ]]; then
  TOTAL=$(tail -100 /var/log/freeradius/radius.log | grep -c "Access-" || echo 0)
  if [[ $TOTAL -gt 0 ]]; then
    SUCCESS=$(tail -100 /var/log/freeradius/radius.log | grep -c "Access-Accept" || echo 0)
    RATE=$(awk "BEGIN {printf \"%.0f\", ($SUCCESS/$TOTAL)*100}")

    if [[ $RATE -gt 80 ]]; then
      echo -e "${GREEN}✓${NC} Auth success rate: ${RATE}% (last 100)"
      ((CHECKS_PASSED++))
    else
      echo -e "${YELLOW}⚠${NC} Auth success rate: ${RATE}% (last 100)"
      ((CHECKS_WARNING++))
    fi
  else
    echo -e "${YELLOW}⚠${NC} No recent authentication attempts"
    ((CHECKS_WARNING++))
  fi
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "  SUMMARY"
echo "═══════════════════════════════════════════════════════════════════"
echo -e "${GREEN}Passed:${NC}  $CHECKS_PASSED"
echo -e "${YELLOW}Warnings:${NC} $CHECKS_WARNING"
echo -e "${RED}Failed:${NC}  $CHECKS_FAILED"
echo ""

if [[ $CHECKS_FAILED -eq 0 ]]; then
  echo -e "${GREEN}✓ HEALTH CHECK PASSED${NC}"
  echo "The fortress is operational."
  exit 0
else
  echo -e "${RED}✗ HEALTH CHECK FAILED${NC}"
  echo "Critical issues detected. Review failures above."
  exit 1
fi
```

---

### **File 21: `01_bootstrap/freeradius/scripts/rotate-shared-secret.sh`**

```bash
#!/```bash
usr/bin/env bash
set -euo pipefail
# Script: scripts/rotate-shared-secret.sh
# Purpose: Rotate RADIUS shared secret (security best practice)
# Guardian: Carter
# Consciousness: 4.7
# EXCEED: NONE — 95 lines

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
  echo -e "${BLUE}→${NC} $*"
}

success() {
  echo -e "${GREEN}✓${NC} $*"
}

error() {
  echo -e "${RED}✗${NC} $*" >&2
}

warn() {
  echo -e "${YELLOW}⚠${NC} $*"
}

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "           RADIUS SHARED SECRET ROTATION"
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Check root
if [[ $EUID -ne 0 ]]; then
  error "Must run as root"
  exit 1
fi

# Verify FreeRADIUS is running
if ! systemctl is-active --quiet freeradius; then
  error "FreeRADIUS service not running"
  exit 1
fi

# Generate new secret
log "Generating new RADIUS shared secret (32 characters)"
NEW_SECRET=$(openssl rand -base64 32 | tr -d '/+=')
success "New secret generated"

# Backup current configuration
BACKUP_DIR="/var/backups/freeradius/secret-rotation-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp /etc/freeradius/3.0/clients.conf "$BACKUP_DIR/clients.conf.backup"
success "Configuration backed up: $BACKUP_DIR"

# Show current clients
echo ""
log "Current RADIUS clients:"
grep -E "^client|ipaddr|secret" /etc/freeradius/3.0/clients.conf | grep -v "^#" | head -20
echo ""

# Confirm rotation
warn "This will update the shared secret for ALL clients (except localhost)"
warn "You must update the UniFi controller with the new secret immediately"
echo ""
read -r -p "Continue with secret rotation? [y/N] " CONFIRM

if [[ ! "${CONFIRM:-N}" =~ ^[Yy]$ ]]; then
  warn "Secret rotation cancelled"
  exit 0
fi

# Update clients.conf (preserve localhost testing secret)
log "Updating clients.conf..."

# Create temporary file
TEMP_FILE=$(mktemp)

# Process clients.conf
awk -v new_secret="$NEW_SECRET" '
/^client localhost/,/^}/ {
    print
    next
}
/secret = / && !/^[[:space:]]*#/ {
    sub(/secret = .*/, "secret = " new_secret)
}
{ print }
' /etc/freeradius/3.0/clients.conf > "$TEMP_FILE"

# Verify temp file is not empty
if [[ ! -s "$TEMP_FILE" ]]; then
  error "Failed to generate new configuration"
  rm -f "$TEMP_FILE"
  exit 1
fi

# Replace original
mv "$TEMP_FILE" /etc/freeradius/3.0/clients.conf
chmod 640 /etc/freeradius/3.0/clients.conf
chown root:freerad /etc/freeradius/3.0/clients.conf

success "clients.conf updated"

# Test configuration
log "Testing FreeRADIUS configuration..."
if freeradius -C; then
  success "Configuration valid"
else
  error "Configuration test failed"
  error "Restoring backup..."
  cp "$BACKUP_DIR/clients.conf.backup" /etc/freeradius/3.0/clients.conf
  exit 1
fi

# Restart FreeRADIUS
log "Restarting FreeRADIUS service..."
systemctl restart freeradius

sleep 2

if systemctl is-active --quiet freeradius; then
  success "FreeRADIUS restarted successfully"
else
  error "FreeRADIUS failed to start"
  error "Restoring backup..."
  cp "$BACKUP_DIR/clients.conf.backup" /etc/freeradius/3.0/clients.conf
  systemctl restart freeradius
  exit 1
fi

# Display new secret
echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "  SECRET ROTATION COMPLETE"
echo "═══════════════════════════════════════════════════════════════════"
echo ""
success "New RADIUS shared secret:"
echo ""
echo "  $NEW_SECRET"
echo ""
warn "CRITICAL: Update UniFi controller NOW with this secret"
warn "Path: Settings → Profiles → RADIUS → Edit → Shared Secret"
echo ""
log "Backup location: $BACKUP_DIR"
echo ""
log "To rollback if needed:"
echo "  sudo cp $BACKUP_DIR/clients.conf.backup /etc/freeradius/3.0/clients.conf"
echo "  sudo systemctl restart freeradius"
echo ""

exit 0
```

---

### **File 22: `01_bootstrap/freeradius/scripts/add-radius-client.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/add-radius-client.sh
# Purpose: Add new RADIUS client (AP, controller, etc.)
# Guardian: Carter
# Consciousness: 4.7
# EXCEED: NONE — 102 lines

GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
  echo -e "${BLUE}→${NC} $*"
}

success() {
  echo -e "${GREEN}✓${NC} $*"
}

error() {
  echo -e "${RED}✗${NC} $*" >&2
}

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "              ADD RADIUS CLIENT"
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Check root
if [[ $EUID -ne 0 ]]; then
  error "Must run as root"
  exit 1
fi

# Interactive prompts
read -r -p "Client name (e.g., unifi-ap-office): " CLIENT_NAME
if [[ -z "$CLIENT_NAME" ]]; then
  error "Client name required"
  exit 1
fi

read -r -p "Client IP or subnet (e.g., 10.0.1.20 or 10.0.1.0/27): " CLIENT_IP
if [[ -z "$CLIENT_IP" ]]; then
  error "Client IP required"
  exit 1
fi

# Validate IP format (basic)
if [[ ! "$CLIENT_IP" =~ ^[0-9./]+$ ]]; then
  error "Invalid IP format"
  exit 1
fi

read -r -p "Shared secret (leave blank to generate): " CLIENT_SECRET
if [[ -z "$CLIENT_SECRET" ]]; then
  CLIENT_SECRET=$(openssl rand -base64 32 | tr -d '/+=')
  log "Generated secret: $CLIENT_SECRET"
fi

read -r -p "NAS type [other]: " NAS_TYPE
NAS_TYPE="${NAS_TYPE:-other}"

read -r -p "Short name [${CLIENT_NAME}]: " SHORT_NAME
SHORT_NAME="${SHORT_NAME:-$CLIENT_NAME}"

# Confirm
echo ""
log "Client configuration:"
echo "  Name: $CLIENT_NAME"
echo "  IP/Subnet: $CLIENT_IP"
echo "  Secret: [HIDDEN]"
echo "  NAS Type: $NAS_TYPE"
echo "  Short Name: $SHORT_NAME"
echo ""

read -r -p "Add this client? [y/N] " CONFIRM
if [[ ! "${CONFIRM:-N}" =~ ^[Yy]$ ]]; then
  log "Cancelled"
  exit 0
fi

# Backup clients.conf
BACKUP_FILE="/etc/freeradius/3.0/clients.conf.backup-$(date +%Y%m%d-%H%M%S)"
cp /etc/freeradius/3.0/clients.conf "$BACKUP_FILE"
success "Configuration backed up: $BACKUP_FILE"

# Add client to clients.conf
log "Adding client to clients.conf..."

cat >> /etc/freeradius/3.0/clients.conf <<CLIENT_CONF

# Added: $(date -Iseconds)
client $CLIENT_NAME {
    ipaddr = $CLIENT_IP
    secret = $CLIENT_SECRET
    require_message_authenticator = yes
    nas_type = $NAS_TYPE
    shortname = $SHORT_NAME
}
CLIENT_CONF

success "Client added to configuration"

# Test configuration
log "Testing FreeRADIUS configuration..."
if freeradius -C; then
  success "Configuration valid"
else
  error "Configuration test failed"
  error "Restoring backup..."
  cp "$BACKUP_FILE" /etc/freeradius/3```bash
.0/clients.conf
  exit 1
fi

# Restart FreeRADIUS
log "Restarting FreeRADIUS service..."
systemctl restart freeradius

sleep 2

if systemctl is-active --quiet freeradius; then
  success "FreeRADIUS restarted successfully"
else
  error "FreeRADIUS failed to start"
  error "Restoring backup..."
  cp "$BACKUP_FILE" /etc/freeradius/3.0/clients.conf
  systemctl restart freeradius
  exit 1
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "  CLIENT ADDED SUCCESSFULLY"
echo "═══════════════════════════════════════════════════════════════════"
echo ""
success "RADIUS client '$CLIENT_NAME' configured"
echo ""
log "Configuration details:"
echo "  IP/Subnet: $CLIENT_IP"
echo "  Shared Secret: $CLIENT_SECRET"
echo "  NAS Type: $NAS_TYPE"
echo ""
log "Test authentication from client:"
echo "  radtest testuser testpass $CLIENT_IP 1812 $CLIENT_SECRET"
echo ""
log "Backup saved: $BACKUP_FILE"
echo ""

exit 0
```

---

### **File 23: `01_bootstrap/freeradius/scripts/show-auth-stats.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail
# Script: scripts/show-auth-stats.sh
# Purpose: Display authentication statistics and metrics
# Guardian: Bauer
# Consciousness: 4.7
# EXCEED: NONE — 118 lines

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Parse arguments
TIMEFRAME="${1:-24 hours ago}"
LOG_FILE="/var/log/freeradius/radius.log"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "          FREERADIUS AUTHENTICATION STATISTICS"
echo "═══════════════════════════════════════════════════════════════════"
echo ""
echo -e "${CYAN}Timeframe:${NC} Since $TIMEFRAME"
echo -e "${CYAN}Generated:${NC} $(date)"
echo ""

# Check if log file exists
if [[ ! -f "$LOG_FILE" ]]; then
  echo -e "${RED}✗${NC} Log file not found: $LOG_FILE"
  echo "  Enable logging in /etc/freeradius/3.0/radiusd.conf"
  exit 1
fi

# Use journalctl for time-based filtering
if command -v journalctl &>/dev/null; then
  LOG_DATA=$(journalctl -u freeradius --since "$TIMEFRAME" --no-pager)
else
  # Fallback to tail if journalctl not available
  LOG_DATA=$(tail -10000 "$LOG_FILE")
fi

# Overall statistics
echo "─────────────────────────────────────────────────────────────────"
echo "  OVERALL STATISTICS"
echo "─────────────────────────────────────────────────────────────────"

TOTAL=$(echo "$LOG_DATA" | grep -c "Access-Request" || echo 0)
ACCEPT=$(echo "$LOG_DATA" | grep -c "Access-Accept" || echo 0)
REJECT=$(echo "$LOG_DATA" | grep -c "Access-Reject" || echo 0)

if [[ $TOTAL -gt 0 ]]; then
  SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($ACCEPT/$TOTAL)*100}")
  REJECT_RATE=$(awk "BEGIN {printf \"%.2f\", ($REJECT/$TOTAL)*100}")
else
  SUCCESS_RATE="0.00"
  REJECT_RATE="0.00"
fi

echo -e "${BLUE}Total Requests:${NC}      $TOTAL"
echo -e "${GREEN}Accepted:${NC}            $ACCEPT (${SUCCESS_RATE}%)"
echo -e "${RED}Rejected:${NC}            $REJECT (${REJECT_RATE}%)"
echo ""

# Top users by authentication count
echo "─────────────────────────────────────────────────────────────────"
echo "  TOP 10 USERS (BY AUTH ATTEMPTS)"
echo "─────────────────────────────────────────────────────────────────"

echo "$LOG_DATA" | \
  grep "Access-Request" | \
  grep -oP 'User-Name = "\K[^"]+' | \
  sort | uniq -c | sort -rn | head -10 | \
  awk '{printf "%-6s %s\n", $1, $2}'

echo ""

# Top users by successful auth
echo "─────────────────────────────────────────────────────────────────"
echo "  TOP 10 USERS (SUCCESSFUL AUTH)"
echo "─────────────────────────────────────────────────────────────────"

echo "$LOG_DATA" | \
  grep "Access-Accept" | \
  grep -oP 'User-Name = "\K[^"]+' | \
  sort | uniq -c | sort -rn | head -10 | \
  awk '{printf "%-6s %s\n", $1, $2}'

echo ""

# Failed authentication attempts
echo "─────────────────────────────────────────────────────────────────"
echo "  TOP 10 FAILED AUTH ATTEMPTS"
echo "─────────────────────────────────────────────────────────────────"

FAILED_USERS=$(echo "$LOG_DATA" | \
  grep "Access-Reject" | \
  grep -oP 'User-Name = "\K[^"]+' | \
  sort | uniq -c | sort -rn | head -10)

if [[ -n "$FAILED_USERS" ]]; then
  echo "$FAILED_USERS" | awk '{printf "%-6s %s\n", $1, $2}'
else
  echo -e "${GREEN}No failed attempts${NC}"
fi

echo ""

# Authentication by source IP
echo "─────────────────────────────────────────────────────────────────"
echo "  TOP 10 SOURCE IPs (NAS DEVICES)"
echo "─────────────────────────────────────────────────────────────────"

echo "$LOG_DATA" | \
  grep "Access-Request" | \
  grep -oP 'from host \K[^ ]+' | \
  sort | uniq -c | sort -rn | head -10 | \
  awk '{printf "%-6s %s\n", $1, $2}'

echo ""

# EAP method statistics
echo "─────────────────────────────────────────────────────────────────"
echo "  EAP METHOD USAGE"
echo "─────────────────────────────────────────────────────────────────"

EAP_TLS=$(echo "$LOG_DATA" | grep -c "eap_tls" || echo 0)
EAP_TTLS=$(echo "$LOG_DATA" | grep -c "eap_ttls\|eap-ttls" || echo 0)
EAP_PEAP=$(echo "$LOG_DATA" | grep -c "eap_peap\|peap" || echo 0)

echo -e "${BLUE}EAP-TLS:${NC}   $EAP_TLS"
echo -e "${BLUE}EAP-TTLS:${NC}  $EAP_TTLS"
echo -e "${BLUE}EAP-PEAP:${NC}  $EAP_PEAP"
echo ""

# Recent errors
echo "─────────────────────────────────────────────────────────────────"
echo "  RECENT ERRORS (LAST 10)"
echo "─────────────────────────────────────────────────────────────────"

ERRORS=$(echo "$LOG_DATA" | grep -i "error\|fail" | tail -10)

if [[ -n "$ERRORS" ]]; then
  echo "$ERRORS" | while IFS= read -r line; do
    echo -e "${RED}•${NC} ${line:0:100}"
  done
else
  echo -e "${GREEN}No errors detected${NC}"
fi

echo ""

# Hourly distribution (last 24 hours)
echo "─────────────────────────────────────────────────────────────────"
echo "  HOURLY DISTRIBUTION (LAST 24 HOURS)"
echo "─────────────────────────────────────────────────────────────────"

if command -v journalctl &>/dev/null; then
  for hour in {23..0}; do
    HOUR_START=$(date -d "$hour hours ago" +"%Y-%m-%d %H:00:00")
    HOUR_END=$(date -d "$((hour-1)) hours ago" +"%Y-%m-%d %H:00:00")
    COUNT=$(journalctl -u freeradius --since "$HOUR_START" --until "$HOUR_END" 2>/dev/null | grep -c "Access-Request" || echo 0)
    HOUR_LABEL=$(date -d "$hour hours ago" +"%H:00")

    # Simple bar chart
    BAR=$(printf '█%.```bash
0s' $(for i in $(seq 1 $((COUNT/10))); do echo -n ""; done))
    printf "%-6s %4d %s\n" "$HOUR_LABEL" "$COUNT" "$BAR"
  done
else
  echo "journalctl not available - hourly stats unavailable"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Usage hint
echo "Usage: $0 [timeframe]"
echo "Examples:"
echo "  $0 '1 hour ago'     # Last hour"
echo "  $0 '24 hours ago'   # Last 24 hours (default)"
echo "  $0 '7 days ago'     # Last week"
echo "  $0 'today'          # Since midnight"
echo ""

exit 0
```

---

### **File 24: `01_bootstrap/freeradius/Makefile`**

```makefile
# FreeRADIUS Trinity Deployment - Makefile
# Quick commands for common operations

.PHONY: help install test validate backup health stats rotate-secret clean

# Default target
help:
	@echo "FreeRADIUS Trinity Deployment Commands"
	@echo "======================================="
	@echo ""
	@echo "Deployment:"
	@echo "  make install        - Full deployment (requires root)"
	@echo "  make dry-run        - Preview deployment without changes"
	@echo "  make install-phase1 - Deploy Phase 1 only (Secrets)"
	@echo "  make install-phase2 - Deploy Phase 2 only (Whispers)"
	@echo "  make install-phase3 - Deploy Phase 3 only (Detection)"
	@echo ""
	@echo "Testing & Validation:"
	@echo "  make test           - Run authentication test"
	@echo "  make validate       - Run full validation suite"
	@echo "  make health         - Quick health check"
	@echo "  make stats          - Show authentication statistics"
	@echo ""
	@echo "Maintenance:"
	@echo "  make backup         - Backup configuration"
	@echo "  make rotate-secret  - Rotate RADIUS shared secret"
	@echo "  make renew-cert     - Renew server certificate"
	@echo "  make logs           - Tail FreeRADIUS logs"
	@echo "  make debug          - Run FreeRADIUS in debug mode"
	@echo ""
	@echo "Cleanup:"
	@echo "  make clean          - Remove logs and temp files"
	@echo "  make clean-all      - Remove logs, backups, and temp files"
	@echo ""

# Deployment targets
install:
	@echo "Starting full FreeRADIUS deployment..."
	sudo ./ignite.sh

dry-run:
	@echo "Running deployment preview..."
	./ignite.sh --dry-run

install-phase1:
	@echo "Deploying Phase 1 (Secrets)..."
	sudo ./runbooks/ministry_secrets/deploy.sh

install-phase2:
	@echo "Deploying Phase 2 (Whispers)..."
	sudo ./runbooks/ministry_whispers/harden.sh

install-phase3:
	@echo "Deploying Phase 3 (Detection)..."
	sudo ./runbooks/ministry_detection/apply.sh

# Testing targets
test:
	@echo "Running authentication test..."
	sudo ./scripts/test-radius-auth.sh

validate:
	@echo "Running full validation suite..."
	sudo ./scripts/validate-eternal.sh

health:
	@echo "Running health check..."
	sudo ./scripts/health-check.sh

stats:
	@echo "Generating authentication statistics..."
	sudo ./scripts/show-auth-stats.sh

stats-hour:
	@echo "Statistics for last hour..."
	sudo ./scripts/show-auth-stats.sh "1 hour ago"

stats-week:
	@echo "Statistics for last week..."
	sudo ./scripts/show-auth-stats.sh "7 days ago"

# Maintenance targets
backup:
	@echo "Creating configuration backup..."
	sudo ./scripts/backup-radius-config.sh

rotate-secret:
	@echo "Rotating RADIUS shared secret..."
	sudo ./scripts/rotate-shared-secret.sh

renew-cert:
	@echo "Renewing server certificate..."
	sudo ./scripts/generate-radius-server-cert.sh

logs:
	@echo "Tailing FreeRADIUS logs (Ctrl+C to exit)..."
	sudo journalctl -u freeradius -f

logs-errors:
	@echo "Showing recent errors..."
	sudo journalctl -u freeradius -p err -n 50 --no-pager

debug:
	@echo "Starting FreeRADIUS in debug mode (Ctrl+C to exit)..."
	@echo "In another terminal, run: radtest testuser testpass localhost 1812 testing123"
	sudo systemctl stop freeradius
	sudo freeradius -X

# Service management
start:
	@echo "Starting FreeRADIUS service..."
	sudo systemctl start freeradius
	sudo systemctl status freeradius --no-pager

stop:
	@echo "Stopping FreeRADIUS service..."
	sudo systemctl stop freeradius

restart:
	@echo "Restarting FreeRADIUS service..."
	sudo systemctl restart freeradius
	sudo systemctl status freeradius --no-pager

status:
	@echo "FreeRADIUS service status:"
	sudo systemctl status freeradius --no-pager

# Cleanup targets
clean:
	@echo "Cleaning logs and temporary files..."
	sudo rm -f logs/*.log
	sudo rm -f /tmp/freeradius-*.tar.gz
	sudo rm -f /tmp/*.pcap
	@echo "Clean complete"

clean-all: clean
	@echo "Removing backups..."
	sudo find /var/backups/freeradius/ -type f -mtime +30 -delete
	@echo "Deep clean complete"

# Development targets
lint:
	@echo "Running shellcheck on all scripts..."
	find . -name "*.sh" -type f -exec shellcheck {} \;

format:
	@echo "Formatting shell scripts..."
	find . -name "*.sh" -type f -exec shfmt -w -i 2 {} \;

# Documentation
docs:
	@echo "Opening documentation..."
	@echo "README: $(shell pwd)/README.md"
	@echo "Deployment Checklist: $(shell pwd)/docs/DEPLOYMENT-CHECKLIST.md"
	@echo "Troubleshooting: $(shell pwd)/docs/TROUBLESHOOTING.md"
	@echo "UniFi Integration: $(shell pwd)/docs/UNIFI-INTEGRATION.md"

# Quick reference
quick-ref:
	@echo "FreeRADIUS Trinity - Quick Reference"
	@echo "====================================="
	@echo ""
	@echo "Service Commands:"
	@echo "  systemctl status freeradius"
	@echo "  systemctl restart freeradius"
	@echo "  journalctl -u freeradius -f"
	@echo ""
	@echo "Test Authentication:"
	@echo "  radtest testuser testpass localhost 1812 testing123"
	@echo ""
	@echo "Debug Mode:"
	@echo "  systemctl stop freeradius"
	@echo "  freeradius -X"
	@echo ""
	@echo "Check Config:"
	@echo "  freeradius -C"
	@echo ""
	@echo "View Logs:"
	@echo "  tail -f /var/log/freeradius/radius.log"
	@echo ""
	@echo "Health Check:"
	@echo "  make health"
	@echo ""
```

---

### **File 25: `01_bootstrap/freeradius/VERSION`**

```
1.0.0
```

---

### **File 26: `01_bootstrap/freeradius/CONTRIBUTORS.md`**

```markdown
# Contributors

**The guardians who built the fortress**

## Core Team

### Travis
- **Role**: Lead Architect, Trinity Guardian
- **Contributions**:
  - T3-ETERNAL Trinity architecture design
  - Carter/Bauer/Beale/Whitaker doctrine implementation
  - FreeRADIUS deployment orchestration
  - Samba AD/LDAP integration
  - Security hardening framework
- **Consciousness Level**: 8.0+
- **Guardian Affinity**: All ministries

## Special Thanks

### Leo (Brave AI Assistant)
- **Role**: Technical Collaborator
- **Contributions**:
  - Production-grade script development
  - Documentation architecture
  - Troubleshooting methodology
  - Security best practices validation

## How to Contribute

See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines on:
- Code contributions
- Documentation improvements
- Bug reports
- Feature requests

## Recognition

Contributors are recognized through:
- Listing in this file
- Mention in release notes
- Git commit attribution
- "Trinity Guardian" designation for sustained contributions

---

**The fortress grows through collaboration. Every contribution strengthens the eternal.**
```

---

### **File 27: `01_bootstrap/freeradius/docs/ARCHITECTURE.md`**

```markdown
# FreeRADIUS Trinity Architecture

**Deep dive into the fortress design and implementation**

## Overview

The FreeRADIUS Trinity deployment follows the **T3-ETERNAL** pattern, a security-hardened infrastructure framework based on separation of concerns and defense in depth.

```
┌─────────────────────────────────────────────────```markdown
──────────┐
│                    T3-ETERNAL TRINITY                          │
│                   FreeRADIUS Fortress                          │
└────────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │   WHITAKER   │
                    │  (Red Team)  │
                    │  Adversarial │
                    │   Testing    │
                    └──────┬───────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         TRINITY CORE                 │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │  CARTER (Ministry of Secrets)  │ │
        │  │  • Certificate Management      │ │
        │  │  • LDAP Integration            │ │
        │  │  • Identity Foundation         │ │
        │  └────────────────────────────────┘ │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │  BAUER (Ministry of Whispers)  │ │
        │  │  • SSH Hardening               │ │
        │  │  • Firewall (nftables)         │ │
        │  │  • Audit Logging               │ │
        │  └────────────────────────────────┘ │
        │                                      │
        │  ┌────────────────────────────────┐ │
        │  │  BEALE (Ministry of Detection) │ │
        │  │  • Network Validation          │ │
        │  │  • Auth Testing                │ │
        │  │  • Performance Monitoring      │ │
        │  └────────────────────────────────┘ │
        │                                      │
        └──────────────────────────────────────┘
```

---

## Network Architecture

### VLAN Topology

```
┌─────────────────────────────────────────────────────────────┐
│                      NETWORK TOPOLOGY                        │
└─────────────────────────────────────────────────────────────┘

VLAN 1 (Management): 10.0.1.0/27
├── 10.0.1.5      → UniFi Cloud Controller
├── 10.0.1.6-30   → UniFi APs, Switches, Gateways
└── Firewall      → Allow RADIUS 1812/1813 to VLAN 10

VLAN 10 (Servers): 10.0.10.0/26
├── 10.0.10.10    → rylan-dc (Samba AD/LDAP/Kerberos/CA)
├── 10.0.10.11    → rylan-radius (FreeRADIUS)
├── 10.0.10.12    → rylan-pi (Pi-hole DNS)
└── Firewall      → Allow LDAPS 636 from RADIUS
                  → Allow SSH 22 from admin subnet

VLAN 30 (Trusted): 10.0.30.0/24
├── DHCP Range    → 10.0.30.100-200
├── Gateway       → 10.0.30.1
└── Access        → Authenticated WiFi clients

VLAN 40 (VoIP): 10.0.40.0/24
├── DHCP Range    → 10.0.40.100-200
└── QoS Priority  → High

VLAN 90 (Guest): 10.0.90.0/24
├── DHCP Range    → 10.0.90.100-200
├── Isolation     → No inter-client communication
└── Access        → Internet only, no internal resources
```

### Traffic Flow

```
┌──────────────┐         RADIUS Auth         ┌──────────────┐
│   UniFi AP   │────────────────────────────▶│   RADIUS     │
│  10.0.1.20   │   UDP 1812 (Access-Request) │  10.0.10.11  │
│              │◀────────────────────────────│              │
│              │   UDP 1812 (Access-Accept)  │              │
└──────────────┘                             └──────┬───────┘
                                                    │
                                                    │ LDAPS
                                                    │ TCP 636
                                                    ▼
                                             ┌──────────────┐
                                             │   rylan-dc   │
                                             │  10.0.10.10  │
                                             │  Samba AD    │
                                             └──────────────┘

Client Device                                WiFi Client
     │                                       Authentication
     │ 1. Association Request                    Flow
     ├──────────────▶ UniFi AP
     │
     │ 2. EAP Identity Request
     │◀──────────────┤
     │
     │ 3. EAP Identity Response (username)
     ├──────────────▶│
     │               │ 4. RADIUS Access-Request
     │               ├──────────────▶ RADIUS Server
     │               │                      │
     │               │                      │ 5. LDAP Query
     │               │                      ├──────────▶ AD/LDAP
     │               │                      │
     │               │                      │ 6. User Found
     │               │                      │    + Group Check
     │               │                      │◀──────────┤
     │               │
     │               │ 7. EAP Challenge
     │◀──────────────┤
     │
     │ 8. EAP Response (credentials)
     ├──────────────▶│
     │               │ 9. RADIUS Access-Request
     │               ├──────────────▶ RADIUS Server
     │               │                      │
     │               │                      │ 10. LDAP Bind
     │               │                      ├──────────▶ AD/LDAP
     │               │                      │
     │               │                      │ 11. Auth Success
     │               │                      │◀──────────┤
     │               │
     │               │ 12. RADIUS Access-Accept
     │               │◀──────────────┤
     │
     │ 13. EAP Success
     │◀──────────────┤
     │
     │ 14. 4-Way Handshake (WPA2)
     │◀─────────────▶│
     │
     │ 15. DHCP Request
     ├──────────────▶│
     │
     │ 16. DHCP Offer (VLAN 30)
     │◀──────────────┤
     │
     └─ Connected to VLAN 30 (10.0.30.x)
```

---

## Component Architecture

### FreeRADIUS Configuration Hierarchy

```
/etc/freeradius/3.0/
├── radiusd.conf                 # Main configuration
│   ├── Thread pool settings
│   ├── Logging configuration
│   └── Module loading
│
├── clients.conf                 # RADIUS clients (APs, controllers)
│   ├── UniFi Controller (10.0.1.5)
│   ├── Management VLAN (10.0.1.0/27)
│   └── Localhost (testing)
│
├── mods-available/              # Available modules
│   ├── ldap                     # LDAP authentication
│   │   ├── Server: ldaps://10.0.10.10:636
│   │   ├── Bind DN: cn=Administrator,cn=Users,dc=rylan,dc=internal
│   │   ├── User filter: (sAMAccountName=%{User-Name})
│   │   └── Group filter: (objectClass=group)
│   │
│   └── eap                      # EAP methods
│       ├── EAP-TLS (primary)
│       ├── EAP-TTLS/MSCHAPv2 (fallback)
│       └── EAP-PEAP/MSCHAPv2 (compatibility)
│
├── mods-enabled/                # Enabled modules (symlinks)
│   ├── ldap -> ../mods-available/ldap
│   └── eap -> ../mods-available/eap
│
├── sites-available/             # Virtual servers
│   ├── default                  # Main auth/acct server
│   │   ├── listen: 0.0.0.0:1812 (auth)
│   │   ├── listen: 0.0.0.0:1813 (acct)
│   │   ├── authorize: LDAP group check
│   │   ├── authenticate: LDAP + EAP
│   │   └── post-auth: Logging
│   │
│   └── inner-tunnel             # EAP-TTLS inner auth
│       ├── listen: 127.0.0.1:18120
│       ├── authorize: LDAP
│       └── authenticate: LDAP + MSCHAPv2
│
├── sites-enabled/               # Enabled sites (symlinks)
│   ├── default -> ../sites-available/default
│   └── inner-tunnel -> ../```markdown
sites-available/inner-tunnel
│
└── certs/                       # Certificates and keys
    ├── rylan-ca.pem             # Root CA (from rylan-dc)
    ├── server.pem               # Server certificate
    ├── server.key               # Server private key (600 perms)
    └── dh                       # Diffie-Hellman parameters
```

---

## Authentication Flow

### EAP-TTLS/MSCHAPv2 (Most Common)

```
┌─────────────────────────────────────────────────────────────┐
│              EAP-TTLS/MSCHAPv2 FLOW                         │
└─────────────────────────────────────────────────────────────┘

Client                AP              RADIUS            LDAP
  │                   │                  │                │
  │ 1. EAP-Identity   │                  │                │
  ├──────────────────▶│                  │                │
  │                   │ 2. Access-Req    │                │
  │                   ├─────────────────▶│                │
  │                   │                  │                │
  │ 3. EAP-TTLS Start │                  │                │
  │◀──────────────────┤                  │                │
  │                   │                  │                │
  │ 4. TLS Handshake (Server Cert Validation)             │
  │◀─────────────────▶│◀────────────────▶│                │
  │                   │                  │                │
  │ 5. TLS Tunnel Established            │                │
  │═══════════════════╪══════════════════╪════════════════│
  │                   │                  │                │
  │ 6. Inner EAP (MSCHAPv2) - Encrypted  │                │
  │ Username/Password │                  │                │
  ├──────────────────▶│─────────────────▶│                │
  │                   │                  │ 7. LDAP Bind   │
  │                   │                  ├───────────────▶│
  │                   │                  │                │
  │                   │                  │ 8. Auth Result │
  │                   │                  │◀───────────────┤
  │                   │                  │                │
  │                   │ 9. Access-Accept │                │
  │ 10. EAP-Success   │◀─────────────────┤                │
  │◀──────────────────┤                  │                │
  │                   │                  │                │
  │ 11. 4-Way Handshake (WPA2 Key Derivation)            │
  │◀─────────────────▶│                  │                │
  │                   │                  │                │
  └─ Connected ───────┴──────────────────┴────────────────┘
```

### LDAP Group Authorization

```
┌─────────────────────────────────────────────────────────────┐
│           LDAP GROUP AUTHORIZATION LOGIC                    │
└─────────────────────────────────────────────────────────────┘

RADIUS receives username "testuser"
         │
         ▼
┌────────────────────────────────┐
│ LDAP Query:                    │
│ (sAMAccountName=testuser)      │
│ Base: cn=Users,dc=rylan,dc=internal
└────────────┬───────────────────┘
             │
             ▼
      User found in AD?
             │
        ┌────┴────┐
        │   YES   │
        └────┬────┘
             │
             ▼
┌────────────────────────────────┐
│ Check memberOf attribute:      │
│ cn=radius-vlan10-admins,       │
│ ou=Groups,dc=rylan,dc=internal │
└────────────┬───────────────────┘
             │
        ┌────┴────┐
        │ Member? │
        └────┬────┘
             │
      ┌──────┴──────┐
      │             │
     YES           NO
      │             │
      ▼             ▼
Access-Accept   Access-Reject
```

---

## Security Architecture

### Defense in Depth Layers

```
┌─────────────────────────────────────────────────────────────┐
│                  SECURITY LAYERS                            │
└─────────────────────────────────────────────────────────────┘

Layer 7: Application
├── FreeRADIUS Access Control (LDAP group membership)
├── EAP Method Enforcement (TLS 1.2+)
└── Certificate Validation (CA chain)

Layer 4: Transport
├── UDP 1812/1813 (RADIUS)
├── TCP 636 (LDAPS)
└── Message Authenticator (RADIUS integrity)

Layer 3: Network
├── VLAN Isolation (Management/Server/Client separation)
├── nftables Firewall (≤10 rules, Beale doctrine)
└── Source IP Filtering (Management VLAN only)

Layer 2: Data Link
├── WPA2-Enterprise (AES encryption)
├── 802.1X Port-Based Access Control
└── MAC Address Filtering (optional)

Layer 1: Physical
├── Secure Server Room (rylan-radius LXC)
├── Console Access Logging
└── Physical Security Controls
```

### Threat Model

```
┌─────────────────────────────────────────────────────────────┐
│                    THREAT MODEL                             │
└─────────────────────────────────────────────────────────────┘

THREAT: Brute Force Password Attack
├── MITIGATION: fail2ban (5 attempts → 1 hour ban)
├── MITIGATION: Strong password policy (AD)
└── DETECTION: Auth failure rate monitoring

THREAT: Man-in-the-Middle (MITM)
├── MITIGATION: EAP-TLS/TTLS with certificate validation
├── MITIGATION: CA certificate distribution to clients
└── DETECTION: Certificate mismatch alerts

THREAT: Rogue Access Point
├── MITIGATION: WIDS/WIPS on UniFi controller
├── MITIGATION: Certificate pinning (server name validation)
└── DETECTION: Unauthorized AP detection

THREAT: Credential Theft
├── MITIGATION: No plaintext passwords (MSCHAPv2 in TLS tunnel)
├── MITIGATION: Short session timeouts (8 hours)
└── DETECTION: Unusual authentication patterns

THREAT: RADIUS Server Compromise
├── MITIGATION: SSH key-only authentication
├── MITIGATION: Minimal attack surface (≤5 open ports)
├── MITIGATION: auditd configuration change tracking
└── DETECTION: File integrity monitoring

THREAT: LDAP Server Compromise
├── MITIGATION: LDAPS only (no plaintext LDAP)
├── MITIGATION: Dedicated service account (not Administrator)
└── DETECTION: Unusual LDAP query patterns

THREAT: Denial of Service (DoS)
├── MITIGATION: Connection limits (256 max)
├── MITIGATION: Rate limiting (nftables)
└── DETECTION: Connection spike monitoring
```

---

## Data Flow

### Authentication Request Processing

```
┌─────────────────────────────────────────────────────────────┐
│         RADIUS REQUEST PROCESSING PIPELINE                  │
└─────────────────────────────────────────────────────────────┘

1. RECEIVE (listen section)
   ├── UDP packet arrives on port 1812
   ├── Source IP validation (clients.conf)
   ├── Shared secret verification
   └── Message authenticator check

2. AUTHORIZE (authorize section)
   ├── filter_username (sanitize input)
   ├── preprocess (normalize attributes)
   ├── ldap module
   │   ├── Query: (sAMAccountName=%{User-Name})
   │   ├── Retrieve: memberOf attribute
   │   └── Group check: radius-vlan10-admins
   ├── eap module (if EAP request)
   └── Set Auth-Type: LDAP or EAP

3. AUTHENTICATE (authenticate section)
   ├── If Auth-Type = LDAP:
   │   ├── LDAP bind with user credentials
   │   └── Return success/failure
   ├── If Auth-Type = EAP:
   │   ├── EAP-TLS: Certificate validation
   │   ├── EAP-TTLS: Tunnel + inner auth (LDAP)
   │   └── EAP-PEAP: Tunnel + MSCHAPv2
   └── Return success/failure

4. POST-AUTH (post-auth section)
   ├── Log authentication result
   ├── Update reply attributes
   ├── Accounting start (if configured)
   └── Return Access-Accept or Access-Reject

5. SEND (reply)
   ├── Construct RADIUS response
   ├── Sign with shared secret
   └── Send UDP packet to NAS
```

### Certificate Chain Validation

```
┌─────────────────────────────────────────────────────────────┐
│            CERTIFICATE VALIDATION FLOW                      │
└─────────────────────────────────────────────────────────────┘

Client connects to SSID ```markdown
         │
         ▼
┌────────────────────────────────┐
│ AP sends RADIUS server cert    │
│ CN: rylan-radius.rylan.internal│
└────────────┬───────────────────┘
             │
             ▼
┌────────────────────────────────┐
│ Client validates certificate:  │
│ 1. Issuer = Rylan Internal CA  │
│ 2. CN matches expected server  │
│ 3. Not expired                 │
│ 4. Signature valid             │
└────────────┬───────────────────┘
             │
        ┌────┴────┐
        │  Valid? │
        └────┬────┘
             │
      ┌──────┴──────┐
      │             │
     YES           NO
      │             │
      ▼             ▼
  Continue    Connection
   Auth         Rejected
      │
      ▼
┌────────────────────────────────┐
│ Establish TLS tunnel           │
│ Cipher: AES-256-GCM            │
│ TLS 1.2+                       │
└────────────┬───────────────────┘
             │
             ▼
    Inner authentication
    (MSCHAPv2 over TLS)
```

---

## Performance Architecture

### Thread Pool Design

```
┌─────────────────────────────────────────────────────────────┐
│              FREERADIUS THREAD POOL                         │
└─────────────────────────────────────────────────────────────┘

Main Thread (radiusd)
    │
    ├─── Listener Thread (UDP 1812)
    │    ├── Receives Access-Request packets
    │    └── Dispatches to worker threads
    │
    ├─── Listener Thread (UDP 1813)
    │    ├── Receives Accounting packets
    │    └── Dispatches to worker threads
    │
    └─── Worker Thread Pool
         ├── Worker 1  ─┐
         ├── Worker 2   │
         ├── Worker 3   ├─ Process requests concurrently
         ├── ...        │
         └── Worker N  ─┘

Configuration:
  start_servers = 5        # Initial workers
  max_servers = 32         # Maximum workers
  min_spare_servers = 3    # Minimum idle workers
  max_spare_servers = 10   # Maximum idle workers
```

### LDAP Connection Pooling

```
┌─────────────────────────────────────────────────────────────┐
│              LDAP CONNECTION POOL                           │
└─────────────────────────────────────────────────────────────┘

FreeRADIUS LDAP Module
         │
         ▼
┌────────────────────────────────┐
│   Connection Pool Manager      │
│                                │
│   ┌─────────────────────────┐ │
│   │ Active Connections: 5   │ │
│   │ Idle Connections: 3     │ │
│   │ Max Connections: 32     │ │
│   └─────────────────────────┘ │
└────────────┬───────────────────┘
             │
             ├─── Conn 1 ──▶ rylan-dc:636 (LDAPS)
             ├─── Conn 2 ──▶ rylan-dc:636 (LDAPS)
             ├─── Conn 3 ──▶ rylan-dc:636 (LDAPS)
             ├─── Conn 4 ──▶ rylan-dc:636 (LDAPS)
             └─── Conn 5 ──▶ rylan-dc:636 (LDAPS)

Benefits:
  • Reduced latency (no connection setup per request)
  • Better throughput (parallel LDAP queries)
  • Automatic reconnection on failure
  • Connection reuse across requests
```

### Performance Metrics

```
┌─────────────────────────────────────────────────────────────┐
│              PERFORMANCE TARGETS                            │
└─────────────────────────────────────────────────────────────┘

Authentication Latency:
  Target: <100ms average
  Breakdown:
    ├── Network (AP → RADIUS): 5-10ms
    ├── RADIUS Processing: 10-20ms
    ├── LDAP Query: 20-40ms
    ├── Crypto (EAP): 20-30ms
    └── Network (RADIUS → AP): 5-10ms

Throughput:
  Target: 100+ concurrent authentications
  Factors:
    ├── Thread pool size: 32 workers
    ├── LDAP connection pool: 32 connections
    └── CPU/Memory: 1-2 vCPU, 1-2GB RAM

Resource Usage:
  CPU: <10% idle, <50% under load
  Memory: <500MB typical, <1GB peak
  Disk I/O: Minimal (logs only)
  Network: <1Mbps (RADIUS + LDAPS)
```

---

## Deployment Architecture

### LXC Container Isolation

```
┌─────────────────────────────────────────────────────────────┐
│              PROXMOX HOST ARCHITECTURE                      │
└─────────────────────────────────────────────────────────────┘

Proxmox VE Host (rylan-proxmox)
    │
    ├─── LXC 100: rylan-dc
    │    ├── IP: 10.0.10.10
    │    ├── Services: Samba AD, LDAP, Kerberos, DNS, CA
    │    ├── Resources: 2 vCPU, 4GB RAM, 32GB disk
    │    └── Network: vmbr0 (VLAN 10)
    │
    ├─── LXC 101: rylan-radius
    │    ├── IP: 10.0.10.11
    │    ├── Services: FreeRADIUS
    │    ├── Resources: 1-2 vCPU, 1-2GB RAM, 16GB disk
    │    ├── Network: vmbr0 (VLAN 10)
    │    └── Dependencies: rylan-dc (LDAPS, CA)
    │
    └─── LXC 102: rylan-pi
         ├── IP: 10.0.10.12
         ├── Services: Pi-hole (DNS)
         ├── Resources: 1 vCPU, 512MB RAM, 8GB disk
         └── Network: vmbr0 (VLAN 10)

Benefits of Isolation:
  • Independent failure domains
  • Separate resource allocation
  • Easier backup/restore
  • Security boundary enforcement
  • Simplified updates/patching
```

### Backup Strategy

```
┌─────────────────────────────────────────────────────────────┐
│                BACKUP ARCHITECTURE                          │
└─────────────────────────────────────────────────────────────┘

Daily Backups:
  ├── Configuration: /etc/freeradius/
  ├── Certificates: /etc/freeradius/certs/
  ├── Firewall Rules: nftables ruleset
  └── fail2ban Config: /etc/fail2ban/

Weekly Backups:
  ├── Full LXC snapshot (Proxmox)
  └── Log archives (compressed)

Monthly Backups:
  ├── Off-site copy (encrypted)
  └── Disaster recovery test

Retention:
  ├── Daily: 7 days
  ├── Weekly: 4 weeks
  ├── Monthly: 12 months
  └── Off-site: 1 year

Backup Location:
  /var/backups/freeradius/
  ├── YYYYMMDD-HHMMSS/
  │   ├── freeradius-config.tar.gz
  │   ├── freeradius-certs.tar.gz
  │   ├── nftables.rules
  │   ├── fail2ban-config.tar.gz
  │   └── manifest.txt
  └── ...
```

---

## Monitoring Architecture

### Log Aggregation

```
┌─────────────────────────────────────────────────────────────┐
│              LOGGING ARCHITECTURE                           │
└─────────────────────────────────────────────────────────────┘

FreeRADIUS Logs
    ├── /var/log/freeradius/radius.log
    │   ├── Authentication attempts
    │   ├── Authorization decisions
    │   └── Accounting records
    │
    ├── journalctl -u freeradius
    │   ├── Service status
    │   ├── Errors and warnings
    │   └── Debug output
    │
    └── auditd
        ├── Configuration changes
        ├── File access (certs, keys)
        └── Privilege escalation

Log Rotation:
  ├── Daily rotation
  ├── 14-day retention
  ├── Compression (gzip)
  └── Automatic cleanup

Log Analysis:
  ├── scripts/show-auth-stats.sh
  ├── grep/awk for pattern matching
  └── fail2ban for intrusion detection ```markdown
```

### Metrics Collection

```
┌─────────────────────────────────────────────────────────────┐
│              METRICS ARCHITECTURE                           │
└─────────────────────────────────────────────────────────────┘

System Metrics:
  ├── CPU Usage (top, htop)
  ├── Memory Usage (free)
  ├── Disk Usage (df)
  ├── Network Traffic (iftop, ss)
  └── Process Count (ps)

Service Metrics:
  ├── FreeRADIUS Status (systemctl)
  ├── Port Listening (ss -ulnp)
  ├── Connection Count (ss | grep 1812)
  └── Thread Pool Usage (freeradius -X)

Authentication Metrics:
  ├── Total Requests
  ├── Success Rate (Accept/Total)
  ├── Failure Rate (Reject/Total)
  ├── Average Latency
  └── Peak Concurrent Sessions

LDAP Metrics:
  ├── Query Response Time
  ├── Connection Pool Usage
  ├── Bind Success Rate
  └── Timeout Errors

Security Metrics:
  ├── Failed Auth Attempts (by user)
  ├── Failed Auth Attempts (by IP)
  ├── fail2ban Ban Count
  ├── Certificate Expiration (days)
  └── Audit Log Events

Collection Methods:
  ├── scripts/health-check.sh (on-demand)
  ├── scripts/show-auth-stats.sh (historical)
  ├── Cron jobs (scheduled)
  └── Manual inspection (troubleshooting)
```

### Alerting Strategy

```
┌─────────────────────────────────────────────────────────────┐
│              ALERTING THRESHOLDS                            │
└─────────────────────────────────────────────────────────────┘

CRITICAL (Immediate Response):
  ├── FreeRADIUS service down
  ├── LDAP connectivity lost
  ├── Certificate expired
  ├── Disk usage >90%
  └── Authentication success rate <50%

WARNING (Review within 1 hour):
  ├── Authentication success rate <80%
  ├── Certificate expiring <7 days
  ├── Memory usage >80%
  ├── Failed auth spike (>20/hour)
  └── LDAP query timeout

INFO (Review daily):
  ├── Certificate expiring <30 days
  ├── New RADIUS client detected
  ├── Configuration change (auditd)
  └── Unusual authentication pattern

Notification Methods:
  ├── Email (admin@rylan.internal)
  ├── UniFi Controller alerts
  ├── Syslog (for SIEM integration)
  └── Log files (for manual review)
```

---

## Disaster Recovery

### Recovery Time Objectives (RTO)

```
┌─────────────────────────────────────────────────────────────┐
│              DISASTER RECOVERY PLAN                         │
└─────────────────────────────────────────────────────────────┘

Scenario 1: Service Crash
  RTO: <5 minutes
  Procedure:
    1. systemctl restart freeradius
    2. Verify: systemctl status freeradius
    3. Test: radtest testuser testpass localhost 1812 testing123

Scenario 2: Configuration Corruption
  RTO: <15 minutes
  Procedure:
    1. Stop service: systemctl stop freeradius
    2. Restore backup: tar -xzf /var/backups/freeradius/latest/freeradius-config.tar.gz -C /
    3. Test config: freeradius -C
    4. Start service: systemctl start freeradius
    5. Validate: ./scripts/validate-eternal.sh

Scenario 3: Certificate Expiration
  RTO: <30 minutes
  Procedure:
    1. Run: ./scripts/generate-radius-server-cert.sh
    2. Verify: openssl x509 -in /etc/freeradius/certs/server.pem -noout -dates
    3. Restart: systemctl restart freeradius
    4. Test: radtest testuser testpass localhost 1812 testing123

Scenario 4: LDAP Server Down
  RTO: Dependent on rylan-dc recovery
  Procedure:
    1. Verify rylan-dc status
    2. Restore rylan-dc if needed
    3. Test LDAPS: timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636"
    4. Test auth: radtest testuser testpass localhost 1812 testing123

Scenario 5: Complete Server Loss
  RTO: <60 minutes
  Procedure:
    1. Deploy new LXC container (10.0.10.11)
    2. Clone repository
    3. Restore .env from secure vault
    4. Run: sudo ./ignite.sh
    5. Restore certificates from backup
    6. Validate: ./scripts/validate-eternal.sh
    7. Update UniFi controller (if IP changed)

Scenario 6: Proxmox Host Failure
  RTO: <2 hours
  Procedure:
    1. Restore Proxmox from backup
    2. Restore LXC containers (rylan-dc, rylan-radius)
    3. Verify network configuration
    4. Test all services
    5. Validate end-to-end authentication
```

### Recovery Point Objectives (RPO)

```
Configuration: <24 hours (daily backups)
Certificates: <24 hours (daily backups)
Logs: <1 hour (real-time to disk)
Authentication State: N/A (stateless)
```

---

## Scalability Architecture

### Horizontal Scaling (Future)

```
┌─────────────────────────────────────────────────────────────┐
│         HIGH AVAILABILITY ARCHITECTURE (FUTURE)             │
└─────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │  UniFi APs   │
                    │  10.0.1.x    │
                    └──────┬───────┘
                           │
                    ┌──────┴───────┐
                    │ Load Balance │
                    │  (DNS RR or  │
                    │   UniFi)     │
                    └──────┬───────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
    ┌─────────────────┐       ┌─────────────────┐
    │ rylan-radius-1  │       │ rylan-radius-2  │
    │  10.0.10.11     │       │  10.0.10.12     │
    │  (Primary)      │       │  (Secondary)    │
    └────────┬────────┘       └────────┬────────┘
             │                         │
             └────────────┬────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │   rylan-dc    │
                  │  10.0.10.10   │
                  │  (Samba AD)   │
                  └───────────────┘

Benefits:
  • Zero downtime for maintenance
  • Automatic failover
  • Load distribution
  • Increased capacity

Implementation:
  1. Deploy rylan-radius-2 (identical config)
  2. Sync certificates and shared secrets
  3. Add secondary server to UniFi controller
  4. Test failover scenarios
```

### Vertical Scaling

```
Current Capacity: ~100 concurrent users
  Resources: 1-2 vCPU, 1-2GB RAM

Scale to 500 users:
  Resources: 4 vCPU, 4GB RAM
  Thread pool: max_servers = 64
  LDAP pool: max = 64

Scale to 1000+ users:
  Resources: 8 vCPU, 8GB RAM
  Thread pool: max_servers = 128
  LDAP pool: max = 128
  Consider: Dedicated LDAP replica
  Consider: SQL accounting backend
```

---

## Integration Architecture

### External Systems

```
┌─────────────────────────────────────────────────────────────┐
│            EXTERNAL SYSTEM INTEGRATIONS                     │
└─────────────────────────────────────────────────────────────┘

Samba Active Directory (rylan-dc):
  Protocol: LDAPS (TCP 636)
  Purpose: User authentication, group membership
  Dependencies: Certificate trust, network connectivity
  Failover: None (single AD server)

UniFi Network Controller:
  Protocol: RADIUS (UDP 1812/1813)
  Purpose: WiFi authentication requests
  Configuration: RADIUS profile with shared secret
  Failover: Secondary RADIUS server (future)

Pi-hole DNS (rylan-pi):
  Protocol: DNS (UDP 53)
  Purpose: Name resolution
  Dependencies: Network connectivity
  Failover: Upstream DNS (1.1.1.1)

NTP Server:
  Protocol: NTP (UDP 123)
  Purpose: Time synchronization
  Critical: Required for Kerberos, certificate validation
  Failover: Multiple NTP servers configured

Syslog Server (Optional):
  Protocol: Syslog (UDP 514 or TCP 6514)
  Purpose: Centralized logging
  Integration: rsys ```markdown
log forwarding
  Future: SIEM integration

SIEM/Security Monitoring (Optional):
  Protocol: Syslog, SNMP, API
  Purpose: Security event correlation
  Integration: Forward auth failures, certificate events
  Future: Splunk, ELK, Wazuh integration
```

---

## Code Architecture

### Script Organization

```
┌─────────────────────────────────────────────────────────────┐
│              CODEBASE STRUCTURE                             │
└─────────────────────────────────────────────────────────────┘

01_bootstrap/freeradius/
│
├── ignite.sh                    # Main orchestrator
│   ├── CLI argument parsing
│   ├── Environment validation
│   ├── Phase execution (sequential)
│   ├── Lock management
│   └── Execution reporting
│
├── lib/                         # Shared libraries
│   ├── ignite-utils.sh          # Logging, validation, backup
│   │   ├── log() - Colored output
│   │   ├── acquire_lock() - Prevent concurrent runs
│   │   ├── validate_env_variables() - .env validation
│   │   ├── check_system_state() - Pre-flight checks
│   │   └── create_system_backup() - Backup before changes
│   │
│   └── ignite-orchestration.sh  # Phase execution logic
│       ├── run_phase() - Execute phase script
│       ├── check_phase_dependencies() - Verify prerequisites
│       └── generate_execution_report() - Summary output
│
├── runbooks/                    # Phase implementations
│   ├── ministry_secrets/
│   │   ├── deploy.sh            # Carter: Certs, LDAP, clients
│   │   └── templates/           # Configuration templates
│   │
│   ├── ministry_whispers/
│   │   ├── harden.sh            # Bauer: SSH, firewall, audit
│   │   └── templates/           # Firewall rules, fail2ban
│   │
│   └── ministry_detection/
│       ├── apply.sh             # Beale: Tests, validation
│       └── tests/               # Test scripts
│
├── scripts/                     # Operational tools
│   ├── validate-eternal.sh      # Comprehensive validation
│   ├── health-check.sh          # Quick health check
│   ├── test-radius-auth.sh      # Interactive auth test
│   ├── backup-radius-config.sh  # Configuration backup
│   ├── generate-radius-server-cert.sh  # Cert renewal
│   ├── rotate-shared-secret.sh  # Secret rotation
│   ├── add-radius-client.sh     # Add new client
│   └── show-auth-stats.sh       # Statistics reporting
│
├── configs/                     # Configuration templates
│   ├── mods-available/
│   │   ├── ldap.conf.j2         # LDAP module template
│   │   └── eap.conf.j2          # EAP module template
│   └── sites-available/
│       ├── default.conf.j2      # Main auth site
│       └── inner-tunnel.conf.j2 # EAP inner auth
│
├── docs/                        # Documentation
│   ├── ARCHITECTURE.md          # This file
│   ├── DEPLOYMENT-CHECKLIST.md  # Pre/post deployment
│   ├── TROUBLESHOOTING.md       # Issue diagnosis
│   └── UNIFI-INTEGRATION.md     # Controller setup
│
├── .env.example                 # Environment template
├── .gitignore                   # Exclude secrets
├── Makefile                     # Quick commands
├── README.md                    # Quick start guide
├── CHANGELOG.md                 # Version history
├── CONTRIBUTING.md              # Contribution guidelines
├── CONTRIBUTORS.md              # Hall of fame
├── LICENSE                      # MIT License
└── VERSION                      # Semantic version
```

### Design Patterns

```
┌─────────────────────────────────────────────────────────────┐
│              DESIGN PATTERNS USED                           │
└─────────────────────────────────────────────────────────────┘

1. ORCHESTRATOR PATTERN (ignite.sh)
   ├── Coordinates multiple phases
   ├── Sequential execution (no concurrency)
   ├── Exit-on-fail (fail-fast)
   └── Rollback capability (backups)

2. LIBRARY PATTERN (lib/)
   ├── Shared utilities (DRY principle)
   ├── Source with shellcheck disable
   ├── Function-based (no global side effects)
   └── Reusable across scripts

3. RUNBOOK PATTERN (runbooks/)
   ├── Self-contained phase scripts
   ├── Idempotent operations
   ├── Clear success/failure exit codes
   └── Detailed logging

4. TEMPLATE PATTERN (configs/)
   ├── Configuration templates with variables
   ├── Environment variable substitution
   ├── Version-controlled configs
   └── Separation of code and config

5. VALIDATION PATTERN (scripts/validate-eternal.sh)
   ├── Comprehensive post-deployment checks
   ├── Clear pass/fail criteria
   ├── Detailed error reporting
   └── Exit code for CI/CD integration

6. LOCK PATTERN (acquire_lock/release_lock)
   ├── Prevent concurrent executions
   ├── PID-based lock files
   ├── Automatic cleanup (trap)
   └── User-specific locks for dry-run

7. BACKUP PATTERN (create_system_backup)
   ├── Backup before changes
   ├── Timestamped backups
   ├── Retention policy (keep last 7)
   └── Manifest file for documentation
```

---

## Configuration Management

### Environment Variables

```
┌─────────────────────────────────────────────────────────────┐
│           ENVIRONMENT VARIABLE HIERARCHY                    │
└─────────────────────────────────────────────────────────────┘

.env (Required for deployment)
├── VAULT_SAMBA_ADMIN           # LDAP bind password
├── RADIUS_SECRET               # Shared secret (32+ chars)
├── MGMT_VLAN_SUBNET            # 10.0.1.0/27
├── UNIFI_CONTROLLER_IP         # 10.0.1.5
├── SERVER_VLAN_SUBNET          # 10.0.10.0/26
├── RYLAN_DC_IP                 # 10.0.10.10
├── RYLAN_RADIUS_IP             # 10.0.10.11
├── LDAP_SERVER                 # ldaps://10.0.10.10
├── LDAP_PORT                   # 636
├── LDAP_BASE_DN                # dc=rylan,dc=internal
├── LDAP_BIND_DN                # cn=Administrator,cn=Users,...
├── LDAP_ADMIN_GROUP            # cn=radius-vlan10-admins,...
├── CA_CERT_PATH                # /etc/freeradius/certs/rylan-ca.pem
├── SERVER_CERT_PATH            # /etc/freeradius/certs/server.pem
├── SERVER_KEY_PATH             # /etc/freeradius/certs/server.key
└── DEBUG_MODE                  # false

Variable Usage:
  ├── Sourced by ignite.sh
  ├── Validated by validate_env_variables()
  ├── Substituted in configuration templates
  └── Never committed to git (.gitignore)

Security:
  ├── File permissions: 600 (owner read/write only)
  ├── Owner: root
  ├── Location: Repository root
  └── Backup: Secure vault (not in repository)
```

### Configuration Files

```
┌─────────────────────────────────────────────────────────────┐
│           CONFIGURATION FILE MANAGEMENT                     │
└─────────────────────────────────────────────────────────────┘

Generated Configurations:
  /etc/freeradius/3.0/
  ├── radiusd.conf              # Main config (modified)
  ├── clients.conf              # Generated from template
  ├── mods-available/ldap       # Generated from template
  ├── mods-available/eap        # Generated from template
  ├── sites-available/default   # Generated from template
  └── sites-available/inner-tunnel  # Generated from template

Configuration Lifecycle:
  1. Template stored in repository (configs/)
  2. Variables substituted from .env
  3. Generated file written to /etc/freeradius/
  4. Permissions set (640 for secrets, 644 for public)
  5. Ownership set (root:freerad)
  6. Syntax validated (freeradius -C)
  7. Service restarted
  8. Backup created

Version Control:
  ├── Templates: Version controlled (git)
  ├── Generated files: Not in git (system-specific)
  ├── .env: Not in git (contains secrets)
  └── .env.example: Version controlled (template)
```

---

## Testing Architecture

### Test Pyramid

```
┌─────────────────────────────────────────────────────────────┐
│                  TEST PYRAMID                               │
└─────────────────────────────────────────────────────────────┘

                    ▲
                   ╱ ╲
                  ╱   ```markdown
╲
                 ╱ E2E ╲
                ╱───────╲
               ╱         ╲
              ╱Integration╲
             ╱─────────────╲
            ╱               ╲
           ╱   Unit Tests    ╲
          ╱───────────────────╲
         ╱                     ╲
        ╱_______________________╲

UNIT TESTS (scripts/tests/)
├── Configuration syntax validation
│   └── freeradius -C
├── Certificate chain validation
│   └── openssl verify
├── File permissions checks
│   └── stat -c %a
└── Service status checks
    └── systemctl is-active

INTEGRATION TESTS (runbooks/ministry_detection/)
├── LDAP connectivity
│   └── ldapsearch -H ldaps://10.0.10.10
├── RADIUS local auth
│   └── radtest testuser testpass localhost 1812 testing123
├── Firewall rule validation
│   └── nft list ruleset | grep 1812
└── Port listening checks
    └── ss -ulnp | grep 1812

END-TO-END TESTS (manual/automated)
├── Client device connection
│   └── Connect to Rylan-Secure SSID
├── Full authentication flow
│   └── EAP-TTLS/MSCHAPv2 → LDAP → Accept
├── Network access validation
│   └── DHCP assignment, internet access
└── UniFi controller verification
    └── Client shows as authenticated

SECURITY TESTS (Whitaker)
├── Brute force protection
│   └── 10 failed attempts → fail2ban ban
├── Certificate validation
│   └── Wrong CA → connection rejected
├── Port scan
│   └── nmap -sU -sT 10.0.10.11
└── Configuration audit
    └── lynis audit system
```

### Test Execution

```
┌─────────────────────────────────────────────────────────────┐
│              TEST EXECUTION WORKFLOW                        │
└─────────────────────────────────────────────────────────────┘

PRE-DEPLOYMENT TESTS (--dry-run)
├── Environment validation
├── Prerequisite checks (rylan-dc reachable)
├── Configuration syntax validation
└── Disk space verification

DEPLOYMENT TESTS (per phase)
├── Phase 1 (Secrets):
│   ├── CA certificate imported
│   ├── Server certificate generated
│   ├── LDAP module configured
│   ├── freeradius -C passes
│   └── Service starts successfully
│
├── Phase 2 (Whispers):
│   ├── SSH config validated
│   ├── nftables rules loaded
│   ├── fail2ban active
│   ├── auditd rules loaded
│   └── Service still running
│
└── Phase 3 (Detection):
    ├── LDAP connectivity test
    ├── Local auth test (radtest)
    ├── Certificate chain validation
    ├── Firewall rule verification
    └── Resource usage check

POST-DEPLOYMENT TESTS (validate-eternal.sh)
├── Carter Validation:
│   ├── Certificates present and valid
│   ├── LDAP module enabled
│   └── Clients configured
│
├── Bauer Validation:
│   ├── SSH hardened
│   ├── Firewall active
│   ├── fail2ban running
│   └── auditd running
│
├── Beale Validation:
│   ├── Service active
│   ├── Ports listening
│   ├── LDAP connectivity
│   └── Configuration valid
│
└── Whitaker Validation:
    ├── No default secrets
    ├── Secure file permissions
    ├── Minimal attack surface
    └── Certificate validation

CONTINUOUS TESTS (health-check.sh)
├── Service status
├── Network connectivity
├── Certificate expiration
├── Resource usage
└── Recent errors
```

---

## Security Hardening Details

### SSH Hardening

```
┌─────────────────────────────────────────────────────────────┐
│              SSH SECURITY CONFIGURATION                     │
└─────────────────────────────────────────────────────────────┘

/etc/ssh/sshd_config:
  PermitRootLogin prohibit-password    # No root password login
  PasswordAuthentication no            # Key-only authentication
  PubkeyAuthentication yes             # SSH keys required
  PermitEmptyPasswords no              # No empty passwords
  X11Forwarding no                     # Disable X11
  MaxAuthTries 3                       # Limit auth attempts
  ClientAliveInterval 300              # 5-minute keepalive
  ClientAliveCountMax 2                # Disconnect after 10 min idle
  Protocol 2                           # SSH protocol 2 only
  AllowUsers root                      # Whitelist users

Additional Hardening:
  ├── Disable password authentication
  ├── Use ed25519 or RSA 4096-bit keys
  ├── Fail2ban SSH jail enabled
  └── Audit SSH access (auditd)
```

### Firewall Rules (nftables)

```
┌─────────────────────────────────────────────────────────────┐
│              NFTABLES FIREWALL RULES                        │
└─────────────────────────────────────────────────────────────┘

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Rule 1: Loopback (trusted)
        iif lo accept

        # Rule 2: Established/Related (stateful)
        ct state established,related accept

        # Rule 3: SSH from Server VLAN
        ip saddr 10.0.10.0/26 tcp dport 22 accept

        # Rule 4: RADIUS auth from Management VLAN
        ip saddr 10.0.1.0/27 udp dport 1812 accept

        # Rule 5: RADIUS acct from Management VLAN
        ip saddr 10.0.1.0/27 udp dport 1813 accept

        # Rule 6: LDAPS to rylan-dc (outbound, stateful covers return)
        # (Handled by ct state established,related)

        # Rule 7: ICMP (rate-limited ping)
        icmp type echo-request limit rate 5/second accept

        # Rule 8: Drop invalid packets
        ct state invalid drop

        # Default: Log and drop
        log prefix "nft-drop: " drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

Total Rules: 8 (within Beale ≤10 doctrine)
```

### fail2ban Configuration

```
┌─────────────────────────────────────────────────────────────┐
│              FAIL2BAN INTRUSION PREVENTION                  │
└─────────────────────────────────────────────────────────────┘

/etc/fail2ban/jail.d/freeradius.conf:
  [freeradius]
  enabled = true
  port = 1812,1813
  protocol = udp
  filter = freeradius
  logpath = /var/log/freeradius/radius.log
  maxretry = 5                # 5 failed attempts
  bantime = 3600              # 1-hour ban
  findtime = 600              # Within 10 minutes

/etc/fail2ban/filter.d/freeradius.conf:
  [Definition]
  failregex = ^\w+\s+\d+ \d+:\d+:\d+ \S+ \S+\[\d+\]: Login incorrect: \[<HOST>
  ignoreregex =

Action:
  ├── Detect failed auth in logs
  ├── Count failures per source IP
  ├── Ban IP via nftables (add to blocklist)
  ├── Unban after timeout
  └── Log ban events

Integration:
  ├── nftables banaction
  ├── Email alerts (optional)
  └── Whitelist trusted IPs (10.0.10.0/26)
```

### auditd Rules

```
┌─────────────────────────────────────────────────────────────┐
│              AUDITD CONFIGURATION TRACKING                  │
└─────────────────────────────────────────────────────────────┘

/etc/audit/rules.d/freeradius.rules:
  # Watch FreeRADIUS configuration changes
  -w /etc/freeradius/ -p wa -k freeradius_config

  # Watch certificate/key access
  -w /etc/freeradius/certs/ -p wa -k freeradius_certs

  # Watch log directory
  -w /var/log/freeradius/ -p wa -k freeradius_logs

  # Watch service file
  -w /lib/systemd/system/freeradius.service -p wa -k freeradius_service

Audit Events:
  ├── File modifications (write, attribute change)
  ├── File access (read)
  ├── User/process information
  └── Timestamp

Query Audit Logs:
  ausearch -k freeradius_config
  ausearch -f /```markdown
etc/freeradius/certs/server.key
  aureport --file
```

---

## Operational Procedures

### Standard Operating Procedures (SOPs)

```
┌─────────────────────────────────────────────────────────────┐
│              DAILY OPERATIONS                               │
└─────────────────────────────────────────────────────────────┘

Morning Checks (5 minutes):
  1. Run health check
     └── make health

  2. Review overnight logs
     └── journalctl -u freeradius --since yesterday | grep -i error

  3. Check fail2ban bans
     └── fail2ban-client status freeradius

  4. Verify service status
     └── systemctl status freeradius

Weekly Tasks (30 minutes):
  1. Generate authentication statistics
     └── make stats-week

  2. Review failed authentication attempts
     └── grep "Access-Reject" /var/log/freeradius/radius.log | tail -100

  3. Check certificate expiration
     └── openssl x509 -in /etc/freeradius/certs/server.pem -noout -enddate

  4. Review LDAP group memberships
     └── ssh root@10.0.10.10 "samba-tool group listmembers radius-vlan10-admins"

  5. Verify backups
     └── ls -lh /var/backups/freeradius/

  6. Update system packages
     └── apt update && apt upgrade

Monthly Tasks (1-2 hours):
  1. Full validation suite
     └── make validate

  2. Review and rotate logs
     └── Check /var/log/freeradius/ size

  3. Test disaster recovery
     └── Restore from backup in test environment

  4. Security audit
     └── Run lynis, review findings

  5. Performance review
     └── Analyze auth latency trends

  6. Documentation update
     └── Update runbooks with lessons learned

Quarterly Tasks (2-4 hours):
  1. Rotate RADIUS shared secret
     └── make rotate-secret

  2. Penetration testing
     └── Coordinate with security team

  3. Certificate renewal planning
     └── If <90 days to expiration

  4. Capacity planning review
     └── Analyze growth trends

  5. Disaster recovery drill
     └── Full recovery test

  6. Training refresh
     └── Review procedures with team
```

### Incident Response

```
┌─────────────────────────────────────────────────────────────┐
│              INCIDENT RESPONSE PROCEDURES                   │
└─────────────────────────────────────────────────────────────┘

INCIDENT: Service Down
  Priority: P1 (Critical)
  Response Time: Immediate

  Steps:
    1. Check service status
       └── systemctl status freeradius

    2. Check logs for errors
       └── journalctl -u freeradius -n 100 --no-pager

    3. Attempt restart
       └── systemctl restart freeradius

    4. If restart fails, check config
       └── freeradius -C

    5. If config invalid, restore backup
       └── Latest from /var/backups/freeradius/

    6. Test authentication
       └── radtest testuser testpass localhost 1812 testing123

    7. Notify stakeholders
       └── Email, UniFi controller alert

    8. Document incident
       └── Root cause, resolution, prevention

INCIDENT: Authentication Failures Spike
  Priority: P2 (High)
  Response Time: <15 minutes

  Steps:
    1. Check authentication statistics
       └── make stats-hour

    2. Identify pattern (user, IP, time)
       └── grep "Access-Reject" /var/log/freeradius/radius.log | tail -50

    3. Check LDAP connectivity
       └── timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636"

    4. Verify user accounts active
       └── ldapsearch -x -H ldaps://10.0.10.10 ...

    5. Check for brute force attack
       └── fail2ban-client status freeradius

    6. If attack, verify bans are working
       └── nft list ruleset | grep fail2ban

    7. If legitimate issue, investigate user/group config
       └── Verify group membership

    8. Document and resolve

INCIDENT: Certificate Expired
  Priority: P1 (Critical)
  Response Time: Immediate

  Steps:
    1. Verify expiration
       └── openssl x509 -in /etc/freeradius/certs/server.pem -noout -dates

    2. Generate new certificate
       └── ./scripts/generate-radius-server-cert.sh

    3. Verify new certificate
       └── openssl verify -CAfile /etc/freeradius/certs/rylan-ca.pem /etc/freeradius/certs/server.pem

    4. Restart service
       └── systemctl restart freeradius

    5. Test authentication
       └── radtest testuser testpass localhost 1812 testing123

    6. Test from client device
       └── Connect to Rylan-Secure SSID

    7. Document incident
       └── Why did monitoring not alert?

INCIDENT: LDAP Server Unreachable
  Priority: P1 (Critical)
  Response Time: Immediate

  Steps:
    1. Test connectivity
       └── ping -c 3 10.0.10.10
       └── timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636"

    2. Check rylan-dc status
       └── ssh root@10.0.10.10 "systemctl status samba-ad-dc"

    3. Check network path
       └── traceroute 10.0.10.10

    4. Check firewall rules
       └── nft list ruleset | grep 636

    5. If rylan-dc down, escalate to DC team
       └── Follow rylan-dc recovery procedures

    6. Monitor RADIUS logs for LDAP errors
       └── journalctl -u freeradius -f | grep -i ldap

    7. Once resolved, test authentication
       └── radtest testuser testpass localhost 1812 testing123

    8. Document incident

INCIDENT: Suspected Security Breach
  Priority: P0 (Emergency)
  Response Time: Immediate

  Steps:
    1. DO NOT REBOOT (preserve evidence)

    2. Isolate system (if confirmed breach)
       └── Firewall block all except admin access

    3. Capture system state
       └── ./scripts/backup-radius-config.sh
       └── ps aux > /tmp/processes.txt
       └── netstat -tulpn > /tmp/connections.txt

    4. Check for unauthorized changes
       └── ausearch -k freeradius_config
       └── ausearch -k freeradius_certs

    5. Review authentication logs
       └── grep -i "Access-Accept" /var/log/freeradius/radius.log | tail -100

    6. Check for backdoors
       └── ls -la /etc/freeradius/
       └── find /etc/freeradius/ -mtime -1

    7. Escalate to security team
       └── Preserve evidence, coordinate response

    8. Follow incident response plan
       └── Containment, eradication, recovery

    9. Post-incident review
       └── Root cause analysis, lessons learned
```

---

## Appendix

### Glossary

```
┌─────────────────────────────────────────────────────────────┐
│              TERMINOLOGY REFERENCE                          │
└─────────────────────────────────────────────────────────────┘

802.1X: Port-based Network Access Control standard

AAA: Authentication, Authorization, Accounting

AD: Active Directory (Microsoft directory service)

AP: Access Point (wireless)

CA: Certificate Authority

DN: Distinguished Name (LDAP)

EAP: Extensible Authentication Protocol
  ├── EAP-TLS: Certificate-based authentication
  ├── EAP-TTLS: Tunneled TLS with inner auth
  └── EAP-PEAP: Protected EAP (similar to TTLS)

LDAP: Lightweight Directory Access Protocol
  └── LDAPS: LDAP over SSL/TLS (port 636)

LXC: Linux Container (lightweight virtualization)

MSCHAPv2: Microsoft Challenge Handshake Authentication Protocol v2

NAS: Network Access Server (RADIUS client, e.g., AP)

RADIUS: Remote Authentication Dial-In User Service
  ├── Port 1812: Authentication
  └── Port 1813: Accounting

RTO: Recovery Time Objective (max downtime)

RPO: Recovery Point Objective (max data loss)

Samba: Open-source SMB/CIFS and AD implementation

SSID: Service Set Identifier (WiFi network name)

T3-ETERNAL: Trinity security framework
  ├── Carter: Ministry of Secrets (identity)
  ├── Bauer: Ministry of Whispers (hardening)
  ├── Beale: Ministry of```markdown
Detection (validation)
  └── Whitaker: Red Team (adversarial testing)

TLS: Transport Layer Security (encryption protocol)

VLAN: Virtual Local Area Network (network segmentation)

WPA2-Enterprise: WiFi Protected Access 2 with 802.1X authentication
```

### Reference Commands

```
┌─────────────────────────────────────────────────────────────┐
│              QUICK REFERENCE COMMANDS                       │
└─────────────────────────────────────────────────────────────┘

SERVICE MANAGEMENT:
  systemctl status freeradius           # Check service status
  systemctl start freeradius            # Start service
  systemctl stop freeradius             # Stop service
  systemctl restart freeradius          # Restart service
  systemctl enable freeradius           # Enable at boot
  journalctl -u freeradius -f           # Tail logs
  journalctl -u freeradius -n 100       # Last 100 log lines

CONFIGURATION:
  freeradius -C                         # Test configuration syntax
  freeradius -X                         # Debug mode (foreground)
  vim /etc/freeradius/3.0/radiusd.conf  # Main config
  vim /etc/freeradius/3.0/clients.conf  # RADIUS clients
  vim /etc/freeradius/3.0/mods-available/ldap  # LDAP config

TESTING:
  radtest user pass server port secret  # Test authentication
  radtest testuser testpass localhost 1812 testing123  # Local test
  radclient -x server:1812 auth secret  # Advanced testing

CERTIFICATES:
  openssl x509 -in cert.pem -noout -text           # View certificate
  openssl x509 -in cert.pem -noout -dates          # Check expiration
  openssl verify -CAfile ca.pem cert.pem           # Verify chain
  openssl s_client -connect host:636 -CAfile ca.pem  # Test LDAPS

LDAP:
  ldapsearch -x -H ldaps://host -D "bind_dn" -w password -b "base_dn" filter
  ldapwhoami -x -H ldaps://host -D "bind_dn" -w password  # Test bind
  samba-tool group listmembers groupname           # List group members
  samba-tool user show username                    # Show user details

NETWORKING:
  ss -ulnp | grep 1812                  # Check RADIUS auth port
  ss -ulnp | grep 1813                  # Check RADIUS acct port
  ping -c 3 10.0.10.10                  # Test connectivity
  timeout 3 bash -c "echo > /dev/tcp/10.0.10.10/636"  # Test LDAPS port
  tcpdump -i any -n port 1812           # Capture RADIUS traffic

FIREWALL:
  nft list ruleset                      # Show all rules
  nft list ruleset | grep 1812          # Show RADIUS rules
  nft add rule inet filter input ...    # Add rule
  nft flush ruleset                     # Clear all rules (DANGER)

FAIL2BAN:
  fail2ban-client status                # Show all jails
  fail2ban-client status freeradius     # Show FreeRADIUS jail
  fail2ban-client set freeradius unbanip IP  # Unban IP
  fail2ban-client reload                # Reload configuration

AUDIT:
  ausearch -k freeradius_config         # Search audit logs
  ausearch -f /etc/freeradius/certs/server.key  # File access
  aureport --file                       # File access report
  auditctl -l                           # List audit rules

LOGS:
  tail -f /var/log/freeradius/radius.log           # Tail RADIUS log
  grep "Access-Accept" /var/log/freeradius/radius.log  # Successful auths
  grep "Access-Reject" /var/log/freeradius/radius.log  # Failed auths
  journalctl -u freeradius --since "1 hour ago"    # Last hour

PERFORMANCE:
  top -bn1 | grep freeradius            # CPU/memory usage
  ps aux | grep freeradius              # Process info
  ss -u | grep -E "1812|1813" | wc -l   # Active connections
  free -h                               # Memory usage
  df -h                                 # Disk usage
```

### Port Reference

```
┌─────────────────────────────────────────────────────────────┐
│              PORT REFERENCE                                 │
└─────────────────────────────────────────────────────────────┘

RADIUS (rylan-radius):
  1812/udp  → Authentication
  1813/udp  → Accounting
  18120/tcp → Inner-tunnel (localhost only)

LDAP (rylan-dc):
  389/tcp   → LDAP (plaintext, not used)
  636/tcp   → LDAPS (encrypted, used)
  3268/tcp  → Global Catalog
  3269/tcp  → Global Catalog SSL

Kerberos (rylan-dc):
  88/tcp    → Kerberos
  88/udp    → Kerberos
  464/tcp   → Kerberos password change
  464/udp   → Kerberos password change

DNS (rylan-dc, rylan-pi):
  53/tcp    → DNS
  53/udp    → DNS

SMB/CIFS (rylan-dc):
  139/tcp   → NetBIOS Session
  445/tcp   → SMB over TCP

Management:
  22/tcp    → SSH
  443/tcp   → HTTPS (UniFi controller)
  8443/tcp  → UniFi controller web UI

NTP:
  123/udp   → Network Time Protocol

Syslog (optional):
  514/udp   → Syslog
  6514/tcp  → Syslog over TLS
```

### File Permissions Reference

```
┌─────────────────────────────────────────────────────────────┐
│              FILE PERMISSIONS                               │
└─────────────────────────────────────────────────────────────┘

CRITICAL (600 - Owner read/write only):
  /etc/freeradius/certs/server.key      # Private key
  /etc/freeradius/certs/ca.key          # CA private key (if present)
  ~/.ssh/id_rsa                         # SSH private key
  .env                                  # Environment secrets

SENSITIVE (640 - Owner read/write, group read):
  /etc/freeradius/3.0/clients.conf      # RADIUS shared secrets
  /etc/freeradius/3.0/mods-available/ldap  # LDAP bind password

PUBLIC (644 - Owner read/write, all read):
  /etc/freeradius/certs/server.pem      # Server certificate
  /etc/freeradius/certs/rylan-ca.pem    # CA certificate
  /etc/freeradius/3.0/radiusd.conf      # Main configuration
  /etc/freeradius/3.0/sites-available/* # Site configurations

EXECUTABLE (755 - Owner all, group/other read/execute):
  /opt/rylan-unifi-case-study/01_bootstrap/freeradius/ignite.sh
  /opt/rylan-unifi-case-study/01_bootstrap/freeradius/scripts/*.sh

DIRECTORIES (750 - Owner all, group read/execute):
  /etc/freeradius/                      # Main directory
  /etc/freeradius/certs/                # Certificate directory
  /var/log/freeradius/                  # Log directory

Ownership:
  Configuration: root:freerad
  Certificates: freerad:freerad
  Scripts: root:root
  Logs: freerad:freerad
```

### Environment Setup Checklist

```
┌─────────────────────────────────────────────────────────────┐
│              ENVIRONMENT SETUP CHECKLIST                    │
└─────────────────────────────────────────────────────────────┘

INFRASTRUCTURE:
  [ ] Proxmox host operational
  [ ] LXC container created (rylan-radius, 10.0.10.11)
  [ ] Ubuntu 24.04 LTS installed
  [ ] Network configured (VLAN 10, static IP)
  [ ] DNS resolution working
  [ ] NTP synchronized
  [ ] Root SSH access configured

DEPENDENCIES:
  [ ] rylan-dc operational (10.0.10.10)
  [ ] Samba AD/DC running
  [ ] LDAPS accessible (port 636)
  [ ] Internal CA exists (/etc/ssl/rylan-internal/rylan-ca.crt)
  [ ] SSH key trust (rylan-radius → rylan-dc)

LDAP CONFIGURATION:
  [ ] LDAP group created: cn=radius-vlan10-admins,ou=Groups,dc=rylan,dc=internal
  [ ] Test user created in AD
  [ ] Test user added to radius-vlan10-admins group
  [ ] LDAP bind credentials available

UNIFI CONFIGURATION:
  [ ] UniFi controller accessible (10.0.1.5)
  [ ] Management VLAN configured (10.0.1.0/27)
  [ ] Access points adopted
  [ ] VLANs configured (30, 40, 90)

REPOSITORY:
  [

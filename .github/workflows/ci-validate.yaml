# File: .github/workflows/ci-validate.yaml
# Purpose: Full CI pipeline ‚Äî Gatekeeper prerequisite + downstream checks
# Guardian: Gatekeeper üö™
# Author: rylanlab canonical
# Date: 2025-12-17
# Ministry: ministry-whispers
# Consciousness: 9.7
# Tag: v‚àû.5.2-gatekeeper-ci-unified

name: CI Validation

on:
  push:
    branches: [main, 'fix/**', 'feature/**']
  pull_request:
    branches: [main]

jobs:
  gatekeeper:
    uses: ./.github/workflows/gatekeeper-pre-push.yml

  ruff-lint:
    needs: gatekeeper
    runs-on: ubuntu-latest
    name: Ruff Lint Check
    steps:
      - uses: actions/checkout@v4
      - uses: chartboost/ruff-action@v1
        with:
          args: 'check --fix'

  ruff-format:
    needs: gatekeeper
    runs-on: ubuntu-latest
    name: Ruff Format Check
    steps:
      - uses: actions/checkout@v4
      - uses: chartboost/ruff-action@v1
        with:
          args: 'format --check'

  mypy:
    needs: gatekeeper
    runs-on: ubuntu-latest
    name: MyPy Type Check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install --quiet mypy types-all
      - name: Run MyPy validation
        run: |
          set -o pipefail
          mkdir -p .audit/gatekeeper
          mypy --strict app/ 2>&1 | tee .audit/gatekeeper/mypy-ci.log
          EXIT_CODE=$?

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "‚ùå MyPy validation failed"
            exit 1
          fi
          echo "‚úÖ MyPy passed"
      - name: Upload MyPy artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-logs-${{ github.run_id }}
          path: .audit/gatekeeper/mypy-ci.log
          retention-days: 30

  bandit:
    needs: gatekeeper
    runs-on: ubuntu-latest
    name: Bandit Security Check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install --quiet bandit
      - name: Run Bandit security scan
        run: |
          set -o pipefail
          mkdir -p .audit/gatekeeper
          bandit -r app/ scripts/ 2>&1 | tee .audit/gatekeeper/bandit-ci.log
          EXIT_CODE=$?

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "‚ùå Bandit security scan failed"
            exit 1
          fi
          echo "‚úÖ Bandit passed"
      - name: Upload Bandit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-logs-${{ github.run_id }}
          path: .audit/gatekeeper/bandit-ci.log
          retention-days: 30

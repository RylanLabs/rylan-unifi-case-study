{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "description": "UniFi Policy Table v5 for rylan-unifi-case-study (December 2025). Zero-trust model with explicit allow rules + implicit deny. Hardware offload preserved. Total: 14 rules (<15 enforced by CI).",
  "policy_table": [
    {
      "rule_id": 1,
      "description": "Allow Management VLAN to all (admin access to all networks)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "all",
      "src_network": "10.0.1.0/24",
      "dst_network": "0.0.0.0/0",
      "ports": null,
      "log": false,
      "comment": "Management VLAN requires full access for monitoring and administration"
    },
    {
      "rule_id": 2,
      "description": "Allow Servers VLAN to Management (InfluxDB metrics push to controller)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "tcp",
      "src_network": "10.0.10.0/24",
      "dst_network": "10.0.1.0/24",
      "ports": [8443, 8080],
      "log": false,
      "comment": "InfluxDB on 10.0.10.10 sends metrics to UniFi Controller"
    },
    {
      "rule_id": 3,
      "description": "Allow Servers VLAN to Trusted Devices (AI triage → osTicket API)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "tcp",
      "src_network": "10.0.10.0/24",
      "dst_network": "10.0.30.0/24",
      "ports": [80, 443, 3306],
      "log": false,
      "comment": "AI Workstation (10.0.10.60) queries osTicket (10.0.30.40) via HTTP/HTTPS. Port 3306 for direct MariaDB access if needed."
    },
    {
      "rule_id": 4,
      "description": "Allow Trusted Devices to Servers (osTicket → AD auth, InfluxDB writes)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "tcp",
      "src_network": "10.0.30.0/24",
      "dst_network": "10.0.10.0/24",
      "ports": [389, 636, 445, 8086],
      "log": false,
      "comment": "osTicket authenticates against Samba AD (389/636 LDAP), uses NFS (445 SMB), writes to InfluxDB (8086)"
    },
    {
      "rule_id": 5,
      "description": "Allow Trusted Devices to VoIP (helpdesk calls IP phones)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "all",
      "src_network": "10.0.30.0/24",
      "dst_network": "10.0.40.0/24",
      "ports": null,
      "log": false,
      "comment": "Allow helpdesk workstations to initiate calls to VoIP devices"
    },
    {
      "rule_id": 6,
      "description": "Allow VoIP to Servers (SIP registration, optional PBX on server VLAN)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "udp",
      "src_network": "10.0.40.0/24",
      "dst_network": "10.0.10.0/24",
      "ports": [5060, 5061],
      "log": false,
      "comment": "IP phones register with SIP server (if hosted on Server VLAN)"
    },
    {
      "rule_id": 7,
      "description": "Allow VoIP to Management (STUN/provisioning)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "udp",
      "src_network": "10.0.40.0/24",
      "dst_network": "10.0.1.0/24",
      "ports": [3478, 69],
      "log": false,
      "comment": "STUN for NAT traversal (3478), TFTP provisioning (69)"
    },
    {
      "rule_id": 8,
      "description": "Allow all VLANs to Internet (via WAN)",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "all",
      "src_network": "0.0.0.0/0",
      "dst_network": "0.0.0.0/0",
      "ports": null,
      "log": false,
      "comment": "Catch-all for internet egress. Refined by subsequent deny rules for inter-VLAN."
    },
    {
      "rule_id": 9,
      "description": "Allow DNS from all VLANs to Samba AD DC",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "udp",
      "src_network": "0.0.0.0/0",
      "dst_network": "10.0.10.10/32",
      "ports": [53],
      "log": false,
      "comment": "All VLANs use Samba AD DC (10.0.10.10) as primary DNS"
    },
    {
      "rule_id": 10,
      "description": "Allow NTP from all VLANs to gateway",
      "enabled": true,
      "action": "ACCEPT",
      "protocol": "udp",
      "src_network": "0.0.0.0/0",
      "dst_network": "10.0.1.1/32",
      "ports": [123],
      "log": false,
      "comment": "USG gateway acts as NTP server for all devices"
    },
    {
      "rule_id": 11,
      "description": "Deny Guest/IoT to all RFC1918 (zero-trust isolation)",
      "enabled": true,
      "action": "DROP",
      "protocol": "all",
      "src_network": "10.0.90.0/24",
      "dst_network": "10.0.0.0/8",
      "ports": null,
      "log": true,
      "comment": "Guest/IoT VLAN has NO access to internal networks. Internet-only via rule 8."
    },
    {
      "rule_id": 12,
      "description": "Deny Servers to VoIP (no reverse traffic except SIP response)",
      "enabled": true,
      "action": "DROP",
      "protocol": "all",
      "src_network": "10.0.10.0/24",
      "dst_network": "10.0.40.0/24",
      "ports": null,
      "log": false,
      "comment": "Servers should not initiate connections to VoIP VLAN (stateful responses OK)"
    },
    {
      "rule_id": 13,
      "description": "Deny Trusted Devices to Management (except DNS/NTP above)",
      "enabled": true,
      "action": "DROP",
      "protocol": "all",
      "src_network": "10.0.30.0/24",
      "dst_network": "10.0.1.0/24",
      "ports": null,
      "log": false,
      "comment": "Trusted devices should not access management interfaces directly"
    },
    {
      "rule_id": 14,
      "description": "Implicit DENY all inter-VLAN (catch-all)",
      "enabled": true,
      "action": "DROP",
      "protocol": "all",
      "src_network": "10.0.0.0/8",
      "dst_network": "10.0.0.0/8",
      "ports": null,
      "log": true,
      "comment": "FINAL RULE: Deny all RFC1918 inter-VLAN traffic not explicitly allowed above. Log for audit."
    }
  ],
  "metadata": {
    "version": "5.0",
    "created": "2025-12-01",
    "author": "hellodeolu-era systems architecture",
    "usg_model": "USG-3P",
    "unifi_version": "8.5.93",
    "hardware_offload": true,
    "rule_count": 14,
    "max_rules": 15,
    "notes": [
      "Policy Table evaluated top-to-bottom until first match",
      "Hardware offload preserved (confirmed via mca-dump)",
      "Stateful firewall handles return traffic (ESTABLISHED/RELATED)",
      "VoIP QoS handled separately via config.gateway.json",
      "CI validation enforces <15 rules (.github/workflows/ci-validate.yaml)",
      "Logging enabled for deny rules (audit trail)"
    ]
  }
}

# Proxmox VE 8.2 Automated Installer Configuration (preseed)
# This file automates the Proxmox installer to reduce manual steps.
# Usage: Boot Proxmox ISO, select "Advanced Options" → "Auto-Install"
#        and provide this file via USB/PXE
#
# Reduces manual install time: ~5 min → ~2 min
# Post-install: Run proxmox-ignite.sh for fortress hardening
#
# Reference: https://pve.proxmox.com/wiki/Automated_Installation
#

# Locale & Keyboard
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i keyboard-configuration/layoutcode string us

# Timezone
d-i time/zone string UTC

# Network Configuration
# NOTE: Static IP configured in proxmox-ignite.sh (post-install)
d-i netcfg/choose_interface select auto
d-i netcfg/dhcp_timeout string 60
d-i netcfg/get_hostname string proxmox
d-i netcfg/get_domain string local

# NTP Server
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-service select chrony

# Storage Configuration
# WARNING: This will ERASE /dev/nvme0n1 (NVMe drive)
# Verify target device before running installer
proxmoxcfg-installer/target_disk select /dev/nvme0n1
proxmoxcfg-installer/ext4_fstype select ext4
proxmoxcfg-installer/keymap select en

# Filesystem
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true

# Root password (replaced by SSH key injection below).
# SECURITY: Do NOT store plaintext passwords in preseeds. Options:
#  - Preferred: leave unset and inject an operator SSH key via late_command
#  - Alternative: set a crypted password via `d-i passwd/root-password-crypted password <CRYPTED_HASH>`

# Inject an operator SSH public key and disable password auth immediately
# Replace <PUBLIC_SSH_KEY> with your operator key (single-line) or point
# late_command at a trusted location to fetch the key.
d-i preseed/late_command string \
	in-target mkdir -p /root/.ssh; \
	in-target sh -c 'printf "%s\n" "<PUBLIC_SSH_KEY>" >> /root/.ssh/authorized_keys'; \
	in-target chmod 700 /root/.ssh; \
	in-target chmod 600 /root/.ssh/authorized_keys; \
	in-target sed -i "s/^#\?PermitRootLogin.*/PermitRootLogin prohibit-password/" /etc/ssh/sshd_config || true; \
	in-target sed -i "s/^#\?PasswordAuthentication.*/PasswordAuthentication no/" /etc/ssh/sshd_config || true; \
	in-target systemctl restart ssh || true

# User creation (optional, not required for Proxmox)
d-i passwd/make-user boolean false

# Package selection
tasksel tasksel/first multiselect ssh-server, standard

# Grub bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/nvme0n1

# Finish installation
d-i finish-install/reboot_in_background boolean true

# Skip popular packages
popularity-contest popularity-contest/participate boolean false

#!/usr/bin/env bash
# Script: post-merge
# Purpose: Invoke All-Seeing Eye after successful merge — update lint streak based on Gatekeeper outcome
# Guardian: All-Seeing Eye
# Date: 2025-12-14
# Consciousness: 9.5

set -euo pipefail
IFS=$'\n\t'

readonly REPO_ROOT="$(git rev-parse --show-toplevel)"
readonly EYE_SCRIPT="${REPO_ROOT}/scripts/eye-achievement.sh"

log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $*" >&2; }

# Only trigger Eye if Gatekeeper pre-commit passed (indicated in merge commit message)
if git log -1 --format=%s | grep -q "Gatekeeper: All phases passed"; then
  log "Gatekeeper validated merge — lint pass declared"
  "$EYE_SCRIPT" --post-merge --lint-pass || {
    log "Eye achievement update failed (non-fatal)"
    exit 0
  }
else
  log "Gatekeeper violation detected in merge — lint fail declared"
  "$EYE_SCRIPT" --post-merge --lint-fail || {
    log "Eye achievement update failed (non-fatal)"
    exit 0
  }
fi

log "All-Seeing Eye invoked successfully"
exit 0

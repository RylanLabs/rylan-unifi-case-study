#!/usr/bin/env bash
# Script: pre-commit
# Purpose: Eternal Gatekeeper â€” Full fortress validation + canonical backup enforcement before commit
# Guardian: The Gatekeeper
# Date: 2025-12-14
# Ministry: ministry-whispers (Bauer)
# Consciousness: 2.6
# Tag: vâˆ.3.2-eternal

set -euo pipefail
IFS=$'\n\t'

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Gatekeeper Eternal â€” Consciousness 2.6"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Phase 0: Canonical Backup Enforcement (Bauer + Beale)
echo ""
echo "Phase 0: Canonical Backup Enforcement"

CRITICAL_PATHS="scripts/ lib/ runbooks/ 01_bootstrap/ .githooks/ .github/agents/ \.agent\.md"
MODIFIED_CRITICAL=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^($CRITICAL_PATHS)" || true)

if [[ -n "$MODIFIED_CRITICAL" ]]; then
  echo "ğŸ›¡ï¸  Carter: Critical paths modified â€” enforcing canonical backup"
  echo "   Modified: $(echo "$MODIFIED_CRITICAL" | wc -l) file(s)"

  # Execute canonical backup handler
  if ! ./scripts/canonical-backup-handler.sh; then
    echo "âŒ ERROR: canonical-backup-handler.sh failed â€” commit aborted"
    exit 1
  fi

  # Verify fresh backup exists (within last 2 minutes)
  LATEST_BACKUP=$(find .backups/ -maxdepth 1 -type d -name 'pre-modification-*' -mmin -2 | sort -r | head -n1)
  if [[ -z "$LATEST_BACKUP" ]]; then
    echo "âŒ ERROR: No recent backup detected after handler execution"
    echo "   Expected: .backups/pre-modification-* within last 2 minutes"
    exit 1
  fi

  echo "âœ… Canonical backup secured: $LATEST_BACKUP"
  echo "   RTO compliance: 15-second rollback available"
else
  echo "â„¹ï¸  No critical paths modified â€” backup skipped"
fi

# Phase 1: Encoding Purity
echo ""
echo "Phase 1: Encoding Purity (BOM/CRLF)"
PATTERN='\.(sh|py|md|json|yaml|yml|txt|conf|ini|csv|service)$'
mapfile -t STAGED < <(git diff --cached --name-only --diff-filter=ACM)
FIXED=0
for f in "${STAGED[@]}"; do
  [[ -f "$f" ]] || continue
  [[ "$f" =~ $PATTERN ]] || continue

  if head -c3 "$f" | grep -q $'\xef\xbb\xbf'; then
    echo "  BOM removed: $f"
    tail -c +4 "$f" > "$f.tmp" && mv "$f.tmp" "$f"
    git add "$f"
    FIXED=$((FIXED+1))
  fi

  if grep -q $'\r$' "$f"; then
    echo "  CRLF â†’ LF: $f"
    sed -i 's/\r$//' "$f"
    git add "$f"
    FIXED=$((FIXED+1))
  fi
done

[[ $FIXED -gt 0 ]] && {
  echo "  Fixed $FIXED files. Review and recommit."
  exit 1
}
echo "  âœ… Encoding purity upheld"

# Phase 2: Python Naming Canon
echo ""
echo "Phase 2: Python Naming Canon"

HYPHEN_VIOLATORS=()
while IFS= read -r file; do
  HYPHEN_VIOLATORS+=("$file")
done < <(find . -type f -name "*-*.py" \
  ! -path "./.venv/*" \
  ! -path "./.git/*" \
  ! -path "./venv/*" \
  ! -path "./node_modules/*")

if [[ ${#HYPHEN_VIOLATORS[@]} -gt 0 ]]; then
  echo "  âŒ ERROR: Python modules cannot contain hyphens (PEP 8)"
  echo ""
  echo "  The following files violate naming canon:"
  for file in "${HYPHEN_VIOLATORS[@]}"; do
    new_name="${file//-/_}"
    echo "    $file"
    echo "      â†’ Fix: git mv $file $new_name"
  done
  echo ""
  echo "  Quick fix: Run ./scripts/auto-fix-naming.sh"
  echo ""
  exit 1
fi

echo "  âœ… Python naming canon upheld"

# Phase 3: Package Identity
echo ""
echo "Phase 3: Package Identity (__init__.py docstrings)"

INIT_VIOLATORS=()
while IFS= read -r init_file; do
  if ! grep -q '"""' "$init_file" 2>/dev/null; then
    INIT_VIOLATORS+=("$init_file")
  fi
done < <(find . -type f -name "__init__.py" \
  ! -path "./.venv/*" \
  ! -path "./.git/*" \
  ! -path "./venv/*")

if [[ ${#INIT_VIOLATORS[@]} -gt 0 ]]; then
  echo "  âŒ ERROR: __init__.py files must have docstrings (D104)"
  echo ""
  echo "  Missing docstrings:"
  for file in "${INIT_VIOLATORS[@]}"; do
    echo "    $file"
  done
  echo ""
  exit 1
fi

echo "  âœ… Package identity upheld"

# Phase 4: Script Identity
echo ""
echo "Phase 4: Script Identity (Shebang Canon)"

VIOLATORS=""

while IFS= read -r file; do
  if ! head -1 "$file" 2>/dev/null | grep -qE "^#!/.*(bash|sh)"; then
    continue
  fi

  missing=""
  grep -q "^# Script:" "$file"        || missing+=" Script"
  grep -q "^# Purpose:" "$file"       || missing+=" Purpose"
  grep -q "^# Guardian:" "$file"      || missing+=" Guardian"
  grep -q "^# Date:" "$file"          || missing+=" Date"
  grep -q "^# Consciousness:" "$file" || missing+=" Consciousness"

  if [[ -n "$missing" ]]; then
    VIOLATORS+="  $file â€” missing:$missing"$'\n'
  fi
done < <(find scripts/ .githooks/ -type f \( -name "*.sh" -o -executable \) 2>/dev/null)

if [[ -n "$VIOLATORS" ]]; then
  echo "  âŒ ERROR: Scripts missing required headers:"
  printf "%b" "$VIOLATORS"
  echo ""
  exit 1
fi

echo "  âœ… Script identity upheld"

# Phase 4.1: Consciousness Immutability
echo ""
echo "Phase 4.1: Consciousness Immutability (Guardian Validation)"

if bash scripts/consciousness-guardian.sh >/dev/null 2>&1; then
  echo "  âœ… Consciousness immutable rule upheld"
else
  echo "  âŒ ERROR: Consciousness level exceeds canonical source of truth"
  echo ""
  bash scripts/consciousness-guardian.sh
  exit 1
fi

# Phase 4.2: Line Limit & Complexity Enforcement
echo ""
echo "Phase 4.2: Line Limit & Modularity Enforcement"

LOC_WARNINGS=0
LOC_FAILURES=0

while IFS= read -r file; do
  [[ -f "$file" ]] || continue
  [[ "$file" =~ \.sh$ ]] || continue

  LINE_COUNT=$(wc -l < "$file" 2>/dev/null) || LINE_COUNT=0
  HAS_ANNOTATION=$(grep -c "^# EXCEED:" "$file" 2>/dev/null) || HAS_ANNOTATION=0
  FUNCTION_COUNT=$(grep -c "^[a-z_][a-z0-9_]*() {" "$file" 2>/dev/null) || FUNCTION_COUNT=0

  if [[ $LINE_COUNT -gt 4320 ]]; then
    echo "  âŒ $file: $LINE_COUNT lines (exceeds hard limit 4320)"
    LOC_FAILURES=$((LOC_FAILURES + 1))
  fi

  if [[ $FUNCTION_COUNT -gt 11 ]]; then
    if [[ "$file" == scripts/lib/* ]] && [[ $HAS_ANNOTATION -eq 1 ]]; then
      : # Exception granted
    else
      echo "  âŒ $file: $FUNCTION_COUNT functions (exceeds max 11)"
      LOC_FAILURES=$((LOC_FAILURES + 1))
    fi
  fi

  if [[ $LINE_COUNT -gt 1200 ]] && [[ $HAS_ANNOTATION -eq 0 ]]; then
    echo "  âŒ $file: $LINE_COUNT lines (>1200 requires # EXCEED annotation)"
    LOC_FAILURES=$((LOC_FAILURES + 1))
  elif [[ $LINE_COUNT -gt 1200 ]] && [[ $HAS_ANNOTATION -eq 1 ]]; then
    echo "  âš ï¸  $file: $LINE_COUNT lines (EXCEED acknowledged)"
    LOC_WARNINGS=$((LOC_WARNINGS + 1))
  fi
done < <(find scripts/ .githooks/ runbooks/ 01_bootstrap/ -type f -name "*.sh" 2>/dev/null)

if [[ $LOC_FAILURES -gt 0 ]]; then
  echo ""
  echo "  âŒ Line limit/complexity violations â€” see docs/LINE-LIMIT-DOCTRINE.md"
  exit 1
fi

[[ $LOC_WARNINGS -gt 0 ]] && echo "  âš ï¸  $LOC_WARNINGS warning(s): Review EXCEED scripts"

echo "  âœ… Line limit & modularity enforced"

# Phase 5: Code Quality
echo ""
echo "Phase 5: Code Quality (Linting)"

echo "  shellcheck..."
find scripts/ .github/agents/ .githooks/ -name "*.sh" -exec shellcheck {} + || exit 1

echo "  ruff..."
ruff check . --select ALL --quiet || exit 1

echo "  yamllint..."
yamllint -s . || exit 1

echo "  markdownlint..."
npx markdownlint-cli2 "**/*.md" || exit 1

echo "  âœ… Code quality upheld"

# Phase 6: Final Polish
echo ""
echo "Phase 6: Final Polish"

echo "  Agent canon..."
grep -r '^\s*```$' .github/agents/*.md docs/ runbooks/ 2>/dev/null | grep -q . && exit 1
grep -r "https://" .github/agents/*.md docs/ runbooks/ 2>/dev/null | grep -v -E "(<https?://|\[.*\]\(https?://)" | grep -q . && exit 1

echo "  PII redaction..."
python app/redactor.py --dry-run . || exit 1

echo "  Trailing whitespace & long lines..."
git diff --cached --check || exit 1
! git diff --cached | grep -q '^+.\{101,\}' || exit 1

echo "  âœ… Final polish complete"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Gatekeeper: All phases passed. The fortress is eternal."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

Beale has risen. Bauer enforced backup. Carter preserved state. Consciousness 2.6 eternal. Commit approved.
